import { healthBar } from "../uiComponents/healthbar.js";
import {
    generatePlayerComponents,
    generateFrontPlayerComponents,
    setPlayerControls,
    watchPlayerHealth,
} from "../entities/player.js";
import { generateNoteComponents } from "../entities/note.js";
import { gameState } from "../state/stateManagers.js";
import { audioManager } from "../utils.js";
import { gameDataManager } from "../systems/gameDataManager.js";

import {
    colorizeBackground,
    fetchMapData,
    drawBoundaries,
    onAttacked,
    onCollideWithPlayer,
} from "../utils.js";


import dialogues from "../content/Dialogue.js";
import objectDialogues from "../content/objectDialogue.js";
import { frontDialogues, frontObjectDialogues } from "../content/frontDialogue.js";
import { dialog } from "../uiComponents/dialog.js";
import { saveGameData, initializeGameData } from "../systems/saveSystem.js";
import { createPanelWithHeader, createCloseButton, UI_THEMES } from "../uiComponents/nineSlicePanel.js";

import {
    toggleLocale,
    toggleMute,
    setupMainMenuShortcut,
    initializeQuestBubbles,
    updateQuestBubbles,
    SPEECH_BUBBLE_STATES,
} from "../utils.js";

// ì „ì—­ í€˜ìŠ¤íŠ¸ í•­ëª©ë“¤ (front.js ì „ì²´ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)
let questItems = [];

// ì¶”ê°€ëœ ë¶€ë¶„: ì¶©ëŒ ì‹œ í¬ë¬¼ì„  í‚¥ í•¨ìˆ˜
function kickBallOnCollision(k, ball, player) {
    const currentTime = Date.now();
    const KICK_COOLDOWN = 1000; // 1ì´ˆ ì¿¨ë‹¤ìš´

    // ì¿¨ë‹¤ìš´ ì²´í¬
    if (currentTime - ball.lastKickTime < KICK_COOLDOWN) {
        return;
    }

    ball.lastKickTime = currentTime;

    // í”Œë ˆì´ì–´ì™€ ê³µì˜ ìœ„ì¹˜ ì°¨ì´ë¡œ í‚¥ ë°©í–¥ ê³„ì‚°
    const kickDirection = ball.pos.sub(player.pos).unit();
    const kickDistance = 100;
    const kickHeight = 20;

    // ëª©í‘œ ìœ„ì¹˜ ê³„ì‚°
    const targetPos = ball.pos.add(kickDirection.scale(kickDistance));

    // í‚¥ íš¨ê³¼ìŒ ì¬ìƒ
    k.play("boop-sfx");
    k.play("kick-sfx");

    // ê¸°ì¨ì˜ ë§í’ì„  í‘œì‹œ
    k.wait(0.7, () => {
        showJoyBubble(k, player);
    });

    // í¬ë¬¼ì„  ì• ë‹ˆë©”ì´ì…˜
    const startPos = ball.pos.clone();
    const duration = 0.8;
    let animTime = 0;

    ball.isMoving = true;

    if (ball.body) {
        ball.body.vel = k.vec2(0, 0);
    }

    const animateParabola = () => {
        animTime += k.dt();
        const progress = Math.min(animTime / duration, 1);

        if (progress >= 1) {
            ball.pos = targetPos;
            ball.isMoving = false;

            if (ball.body) {
                ball.body.vel = k.vec2(0, 0);
            }

            console.log("ğŸ¾ ê³µì´ í¬ë¬¼ì„ ì„ ê·¸ë¦¬ë©° ë‚ ì•„ê°”ìŠµë‹ˆë‹¤!");
            return;
        }

        const x = k.lerp(startPos.x, targetPos.x, progress);
        const baseY = k.lerp(startPos.y, targetPos.y, progress);
        const parabolaOffset = kickHeight * Math.sin(progress * Math.PI);
        const y = baseY - parabolaOffset;

        ball.pos = k.vec2(x, y);

        k.wait(0, animateParabola);
    };

    animateParabola();

    console.log("ğŸ¦µ í”Œë ˆì´ì–´ê°€ ê³µì— ì¶©ëŒí•˜ì—¬ í¬ë¬¼ì„  í‚¥!");
    
    // ê³µ ì°¨ê¸° í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì²˜ë¦¬
    if (window.completeQuestByTarget) {
        window.completeQuestByTarget("object", "ball");
    }
}

// ì¶”ê°€ëœ ë¶€ë¶„: í”Œë ˆì´ì–´ ìœ„ì— ê¸°ì¨ì˜ ë§í’ì„ ì„ ë„ìš°ëŠ” í•¨ìˆ˜
function showJoyBubble(k, player) {
    if (player.joyBubble && player.joyBubble.exists()) {
        player.joyBubble.destroy();
    }

    const BUBBLE_OFFSET_X = 5; 
    const BUBBLE_OFFSET_Y = -14;

    const joyBubble = k.add([
        k.sprite("tiny-speech-indicators", {
            frame: SPEECH_BUBBLE_STATES.VERY_HAPPY,
        }),
        k.pos(player.pos.x + BUBBLE_OFFSET_X, player.pos.y + BUBBLE_OFFSET_Y),
        k.scale(1.176), // 1.68ì˜ 70%: 1.68 * 0.7 = 1.176
        k.z(20),
        k.opacity(1.0),
        "joy-bubble",
    ]);

    let time = 0;

    joyBubble.onUpdate(() => {
        time += k.dt();

        if (player.exists()) {
            joyBubble.pos.x = player.pos.x + BUBBLE_OFFSET_X;
            if (time < 0.1) {
                joyBubble.pos.y = player.pos.y + BUBBLE_OFFSET_Y;
            } else {
                joyBubble.pos.y =
                    player.pos.y +
                    BUBBLE_OFFSET_Y +
                    Math.sin((time - 0.1) * 4) * 3;
            }
        }
    });

    player.joyBubble = joyBubble;

    k.wait(2, () => {
        if (joyBubble.exists()) {
            k.tween(
                joyBubble.opacity,
                0,
                0.5,
                (val) => {
                    joyBubble.opacity = val;
                },
                k.easings.easeOutQuad
            ).then(() => {
                if (joyBubble.exists()) {
                    joyBubble.destroy();
                }
            });
        }
    });
}

// í€˜ìŠ¤íŠ¸ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (ì „ì—­ í•¨ìˆ˜ë¡œ ì´ë™)
function showQuestCompletionMessage(questTitle) {
    const messageWidth = 800; // 500ì—ì„œ 800ìœ¼ë¡œ ëŠ˜ë ¤ì„œ í•œ ì¤„ë¡œ í‘œì‹œ
    const messageBg = k.add([
        k.rect(messageWidth, 70), // ê°€ë¡œí­ 800, ì„¸ë¡œí­ 70
        k.pos(k.width() / 2, 80), // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ê³¼ í‰í–‰í•œ ë†’ì´
        k.anchor("center"),
        k.color(180, 150, 210), // ì—°ë³´ë¼ìƒ‰ ë°°ê²½
        k.outline(1, k.rgb(80, 160, 80)), // ì•„ì›ƒë¼ì¸ ë‘ê»˜ 1
        k.z(200),
        k.fixed(),
        "quest-completion-message",
    ]);
    
    const messageText = k.add([
        k.text(`"${questTitle}" ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!`, { // í•œ ì¤„ë¡œ ë³€ê²½ (\n ì œê±°)
            size: 18, // 16ì—ì„œ 18ë¡œ ë‹¤ì‹œ í‚¤ì›Œì„œ ê°€ë…ì„± ê°œì„ 
            font: "galmuri",
            align: "center",
            width: messageWidth * 0.9 // ì•Œë¦¼ì°½ í­ì˜ 90%ë¡œ í…ìŠ¤íŠ¸ í­ ì„¤ì •
        }),
        k.pos(k.width() / 2, 80),
        k.anchor("center"),
        k.color(255, 255, 255),
        k.z(201),
        k.fixed(),
        "quest-completion-message",
    ]);
    
    k.play("coin-sfx", { volume: 0.6 });
    
    // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
    k.wait(3, () => {
        if (messageBg.exists()) messageBg.destroy();
        if (messageText.exists()) messageText.destroy();
    });
}

// í€˜ìŠ¤íŠ¸ ì¶”ê°€ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showQuestAddedMessage(questTitle) {
    const messageWidth = 800; // ì™„ë£Œ ì•Œë¦¼ê³¼ ê°™ì€ í¬ê¸°ë¡œ ëŠ˜ë¦¼
    const messageBg = k.add([
        k.rect(messageWidth, 70),
        k.pos(k.width() / 2, 80),
        k.anchor("center"),
        k.color(180, 150, 210), // ì—°ë³´ë¼ìƒ‰ ë°°ê²½ (ì¶”ê°€ ì•Œë¦¼ìš©)
        k.outline(1, k.rgb(80, 80, 160)),
        k.z(200),
        k.fixed(),
        "quest-added-message",
    ]);
    
    const messageText = k.add([
        k.text(`ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸: "${questTitle}" ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, {
            size: 18, // 16ì—ì„œ 18ë¡œ í‚¤ì›Œì„œ ê°€ë…ì„± ê°œì„ 
            font: "galmuri",
            align: "center",
            width: messageWidth * 0.9 // ì•Œë¦¼ì°½ í­ì˜ 90%ë¡œ í…ìŠ¤íŠ¸ í­ ì„¤ì •
        }),
        k.pos(k.width() / 2, 80),
        k.anchor("center"),
        k.color(255, 255, 255),
        k.z(201),
        k.fixed(),
        "quest-added-message",
    ]);
    
    k.play("coin-sfx", { volume: 0.6 });
    
    // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
    k.wait(3, () => {
        if (messageBg.exists()) messageBg.destroy();
        if (messageText.exists()) messageText.destroy();
    });
}

// í€˜ìŠ¤íŠ¸ UI ì‹œìŠ¤í…œ
function setupQuestUI(k, gameState) {
    // í€˜ìŠ¤íŠ¸ ìƒíƒœ ê´€ë¦¬
    const questState = {
        hasNewQuests: true, // ì´ˆê¸°ê°’ì€ trueë¡œ ì„¤ì • (ë¯¸ì™„ë£Œ í€˜ìŠ¤íŠ¸ê°€ ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ)
        isPopupOpen: false,
    };

    // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ (í™”ë©´ ìš°ì¸¡ ìƒë‹¨)
    const questIcon = k.add([
        k.sprite("main-assets", {
            frame: 5771, // ê¸°ë³¸ ì—´ë¦°í¸ì§€ë¡œ ì‹œì‘ (ë¯¸ì™„ë£Œ í€˜ìŠ¤íŠ¸ ìˆìŒ)
        }),
        k.pos(k.width() - 120, 20), // í™”ë©´ ìš°ì¸¡ ìƒë‹¨ (20px ì™¼ìª½ìœ¼ë¡œ ì´ë™)
        k.scale(2),
        k.z(1100), // z-indexë¥¼ ë†’ì—¬ì„œ í˜ì´ë“œ íš¨ê³¼ë³´ë‹¤ ìœ„ì—
        k.area(),
        k.fixed(), // ì¹´ë©”ë¼ ì´ë™ì— ê³ ì •
        "quest-icon",
    ]);
    
    // ì„¤ì • ì•„ì´ì½˜ (í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ì˜¤ë¥¸ìª½ì—)
    const settingsIcon = k.add([
        k.sprite("main-assets", {
            frame: 5772, // ì„¤ì • ì•„ì´ì½˜
        }),
        k.pos(k.width() - 60, 20), // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜ (20px ì™¼ìª½ìœ¼ë¡œ ì´ë™)
        k.scale(2),
        k.z(1100), // z-indexë¥¼ ë†’ì—¬ì„œ í˜ì´ë“œ íš¨ê³¼ë³´ë‹¤ ìœ„ì—
        k.area(),
        k.fixed(),
        "settings-icon",
    ]);
    
    // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateQuestIcon() {
        // í€˜ìŠ¤íŠ¸ í•­ëª©ë“¤ ì¤‘ì— ë¯¸ì™„ë£Œëœ ê²ƒì´ ìˆëŠ”ì§€ í™•ì¸
        const currentQuestItems = window.questItems || questItems;
        const hasIncompleteQuests = currentQuestItems && currentQuestItems.some(item => !item.completed);
        
        if (hasIncompleteQuests) {
            questIcon.frame = 5771; // ì—´ë¦°í¸ì§€ (ë¯¸ì™„ë£Œ í€˜ìŠ¤íŠ¸ ìˆìŒ)
            questState.hasNewQuests = true;
        } else {
            questIcon.frame = 5770; // ë‹«íŒí¸ì§€ (ëª¨ë“  í€˜ìŠ¤íŠ¸ ì™„ë£Œ)
            questState.hasNewQuests = false;
        }
    }

    // í€˜ìŠ¤íŠ¸ íŒì—… ë°°ê²½
    let questPopup = null;
    let questPopupContent = null;
    let questCloseButton = null; // í€˜ìŠ¤íŠ¸ íŒì—… ì „ìš© Xë²„íŠ¼ ë³€ìˆ˜

    // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸
    questIcon.onClick(() => {
        console.log("[DEBUG] í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ í´ë¦­ë¨");
        if (questState.isPopupOpen) {
            closeQuestPopup();
        } else {
            openQuestPopup();
        }
    });

    // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ í˜¸ë²„ íš¨ê³¼
    questIcon.onHover(() => {
        questIcon.scale = k.vec2(2.2, 2.2);
    });

    questIcon.onHoverEnd(() => {
        questIcon.scale = k.vec2(2, 2);
    });
    
    // ì„¤ì • ìƒíƒœ ê´€ë¦¬
    const settingsState = {
        isPopupOpen: false,
    };
    
    let settingsPopup = null;
    let settingsCloseButton = null; // ì„¤ì • íŒì—… ì „ìš© Xë²„íŠ¼ ë³€ìˆ˜
    
    // ì„¤ì • ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸
    settingsIcon.onClick(() => {
        console.log("[DEBUG] ì„¤ì • ì•„ì´ì½˜ í´ë¦­ë¨");
        if (settingsState.isPopupOpen) {
            closeSettingsPopup();
        } else {
            openSettingsPopup();
        }
    });

    // ì„¤ì • ì•„ì´ì½˜ í˜¸ë²„ íš¨ê³¼
    settingsIcon.onHover(() => {
        settingsIcon.scale = k.vec2(2.2, 2.2);
    });

    settingsIcon.onHoverEnd(() => {
        settingsIcon.scale = k.vec2(2, 2);
    });

    // í€˜ìŠ¤íŠ¸ íŒì—… ì—´ê¸°
    function openQuestPopup() {
        if (questState.isPopupOpen) return;

        questState.isPopupOpen = true;

        // í€˜ìŠ¤íŠ¸ ì°½ ê°œì„ ëœ ë””ìì¸ ì ìš©
        const panelWidth = k.width() * 0.8;
        const panelHeight = k.height() * 0.7;
        const panelX = k.width() * 0.1;
        const panelY = k.height() * 0.15;
        
        // íŒŒìŠ¤í…” ë¸”ë£¨ í…Œë§ˆë¡œ íŒ¨ë„ ìƒì„± - í—¤ë” ë†’ì´ ì ˆë°˜ìœ¼ë¡œ
        const panel = createPanelWithHeader(k, {
            x: panelX,
            y: panelY,
            width: panelWidth,
            height: panelHeight,
            headerHeight: 30, // ê¸°ë³¸ 60ì—ì„œ 30ìœ¼ë¡œ ì ˆë°˜
            colors: UI_THEMES.PASTEL_BLUE,
            zIndex: 150,
            tag: "quest-popup",
            fixed: true
        });

        questPopup = panel.mainBg; // í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€

        // íŒì—… ì œëª© (í—¤ë” ì˜ì—­ì— ë°°ì¹˜) - í¬ê¸° ì¦ê°€
        const title = k.add([
            k.text("ì˜¤ëŠ˜ì˜ í• ì¼", {
                size: 20, // 16ì—ì„œ 20ìœ¼ë¡œ ì¦ê°€
                font: "galmuri",
            }),
            k.pos(panel.headerArea.x + 8, panel.headerArea.y + panel.headerArea.height / 2), // ì—¬ë°± ì¡°ì •
            k.color(80, 80, 80), // íŒŒìŠ¤í…” í…Œë§ˆì— ë§ëŠ” ì§„í•œ íšŒìƒ‰
            k.anchor("left"),
            k.z(152),
            k.fixed(),
            "quest-popup-element",
        ]);

        // X ë²„íŠ¼ ìƒì„± (í€˜ìŠ¤íŠ¸ íŒì—…ìš©)
        questCloseButton = createCloseButton(k, {
            x: panel.headerArea.x + panel.headerArea.width - 30,
            y: panel.headerArea.y + 3,
            size: 24, // 18ì—ì„œ 24ë¡œ ì¦ê°€
            colors: {
                bg: [120, 140, 180],
                bgHover: [140, 160, 200],
                border: [100, 120, 160],
                text: [255, 255, 255]
            },
            zIndex: 162,
            tag: "quest-popup-element",
            fixed: true,
            onClick: () => {
                console.log("[DEBUG] í€˜ìŠ¤íŠ¸ X ë²„íŠ¼ í´ë¦­ë¨");
                closeQuestPopup();
            }
        });

        // í€˜ìŠ¤íŠ¸ í•­ëª©ë“¤ì„ ì²´í¬ë°•ìŠ¤ í˜•íƒœë¡œ ë Œë”ë§
        const questItemElements = [];
        const currentQuestItems = window.questItems || questItems;
        currentQuestItems.forEach((item, index) => {
            const yPos = panel.contentArea.y + 30 + (index * 50); // ì²« ë²ˆì§¸ í€˜ìŠ¤íŠ¸ì™€ ì œëª© ê°„ê²© +30px ì¶”ê°€
            
            // ì²´í¬ë°•ìŠ¤
            const checkbox = k.add([
                k.rect(16, 16),
                k.pos(panel.contentArea.x, yPos),
                k.color(item.completed ? [126, 155, 204] : [200, 200, 200]), // ì™„ë£Œì‹œ íŒŒìŠ¤í…” ë¸”ë£¨
                k.outline(2, k.rgb(80, 80, 80)),
                k.z(152),
                k.fixed(),
                "quest-popup-element",
            ]);
            
            // ì²´í¬ í‘œì‹œ (ì™„ë£Œëœ ê²½ìš°)
            if (item.completed) {
                const checkMark = k.add([
                    k.text("âœ“", {
                        size: 14, // 12ì—ì„œ 14ë¡œ ì¦ê°€
                font: "galmuri",
            }),
                    k.pos(panel.contentArea.x + 8, yPos + 8),
            k.color(255, 255, 255),
                    k.anchor("center"),
                    k.z(153),
            k.fixed(),
                    "quest-popup-element",
                ]);
            }
            
            // í€˜ìŠ¤íŠ¸ ì œëª© (ì™„ë£Œì‹œ ì·¨ì†Œì„ )
            const questTitle = k.add([
                k.text(item.title, {
                    size: 18, // 16ì—ì„œ 18ë¡œ ì¦ê°€
                font: "galmuri",
                }),
                k.pos(panel.contentArea.x + 24, yPos + 8),
                k.color(item.completed ? [150, 150, 150] : [80, 80, 80]), // ì™„ë£Œì‹œ íšŒìƒ‰
                k.anchor("left"),
                k.z(152),
            k.fixed(),
                "quest-popup-element",
            ]);
            
            // ì™„ë£Œëœ í€˜ìŠ¤íŠ¸ì— ì·¨ì†Œì„  ì¶”ê°€
            if (item.completed) {
                const strikethrough = k.add([
                    k.rect(questTitle.width, 2),
                    k.pos(panel.contentArea.x + 24, yPos + 8 + 9), // í…ìŠ¤íŠ¸ ì¤‘ì•™ì—
                    k.color(150, 150, 150),
                    k.z(153),
            k.fixed(),
                    "quest-popup-element",
                ]);
            }
            
            // ì„¸ë¶€ í•­ëª©ë“¤ (í™•ì¥ì‹œ)
            if (item.expanded) {
                item.details.forEach((detail, detailIndex) => {
                    const detailY = yPos + 25 + (detailIndex * 18);
                    const detailText = k.add([
                        k.text(`  â€¢ ${detail}`, {
                            size: 16, // 14ì—ì„œ 16ìœ¼ë¡œ ì¦ê°€
                font: "galmuri",
            }),
                        k.pos(panel.contentArea.x + 32, detailY),
                        k.color(item.completed ? [150, 150, 150] : [100, 100, 100]),
                        k.anchor("left"),
            k.z(152),
            k.fixed(),
                        "quest-popup-element",
                    ]);
                });
            }
            
            questItemElements.push({ checkbox, questTitle, item, index });
        });

        // ì²´í¬ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ (ì™„ë£Œ ìƒíƒœ í† ê¸€)
        questItemElements.forEach((element, index) => {
            const yPos = panel.contentArea.y + 30 + (index * 50); // ê°„ê²© ì¡°ì •ê³¼ ë™ì¼í•˜ê²Œ
            
            // ì²´í¬ë°•ìŠ¤ í´ë¦­ ì˜ì—­
            const checkboxClickArea = k.add([
                k.rect(20, 20),
                k.pos(panel.contentArea.x - 2, yPos - 2),
                k.area(),
                k.opacity(0),
                k.z(154),
                k.fixed(),
                "quest-checkbox-clickable",
                "quest-popup-element",
            ]);
            
            // ì œëª© í´ë¦­ ì˜ì—­ (í™•ì¥/ì¶•ì†Œ)
            const titleClickArea = k.add([
                k.rect(panel.contentArea.width - 30, 20),
                k.pos(panel.contentArea.x + 24, yPos - 2),
                k.area(),
                k.opacity(0.05),
                k.color(126, 155, 204),
                k.z(153),
                k.fixed(),
                "quest-title-clickable",
                "quest-popup-element",
            ]);
            
            // ì²´í¬ë°•ìŠ¤ í´ë¦­ (ì™„ë£Œ ìƒíƒœ í† ê¸€)
            checkboxClickArea.onClick(() => {
                console.log(`[DEBUG] í€˜ìŠ¤íŠ¸ ${index} ì™„ë£Œ ìƒíƒœ í† ê¸€`);
                const currentQuestItems = window.questItems || questItems;
                currentQuestItems[index].completed = !currentQuestItems[index].completed;
                k.play("confirm-beep-sfx", { volume: 0.4 });
                
                // ì²´í¬ë°•ìŠ¤ ìƒ‰ìƒ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                element.checkbox.color = currentQuestItems[index].completed ? 
                    k.rgb(120, 220, 120) : k.rgb(255, 255, 255);
                    
                // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateQuestIcon();
            });
            
            // ì œëª© í´ë¦­ (í™•ì¥/ì¶•ì†Œ) - íš¨ê³¼ìŒ ì œê±°ë¨
            titleClickArea.onClick(() => {
                console.log(`[DEBUG] í€˜ìŠ¤íŠ¸ ${index} ì œëª© í´ë¦­ - í™•ì¥/ì¶•ì†Œ ê¸°ëŠ¥ì€ ì•„ì§ ë¯¸êµ¬í˜„`);
                // í™•ì¥/ì¶•ì†Œ ê¸°ëŠ¥ì€ ë‚˜ì¤‘ì— êµ¬í˜„ ì˜ˆì •
                // const currentQuestItems = window.questItems || questItems;
                // currentQuestItems[index].expanded = !currentQuestItems[index].expanded;
            });
            
            // í˜¸ë²„ íš¨ê³¼
            titleClickArea.onHover(() => {
                titleClickArea.opacity = 0.1;
            });
            
            titleClickArea.onHoverEnd(() => {
                titleClickArea.opacity = 0.05;
            });
        });
        
        // í€˜ìŠ¤íŠ¸ íŒì—… ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ ì œê±°ë¨ (ë¬´í•œë£¨í”„ ë°©ì§€)

        // ê° íŒì—…ë³„ë¡œ ë…ë¦½ì ì¸ X ë²„íŠ¼ ì‚¬ìš© (questCloseButton, settingsCloseButton)

        // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (í€˜ìŠ¤íŠ¸ ìœ ë¬´ì— ë”°ë¼)
        updateQuestIcon();
    }

    // í€˜ìŠ¤íŠ¸ íŒì—… ë‹«ê¸°
    function closeQuestPopup() {
        if (!questState.isPopupOpen) return;

        console.log("[DEBUG] í€˜ìŠ¤íŠ¸ íŒì—… ë‹«ê¸° ì‹œì‘");
        questState.isPopupOpen = false;

        // í€˜ìŠ¤íŠ¸ íŒì—… ê´€ë ¨ ëª¨ë“  ìš”ì†Œ ì œê±° - ê°•í™”ëœ ë¡œì§
        try {
            // X ë²„íŠ¼ ë¨¼ì € ì •ë¦¬
            if (questCloseButton && questCloseButton.destroy) {
                console.log("[DEBUG] í€˜ìŠ¤íŠ¸ X ë²„íŠ¼ ì •ë¦¬ ì¤‘");
                questCloseButton.destroy();
            }
            if (questCloseButton && questCloseButton.elements) {
                questCloseButton.elements.forEach(element => {
                    if (element.exists && element.exists()) {
                        element.destroy();
                    }
                });
            }
            questCloseButton = null;
            
            // íƒœê·¸ë³„ë¡œ ëª¨ë“  ìš”ì†Œ ì œê±°
            const questElements = k.get("quest-popup-element");
            console.log(`[DEBUG] í€˜ìŠ¤íŠ¸ ìš”ì†Œ ${questElements.length}ê°œ ì œê±° ì¤‘`);
            questElements.forEach(obj => {
                if (obj.exists()) {
                    obj.destroy();
                }
            });
        
            // ì¶”ê°€ íƒœê·¸ë“¤ë„ ì •ë¦¬
            k.destroyAll("quest-checkbox-clickable");
            k.destroyAll("quest-title-clickable");
            k.destroyAll("quest-popup");
            k.destroyAll("quest-checkmark");
            k.destroyAll("quest-strikethrough");
            
            console.log("[DEBUG] í€˜ìŠ¤íŠ¸ íŒì—… ìš”ì†Œ ì •ë¦¬ ì™„ë£Œ");
        } catch (error) {
            console.warn("[DEBUG] í€˜ìŠ¤íŠ¸ íŒì—… ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
        }
        
        // ë³€ìˆ˜ë“¤ nullë¡œ ì„¤ì •
        questPopup = null;
            questPopupContent = null;
        questCloseButton = null;
    }

    // í€˜ìŠ¤íŠ¸ íŒì—… UI ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
    function refreshQuestPopupUI() {
        console.log("[DEBUG] í€˜ìŠ¤íŠ¸ íŒì—… UI ìƒˆë¡œê³ ì¹¨");
        
        // í˜„ì¬ ì—´ë ¤ìˆëŠ” í€˜ìŠ¤íŠ¸ íŒì—…ì˜ ì²´í¬ë°•ìŠ¤ë“¤ì„ ì—…ë°ì´íŠ¸
        questItems.forEach((item, index) => {
            // ì²´í¬ë°•ìŠ¤ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            const checkboxes = k.get("quest-checkbox-clickable");
            if (checkboxes[index]) {
                checkboxes[index].color = item.completed ? 
                    k.rgb(126, 155, 204) : k.rgb(200, 200, 200);
            }
            
            // ì²´í¬ ë§ˆí¬ ì—…ë°ì´íŠ¸ (ì™„ë£Œëœ ê²½ìš° ì¶”ê°€, ë¯¸ì™„ë£Œì‹œ ì œê±°)
            const checkMarks = k.get("quest-checkmark");
            checkMarks.forEach(mark => {
                if (mark.questIndex === index) {
                    mark.destroy();
                }
            });
            
            if (item.completed) {
                const yPos = k.get("quest-popup")[0].pos.y + 100 + (index * 50);
                k.add([
                    k.text("âœ“", {
                        size: 14,
                        font: "galmuri",
                    }),
                    k.pos(k.get("quest-popup")[0].pos.x + 8, yPos + 8),
                    k.color(255, 255, 255),
                    k.anchor("center"),
                    k.z(153),
                    k.fixed(),
                    "quest-popup-element",
                    "quest-checkmark",
                    { questIndex: index }
                ]);
            }
            
            // ì·¨ì†Œì„  ì—…ë°ì´íŠ¸
            const strikethroughs = k.get("quest-strikethrough");
            strikethroughs.forEach(strike => {
                if (strike.questIndex === index) {
                    strike.destroy();
                }
            });
            
            if (item.completed) {
                const questTitleElements = k.get("quest-title-text");
                const questTitle = questTitleElements[index];
                if (questTitle) {
                    k.add([
                        k.rect(questTitle.width, 2),
                        k.pos(questTitle.pos.x, questTitle.pos.y + 9),
                        k.color(150, 150, 150),
                        k.z(153),
                        k.fixed(),
                        "quest-popup-element",
                        "quest-strikethrough",
                        { questIndex: index }
                    ]);
                }
            }
        });
    }

    // ì„¤ì • íŒì—… ì—´ê¸°
    function openSettingsPopup() {
        if (settingsState.isPopupOpen) return;

        console.log("[DEBUG] ì„¤ì • íŒì—… ì—´ê¸° ì‹œì‘");
        
        // ê¸°ì¡´ ì„¤ì • íŒì—… ìš”ì†Œë“¤ ì •ë¦¬ (ì¤‘ë³µ ë°©ì§€) - ë”ìš± ê°•í™”ëœ ë¡œì§
        try {
            // ì´ì „ X ë²„íŠ¼ ì™„ì „ ì •ë¦¬
            if (settingsCloseButton) {
                console.log("[DEBUG] ì´ì „ ì„¤ì • X ë²„íŠ¼ ì •ë¦¬ ì¤‘");
                
                if (settingsCloseButton.destroy) {
                    settingsCloseButton.destroy();
                }
                if (settingsCloseButton.elements && Array.isArray(settingsCloseButton.elements)) {
                    settingsCloseButton.elements.forEach(element => {
                        if (element && element.exists && element.exists()) {
                            element.destroy();
                        }
                    });
                }
                
                // ê°œë³„ ìš”ì†Œë“¤ë„ ì •ë¦¬
                if (settingsCloseButton.bg && settingsCloseButton.bg.exists()) {
                    settingsCloseButton.bg.destroy();
                }
                if (settingsCloseButton.clickArea && settingsCloseButton.clickArea.exists()) {
                    settingsCloseButton.clickArea.destroy();
                }
                if (settingsCloseButton.buttonText && settingsCloseButton.buttonText.exists()) {
                    settingsCloseButton.buttonText.destroy();
                }
                
                settingsCloseButton = null;
            }
            
            // ê¸°ì¡´ ì„¤ì • ìš”ì†Œë“¤ ì™„ì „ ì •ë¦¬
            k.destroyAll("settings-popup-element");
            k.destroyAll("settings-popup");
            k.destroyAll("close-button"); // Xë²„íŠ¼ íƒœê·¸ë„ ì •ë¦¬
            
            console.log("[DEBUG] ì´ì „ ì„¤ì • ìš”ì†Œë“¤ ì •ë¦¬ ì™„ë£Œ");
        } catch (error) {
            console.warn("[DEBUG] ì„¤ì • ìš”ì†Œ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
        }

        settingsState.isPopupOpen = true;

        const panelWidth = k.width() * 0.7;
        const panelHeight = k.height() * 0.6;
        const panelX = (k.width() - panelWidth) / 2;
        const panelY = (k.height() - panelHeight) / 2;

        // ì„¤ì • íŒ¨ë„ ìƒì„± (íŒŒìŠ¤í…” í¼í”Œ í…Œë§ˆ) - í—¤ë” ë†’ì´ ì ˆë°˜ìœ¼ë¡œ
        const panel = createPanelWithHeader(k, {
            x: panelX,
            y: panelY,
            width: panelWidth,
            height: panelHeight,
            headerHeight: 30, // ê¸°ë³¸ 60ì—ì„œ 30ìœ¼ë¡œ ì ˆë°˜
            colors: UI_THEMES.PASTEL_PURPLE,
            zIndex: 160, // í€˜ìŠ¤íŠ¸ë³´ë‹¤ ìœ„ì—
            tag: "settings-popup",
            fixed: true
        });

        settingsPopup = panel.mainBg;

        // ì„¤ì • ì œëª© - í¬ê¸° ì¦ê°€
        const title = k.add([
            k.text("ê²Œì„ ì„¤ì •", {
                size: 20, // 16ì—ì„œ 20ìœ¼ë¡œ ì¦ê°€
                font: "galmuri",
            }),
            k.pos(panel.headerArea.x + 8, panel.headerArea.y + panel.headerArea.height / 2), // ì—¬ë°±ë„ ì¡°ì •
            k.color(80, 80, 80),
            k.anchor("left"),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        // X ë²„íŠ¼ ìƒì„± (ì„¤ì • íŒì—…ìš©)
        settingsCloseButton = createCloseButton(k, {
            x: panel.headerArea.x + panel.headerArea.width - 30,
            y: panel.headerArea.y + 3,
            size: 24, // 18ì—ì„œ 24ë¡œ ì¦ê°€
            colors: {
                bg: [75, 0, 130],        // ì§™ì€ ë³´ë¼ìƒ‰
                bgHover: [95, 20, 150],  // í˜¸ë²„ì‹œ ë°ì€ ë³´ë¼ìƒ‰
                border: [50, 0, 100],    // ë” ì§™ì€ ë³´ë¼ìƒ‰ í…Œë‘ë¦¬
                text: [255, 255, 255]    // í°ìƒ‰ í…ìŠ¤íŠ¸
            },
            zIndex: 172,
            tag: "settings-popup-element",
            onClick: () => {
                console.log("[DEBUG] ì„¤ì • X ë²„íŠ¼ í´ë¦­ë¨");
                closeSettingsPopup();
            }
        });

        // ì„¤ì • í•­ëª©ë“¤
        const settingY = panel.contentArea.y + 20;
        const itemSpacing = 50; // ê°„ê²©ì„ ì¤„ì—¬ ë” ë§ì€ í•­ëª© ë°°ì¹˜

        // ìŒì†Œê±° ì„¤ì •
        const muteLabel = k.add([
            k.text("ìŒì†Œê±°", {
                size: 20, // 18ì—ì„œ 20ìœ¼ë¡œ ì¦ê°€
                font: "galmuri",
            }),
            k.pos(panel.contentArea.x + 20, settingY),
            k.color(80, 80, 80),
            k.anchor("left"),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        const muteToggle = k.add([
            k.rect(60, 30),
            k.pos(panel.contentArea.x + panel.contentArea.width - 80, settingY - 5),
            k.color(gameState.getIsMuted() ? [200, 100, 100] : [100, 200, 100]),
            k.area(),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        const muteText = k.add([
            k.text(gameState.getIsMuted() ? "OFF" : "ON", {
                size: 14,
                font: "galmuri",
            }),
            k.pos(panel.contentArea.x + panel.contentArea.width - 50, settingY + 10),
            k.color(255, 255, 255),
            k.anchor("center"),
            k.z(163),
            k.fixed(),
            "settings-popup-element",
        ]);

        muteToggle.onClick(() => {
            const newMuted = !gameState.getIsMuted();
            gameState.setIsMuted(newMuted);
            
            // ì‹¤ì œ ì˜¤ë””ì˜¤ ë³¼ë¥¨ ì¡°ì ˆ
            if (newMuted) {
                k.volume(0); // ìŒì†Œê±°
            } else {
                k.volume(gameState.getBgmVolume() || 1.0); // ì´ì „ ë³¼ë¥¨ìœ¼ë¡œ ë³µì›
            }
            
            muteToggle.color = newMuted ? k.rgb(200, 100, 100) : k.rgb(100, 200, 100);
            muteText.text = newMuted ? "OFF" : "ON";
            
            // ìŒì†Œê±°ê°€ ì•„ë‹ ë•Œë§Œ íš¨ê³¼ìŒ ì¬ìƒ
            if (!newMuted) {
                k.play("boop-sfx", { volume: 0.3 });
            }
            
            console.log(`[DEBUG] ìŒì†Œê±° ìƒíƒœ ë³€ê²½: ${newMuted ? "ON" : "OFF"}`);
        });

        // ì–¸ì–´ ì„¤ì •
        const langLabel = k.add([
            k.text("ì–¸ì–´", {
                size: 20, // 18ì—ì„œ 20ìœ¼ë¡œ ì¦ê°€
                font: "galmuri",
            }),
            k.pos(panel.contentArea.x + 20, settingY + itemSpacing),
            k.color(80, 80, 80),
            k.anchor("left"),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        const langToggle = k.add([
            k.rect(80, 30),
            k.pos(panel.contentArea.x + panel.contentArea.width - 100, settingY + itemSpacing - 5),
            k.color(175, 126, 204), // íŒŒìŠ¤í…” í¼í”Œ
            k.area(),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        const langText = k.add([
            k.text(gameState.getLocale() === "korean" ? "í•œêµ­ì–´" : "English", {
                size: 14,
                font: "galmuri",
            }),
            k.pos(panel.contentArea.x + panel.contentArea.width - 60, settingY + itemSpacing + 10),
            k.color(255, 255, 255),
            k.anchor("center"),
            k.z(163),
            k.fixed(),
            "settings-popup-element",
        ]);

        langToggle.onClick(() => {
            const currentLocale = gameState.getLocale();
            const newLocale = currentLocale === "korean" ? "english" : "korean";
            
            console.log(`[DEBUG] ì–¸ì–´ ë³€ê²½: ${currentLocale} -> ${newLocale}`);
            gameState.setLocale(newLocale);
            langText.text = newLocale === "korean" ? "í•œêµ­ì–´" : "English";
            
            // ì–¸ì–´ ë³€ê²½ ì‹œ ì„¤ì •ì°½ì˜ í…ìŠ¤íŠ¸ë“¤ë„ ì—…ë°ì´íŠ¸
            title.text = newLocale === "korean" ? "ê²Œì„ ì„¤ì •" : "Game Settings";
            muteLabel.text = newLocale === "korean" ? "ìŒì†Œê±°" : "Mute";
            langLabel.text = newLocale === "korean" ? "ì–¸ì–´" : "Language";
            volumeLabel.text = newLocale === "korean" ? "ë³¼ë¥¨" : "Volume";
            mainMenuText.text = newLocale === "korean" ? "ë©”ì¸í™”ë©´ìœ¼ë¡œ" : "Main Menu";
            creditText.text = newLocale === "korean" ? "í¬ë ˆë”§" : "Credits";
            
            if (!gameState.getIsMuted()) {
                k.play("boop-sfx", { volume: 0.3 });
            }
        });

        // ë³¼ë¥¨ ì¡°ì ˆ ì„¤ì •
        const volumeLabel = k.add([
            k.text("ë³¼ë¥¨", {
                size: 20, // 18ì—ì„œ 20ìœ¼ë¡œ ì¦ê°€
                font: "galmuri",
            }),
            k.pos(panel.contentArea.x + 20, settingY + itemSpacing * 2),
            k.color(80, 80, 80),
            k.anchor("left"),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        // ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ë°°ê²½
        const volumeSliderBg = k.add([
            k.rect(120, 12),
            k.pos(panel.contentArea.x + panel.contentArea.width - 140, settingY + itemSpacing * 2 + 4),
            k.color(200, 200, 200),
            k.outline(2, k.rgb(120, 120, 120)),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        // ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ë°”
        const currentVolume = gameState.getBgmVolume() || 1.0;
        const volumeSliderBar = k.add([
            k.rect(120 * currentVolume, 12),
            k.pos(panel.contentArea.x + panel.contentArea.width - 140, settingY + itemSpacing * 2 + 4),
            k.color(175, 126, 204),
            k.z(163),
            k.fixed(),
            "settings-popup-element",
        ]);

        // ë³¼ë¥¨ í…ìŠ¤íŠ¸
        const volumeText = k.add([
            k.text(`${Math.round(currentVolume * 100)}%`, {
                size: 14,
                font: "galmuri",
            }),
            k.pos(panel.contentArea.x + panel.contentArea.width - 80, settingY + itemSpacing * 2 + 10),
            k.color(80, 80, 80),
            k.anchor("center"),
            k.z(164),
            k.fixed(),
            "settings-popup-element",
        ]);

        // ë³¼ë¥¨ ì¡°ì ˆ í´ë¦­ ì˜ì—­
        const volumeClickArea = k.add([
            k.rect(120, 24),
            k.pos(panel.contentArea.x + panel.contentArea.width - 140, settingY + itemSpacing * 2 - 6),
            k.area(),
            k.opacity(0),
            k.z(164),
            k.fixed(),
            "settings-popup-element",
        ]);

        volumeClickArea.onClick(() => {
            const mouseX = k.mousePos().x;
            const clickX = mouseX - volumeClickArea.pos.x;
            const newVolume = Math.max(0, Math.min(1, clickX / 120));
            
            gameState.setBgmVolume(newVolume);
            if (!gameState.getIsMuted()) {
                k.volume(newVolume);
            }
            
            volumeSliderBar.width = 120 * newVolume;
            volumeText.text = `${Math.round(newVolume * 100)}%`;
            
            console.log(`[DEBUG] ë³¼ë¥¨ ë³€ê²½: ${Math.round(newVolume * 100)}%`);
            
            if (!gameState.getIsMuted()) {
                k.play("boop-sfx", { volume: newVolume * 0.3 });
            }
        });

        // ë©”ì¸í™”ë©´ìœ¼ë¡œ ë‚˜ê°€ê¸° ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨ì— ë°°ì¹˜)
        const mainMenuButton = k.add([
            k.rect(120, 35),
            k.pos(panel.contentArea.x + panel.contentArea.width - 250, panel.contentArea.y + panel.contentArea.height - 60), // ìš°ì¸¡ í•˜ë‹¨ì— ë°°ì¹˜ (20px íŒ¨ë”©)
            k.color(255, 180, 180),
            k.outline(2, k.rgb(220, 120, 120)),
            k.area(),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        const mainMenuText = k.add([
            k.text("ë©”ì¸í™”ë©´ìœ¼ë¡œ", {
                size: 16, // í¬ê¸° ì¡°ì •
                font: "galmuri",
            }),
            k.pos(panel.contentArea.x + panel.contentArea.width - 190, panel.contentArea.y + panel.contentArea.height - 42), // ë²„íŠ¼ ì¤‘ì•™ì— ë°°ì¹˜
            k.color(120, 60, 60),
            k.anchor("center"),
            k.z(163),
            k.fixed(),
            "settings-popup-element",
        ]);

        mainMenuButton.onClick(() => {
            console.log("[DEBUG] ë©”ì¸í™”ë©´ìœ¼ë¡œ ì´ë™");
            if (!gameState.getIsMuted()) {
                k.play("boop-sfx", { volume: 0.5 });
            }
            closeSettingsPopup();
            k.go("title");
        });

        mainMenuButton.onHover(() => {
            mainMenuButton.color = k.rgb(255, 200, 200);
        });

        mainMenuButton.onHoverEnd(() => {
            mainMenuButton.color = k.rgb(255, 180, 180);
        });

        // í¬ë ˆë”§ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨ì— ë°°ì¹˜)
        const creditButton = k.add([
            k.rect(120, 35),
            k.pos(panel.contentArea.x + panel.contentArea.width - 120, panel.contentArea.y + panel.contentArea.height - 60), // ë©”ì¸ë©”ë‰´ ë²„íŠ¼ ì˜†ì— ë°°ì¹˜
            k.color(180, 255, 180),
            k.outline(2, k.rgb(120, 220, 120)),
            k.area(),
            k.z(162),
            k.fixed(),
            "settings-popup-element",
        ]);

        const creditText = k.add([
            k.text("í¬ë ˆë”§", {
                size: 16, // í¬ê¸° ì¡°ì •
                font: "galmuri",
            }),
            k.pos(panel.contentArea.x + panel.contentArea.width - 60, panel.contentArea.y + panel.contentArea.height - 42), // ë²„íŠ¼ ì¤‘ì•™ì— ë°°ì¹˜
            k.color(60, 120, 60),
            k.anchor("center"),
            k.z(163),
            k.fixed(),
            "settings-popup-element",
        ]);

        creditButton.onClick(() => {
            console.log("[DEBUG] í¬ë ˆë”§ìœ¼ë¡œ ì´ë™");
            if (!gameState.getIsMuted()) {
                k.play("boop-sfx", { volume: 0.5 });
            }
            gameState.setPreviousScene("front"); // ì´ì „ ì”¬ì„ frontë¡œ ì„¤ì •
            closeSettingsPopup();
            k.go("credits");
        });

        creditButton.onHover(() => {
            creditButton.color = k.rgb(200, 255, 200);
        });

        creditButton.onHoverEnd(() => {
            creditButton.color = k.rgb(180, 255, 180);
        });
        
        // X ë²„íŠ¼ì€ ì´ë¯¸ ìœ„ì—ì„œ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œê±°í•¨
    }
    
    // ì„¤ì • íŒì—… ë‹«ê¸°
    function closeSettingsPopup() {
        if (!settingsState.isPopupOpen) return;

        console.log("[DEBUG] ì„¤ì • íŒì—… ë‹«ê¸° ì‹œì‘");
        settingsState.isPopupOpen = false;

        // ì„¤ì • íŒì—… ê´€ë ¨ ëª¨ë“  ìš”ì†Œ ì œê±° - ë”ìš± ê°•í™”ëœ ë¡œì§
        try {
            // X ë²„íŠ¼ ë¨¼ì € ì •ë¦¬ - ëª¨ë“  ê°€ëŠ¥í•œ ë°©ë²•ìœ¼ë¡œ
            if (settingsCloseButton) {
                console.log("[DEBUG] ì„¤ì • X ë²„íŠ¼ ì •ë¦¬ ì¤‘");
                
                // destroy ë©”ì„œë“œê°€ ìˆìœ¼ë©´ ì‚¬ìš©
                if (settingsCloseButton.destroy) {
                    settingsCloseButton.destroy();
                }
                
                // elements ë°°ì—´ì´ ìˆìœ¼ë©´ ê°œë³„ ì •ë¦¬
                if (settingsCloseButton.elements && Array.isArray(settingsCloseButton.elements)) {
                    settingsCloseButton.elements.forEach(element => {
                        if (element && element.exists && element.exists()) {
                            element.destroy();
                        }
                    });
                }
                
                // ê°œë³„ ìš”ì†Œë“¤ë„ ì •ë¦¬
                if (settingsCloseButton.bg && settingsCloseButton.bg.exists()) {
                    settingsCloseButton.bg.destroy();
                }
                if (settingsCloseButton.clickArea && settingsCloseButton.clickArea.exists()) {
                    settingsCloseButton.clickArea.destroy();
                }
                if (settingsCloseButton.buttonText && settingsCloseButton.buttonText.exists()) {
                    settingsCloseButton.buttonText.destroy();
                }
                
                settingsCloseButton = null;
            }
            
            // íƒœê·¸ë³„ë¡œ ëª¨ë“  ìš”ì†Œ ì œê±° - ë‹¤ì¤‘ íƒœê·¸ ì •ë¦¬
            const settingsElements = k.get("settings-popup-element");
            console.log(`[DEBUG] ì„¤ì • ìš”ì†Œ ${settingsElements.length}ê°œ ì œê±° ì¤‘`);
            settingsElements.forEach(obj => {
                if (obj && obj.exists && obj.exists()) {
                    obj.destroy();
                }
            });
            
            // ì¶”ê°€ íƒœê·¸ë“¤ë„ ì •ë¦¬
            k.destroyAll("settings-popup");
            k.destroyAll("settings-popup-element");
            k.destroyAll("close-button"); // Xë²„íŠ¼ íƒœê·¸ë„ ì •ë¦¬
            
            console.log("[DEBUG] ì„¤ì • íŒì—… ìš”ì†Œ ì •ë¦¬ ì™„ë£Œ");
        } catch (error) {
            console.warn("[DEBUG] ì„¤ì • íŒì—… ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
        }
        
        // ë³€ìˆ˜ nullë¡œ ì„¤ì •
        settingsPopup = null;
        settingsCloseButton = null;
    }

    // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸° + ëª¨ë“  íŒì—… ìš”ì†Œ ê°•ì œ ì •ë¦¬
    k.onKeyPress("escape", () => {
        console.log("[DEBUG] ESC í‚¤ ëˆŒë¦¼ - íŒì—… ì •ë¦¬");
        
        if (settingsState.isPopupOpen) {
            closeSettingsPopup();
        } else if (questState.isPopupOpen) {
            closeQuestPopup();
        }
        
        // ì¶”ê°€ ì•ˆì „ì¥ì¹˜: í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” íŒì—… ìš”ì†Œë“¤ ê°•ì œ ì •ë¦¬
        k.wait(0.1, () => {
            try {
                k.destroyAll("quest-popup-element");
                k.destroyAll("settings-popup-element");
                k.destroyAll("quest-checkbox-clickable");
                k.destroyAll("quest-title-clickable");
                console.log("[DEBUG] íŒì—… ìš”ì†Œ ê°•ì œ ì •ë¦¬ ì™„ë£Œ");
            } catch (error) {
                console.warn("[DEBUG] íŒì—… ê°•ì œ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
            }
        });
    });

    // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì•„ì´ì½˜ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    k.onResize(() => {
        questIcon.pos = k.vec2(k.width() - 120, 20);
        settingsIcon.pos = k.vec2(k.width() - 60, 20);
    });

    // ì´ˆê¸° í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ìƒíƒœ ì„¤ì •
    k.wait(0.1, () => {
        // ì•½ê°„ì˜ ì§€ì—° í›„ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (í€˜ìŠ¤íŠ¸ í•­ëª©ì´ ì´ˆê¸°í™”ëœ í›„)
        const currentQuestItems = window.questItems || questItems;
        if (currentQuestItems && currentQuestItems.length > 0) {
            updateQuestIcon();
        }
    });

    // í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì•Œë¦¼ í•¨ìˆ˜
    function showQuestCompletionMessage(questTitle) {
        console.log(`[DEBUG] í€˜ìŠ¤íŠ¸ ì™„ë£Œ: ${questTitle}`);
        
        // ì™„ë£Œ ë©”ì‹œì§€ ë°°ê²½
        const messageBg = k.add([
            k.rect(600, 120),
            k.pos(k.width() / 2, 80), // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ê³¼ í‰í–‰í•œ ë†’ì´
            k.anchor("center"),
            k.color(180, 150, 210), // ì—°ë³´ë¼ìƒ‰ ë°°ê²½
            k.outline(4, k.rgb(80, 160, 80)),
            k.z(200),
            k.fixed(),
            "quest-completion-message",
        ]);

        // ì™„ë£Œ ë©”ì‹œì§€ í…ìŠ¤íŠ¸
        const messageText = k.add([
            k.text(`"${questTitle}"\nì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!`, {
                size: 20,
                font: "galmuri",
                align: "center",
            }),
            k.pos(k.width() / 2, 80),
            k.anchor("center"),
            k.color(255, 255, 255),
            k.z(201),
            k.fixed(),
            "quest-completion-message",
        ]);

        // íš¨ê³¼ìŒ ì¬ìƒ
        k.play("coin-sfx", { volume: 0.6 });

        // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
        k.wait(3, () => {
            k.destroyAll("quest-completion-message");
        });
    }

    // í€˜ìŠ¤íŠ¸ ì™„ë£Œ í™•ì¸ í•¨ìˆ˜
    function completeQuestByNpc(npcType) {
        console.log(`[DEBUG] NPC ${npcType}ì™€ ëŒ€í™” - í€˜ìŠ¤íŠ¸ ì™„ë£Œ í™•ì¸`);
        console.log(`[DEBUG] í˜„ì¬ questItems:`, window.questItems || questItems);
        
        // ì „ì—­ questItems ì°¸ì¡° (window ê°ì²´ë¥¼ í†µí•´ ì ‘ê·¼)
        const currentQuestItems = window.questItems || questItems;
        if (!currentQuestItems) {
            console.error("[DEBUG] questItemsì´ ì •ì˜ë˜ì§€ ì•ŠìŒ");
            return false;
        }
        
        // í•´ë‹¹ NPCë¥¼ íƒ€ê²Ÿìœ¼ë¡œ í•˜ëŠ” ë¯¸ì™„ë£Œ í€˜ìŠ¤íŠ¸ ì°¾ê¸°
        for (let i = 0; i < currentQuestItems.length; i++) {
            const quest = currentQuestItems[i];
            if (quest.targetNpc === npcType && !quest.completed) {
                console.log(`[DEBUG] í€˜ìŠ¤íŠ¸ "${quest.title}" ì™„ë£Œ!`);
                quest.completed = true;
                
                // ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                showQuestCompletionMessage(quest.title);
                
                // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateQuestIcon();
                
                // í€˜ìŠ¤íŠ¸ íŒì—…ì´ ì—´ë ¤ìˆë‹¤ë©´ ì²´í¬ë°•ìŠ¤ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                if (questState.isPopupOpen) {
                    const checkboxes = k.get("quest-popup-element").filter(obj => 
                        obj.is && obj.is("rect") && obj.width === 16
                    );
                    if (checkboxes[i]) {
                        checkboxes[i].color = k.rgb(120, 220, 120);
                    }
                }
                
                return true; // í€˜ìŠ¤íŠ¸ ì™„ë£Œë¨
            }
        }
        return false; // ì™„ë£Œëœ í€˜ìŠ¤íŠ¸ ì—†ìŒ
    }

    // ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸ ì¶”ê°€ í•¨ìˆ˜ (ë‚˜ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡)
    return {
        addNewQuest: () => {
            questState.hasNewQuests = true;
            questIcon.frame = 5771; // ì—´ë¦°í¸ì§€
        },
        markQuestsAsRead: () => {
            questState.hasNewQuests = false;
            questIcon.frame = 5770; // ë‹«íŒí¸ì§€
        },
        updateQuestIcon: updateQuestIcon, // ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡
    };

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
    window.updateQuestIcon = updateQuestIcon;
    window.showQuestCompletionMessage = showQuestCompletionMessage;
    window.showQuestAddedMessage = showQuestAddedMessage;
}

export default async function front(k) {
    console.log("ğŸ  Front ì”¬ ì‹œì‘");
    
    // ê²Œì„ ë°ì´í„° ìë™ ì´ˆê¸°í™” (í”Œë ˆì´ì–´ ì´ë¦„ ë¡œë“œ ë“±)
    const gameData = initializeGameData("front");
    console.log("ğŸ® Front ì”¬ ê²Œì„ ë°ì´í„°:", gameData);
    
    // ì €ì¥ëœ í€˜ìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ ì‹œë„
    const playerName = gameState.playerName;
    let savedQuestData = null;
    
    if (playerName && playerName.trim() !== "" && playerName !== "í”Œë ˆì´ì–´") {
        const existingSaves = gameDataManager.getSaveList();
        const playerSave = existingSaves.find(save => save.playerName === playerName);
        
        if (playerSave && playerSave.questState && playerSave.questState.questItems) {
            savedQuestData = playerSave.questState.questItems;
            console.log("ğŸ¯ ì €ì¥ëœ í€˜ìŠ¤íŠ¸ ë°ì´í„° ë°œê²¬:", savedQuestData);
        }
    }
    
    // í€˜ìŠ¤íŠ¸ í•­ëª©ë“¤ ì´ˆê¸°í™” - í•­ìƒ ê¸°ë³¸ í€˜ìŠ¤íŠ¸ 1, 2ë¡œ ì‹œì‘
    console.log("âœ¨ ê¸°ë³¸ í€˜ìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”");
    questItems = [
        {
            title: "[Q01] ê³¨ëŒ€ ê·¼ì²˜ ê³„ë‹¨ì— ì•‰ì€ ì¹œêµ¬ì—ê²Œ ë§ê±¸ê¸°",
            details: ["ìš´ë™ì¥ ê³¨ëŒ€ ê·¼ì²˜ì—ì„œ ê³„ë‹¨ì— ì•‰ì•„ìˆëŠ” í•™ìƒ ì°¾ê¸°", "ê·¸ í•™ìƒê³¼ ëŒ€í™”í•´ë³´ê¸°"],
            expanded: false,
            completed: false,
            targetNpc: "student1" // ì™„ë£Œ ì¡°ê±´ ì¶”ê°€
        },
        {
            title: "[Q02] ìš´ë™ì¥ í”¼êµ¬ê³µ ë»¥ ì°¨ë³´ê¸°",
            details: ["ìš´ë™ì¥ì— ìˆëŠ” í”¼êµ¬ê³µ ì°¾ê¸°", "ê³µì— ë‹¤ê°€ê°€ì„œ ì°¨ë³´ê¸°"],
            expanded: false,
            completed: false,
            targetObject: "ball" // ì™„ë£Œ ì¡°ê±´ ì¶”ê°€
        }
        // í€˜ìŠ¤íŠ¸ 3ì€ í€˜ìŠ¤íŠ¸ 1 ì™„ë£Œ ì‹œ ì¶”ê°€ë¨
    ];
    
    // ì €ì¥ëœ í€˜ìŠ¤íŠ¸ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ì™„ë£Œ ìƒíƒœë§Œ ë³µì›
    if (savedQuestData && savedQuestData.length > 0) {
        console.log("ğŸ”„ ì €ì¥ëœ í€˜ìŠ¤íŠ¸ ì™„ë£Œ ìƒíƒœ ë³µì›:", savedQuestData);
        
        // í€˜ìŠ¤íŠ¸ 1 ì™„ë£Œ ìƒíƒœ ë³µì›
        if (savedQuestData[0] && savedQuestData[0].completed) {
            questItems[0].completed = true;
            
            // í€˜ìŠ¤íŠ¸ 1ì´ ì™„ë£Œë˜ì—ˆë‹¤ë©´ í€˜ìŠ¤íŠ¸ 3 ì¶”ê°€
            if (!questItems.some(quest => quest.targetNpc === "student4")) {
                questItems.push({
                    title: "[Q03] ìš´ë™ì¥ì—ì„œ ê°œë¯¸ ê´€ì°°í•˜ëŠ” ì¹œêµ¬ ì°¾ê³  ë§ê±¸ê¸°",
                    details: ["ìš´ë™ì¥ì„ ë‘˜ëŸ¬ë³´ë©° ê°œë¯¸ë¥¼ ê´€ì°°í•˜ëŠ” í•™ìƒ ì°¾ê¸°", "ê·¸ í•™ìƒê³¼ ëŒ€í™”í•´ë³´ê¸°"],
                    expanded: false,
                    completed: false,
                    targetNpc: "student4"
                });
            }
        }
        
        // í€˜ìŠ¤íŠ¸ 2 ì™„ë£Œ ìƒíƒœ ë³µì›
        if (savedQuestData.length > 1 && savedQuestData[1] && savedQuestData[1].completed) {
            questItems[1].completed = true;
        }
        
        // í€˜ìŠ¤íŠ¸ 3ì´ ìˆë‹¤ë©´ ì™„ë£Œ ìƒíƒœ ë³µì›
        const savedQuest3 = savedQuestData.find(quest => quest.targetNpc === "student4");
        if (savedQuest3 && questItems.length > 2) {
            questItems[2].completed = savedQuest3.completed;
        }
    }
    
    // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•´ window ê°ì²´ì—ë„ í• ë‹¹
    window.questItems = questItems;
    
    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì´ˆê¸°í™” (ì´ì „ ì”¬ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶©ëŒ ë°©ì§€)
    console.log("ğŸ”§ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì´ˆê¸°í™” ì‹œì‘");
    
    // window.previousKeyHandlerê°€ ìˆë‹¤ë©´ ì œê±°
    if (window.previousKeyHandler) {
        document.removeEventListener('keydown', window.previousKeyHandler, true);
        document.removeEventListener('keyup', window.previousKeyHandler, true);
        window.previousKeyHandler = null;
        console.log("âœ… ì´ì „ í‚¤ë³´ë“œ í•¸ë“¤ëŸ¬ ì œê±° ì™„ë£Œ");
    }
    
    console.log("ğŸ”§ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ");

    // ì´ì „ ì”¬ í™•ì¸í•˜ì—¬ í˜ì´ë“œ ì¸ ì„¤ì •
    const previousScene = gameState.getPreviousScene();
    console.log(`[DEBUG] Front ì”¬ ì‹œì‘ - ì´ì „ ì”¬: ${previousScene}`);

    // ë°°ê²½ìƒ‰ì„ ì¦‰ì‹œ ê²€ì€ìƒ‰ìœ¼ë¡œ ì„¤ì • (ê¹œë¹¡ì„ ë°©ì§€)
    document.body.style.backgroundColor = 'black';

    // í˜ì´ë“œ ì¸ íš¨ê³¼ ì¶”ê°€
    const fadeIn = k.add([
        k.rect(k.width(), k.height()),
        k.pos(0, 0),
        k.color(0, 0, 0),
        k.opacity(1),
        k.z(1001),
        k.fixed(),
    ]);
    
    // Tutorialì—ì„œ ì˜¤ëŠ” ê²½ìš° ì•½ê°„ì˜ ì§€ì—° í›„ í˜ì´ë“œ ì¸ ì‹œì‘
    const fadeInDuration = (previousScene === "tutorial") ? 1.0 : 1.8;
    const fadeInDelay = (previousScene === "tutorial") ? 0.3 : 0;
    
    k.wait(fadeInDelay, () => {
        // í˜ì´ë“œ ì¸ ì• ë‹ˆë©”ì´ì…˜
        k.tween(fadeIn.opacity, 0, fadeInDuration, (val) => {
        fadeIn.opacity = val;
    }).then(() => {
        fadeIn.destroy();
        });
        console.log(`[DEBUG] Front í˜ì´ë“œì¸ ì‹œì‘ - ì§€ì—°: ${fadeInDelay}s, ì§€ì†: ${fadeInDuration}s`);
    });
    
    // BGM ì¬ìƒ (JavaScript ì˜¤ë””ì˜¤ ì‚¬ìš©)
    console.log("ğŸµ Front BGM ì¬ìƒ ì‹œì‘");
    if (!audioManager.isBGMPlaying() || audioManager.getCurrentBGM() !== "rpg-front-bgm") {
        audioManager.playBGM("rpg-front-bgm", 1.0).then(() => {
            console.log("ğŸµ Front BGM ì¬ìƒ ì™„ë£Œ");
        }).catch((error) => {
            console.error("ğŸµ Front BGM ì¬ìƒ ì‹¤íŒ¨:", error);
        });
    } else {
        console.log("ğŸµ Front BGM ì´ë¯¸ ì¬ìƒ ì¤‘");
    }

    console.log("ğŸ” Front ì”¬ ì§„ì… - ì´ì „ ì”¬:", previousScene); // ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€

    // ì–¸ì–´ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì •
    gameState.setLocale("korean");

    // ë°°ê²½ìƒ‰ ì œê±° - ë§µ í…ìŠ¤ì²˜ê°€ ë°°ê²½ ì—­í• ì„ í•¨
    // colorizeBackground(k, 173, 216, 230); // ì—°í•œ íŒŒë€ìƒ‰ ë°°ê²½ (í•˜ëŠ˜ìƒ‰) - ì œê±°
    
    const entities = {
        player: null,
        cars: [],
        objects: [],
    };
    
    // í€˜ìŠ¤íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ì „ì—­ ì ‘ê·¼ ë³€ìˆ˜
    let questSystem = null;
    
    let map;
    
    try {
        const mapData = await fetchMapData("./assets/images/front.json");
        console.log("ğŸ—ºï¸ Front ë§µ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", mapData);
        map = k.add([k.pos(0, 0)]);

        const layers = mapData.layers;
        console.log("ğŸ—ºï¸ ë ˆì´ì–´ ì •ë³´:", layers.map(l => ({ name: l.name, type: l.type, objects: l.objects?.length || 'N/A' })));
        
    for (const layer of layers) {
        if (layer.name === "boundaries") {
            console.log("ğŸš§ Boundaries ë ˆì´ì–´ ë°œê²¬:", layer);
            console.log("ğŸš§ Layer offset:", layer.offsetx, layer.offsety);
            // boundaries ë ˆì´ì–´ì—ì„œ íŠ¹ë³„í•œ ì˜¤ë¸Œì íŠ¸ë“¤ ì²˜ë¦¬
            for (const object of layer.objects) {
                console.log(`ğŸ¯ ë°œê²¬ëœ boundary ì˜¤ë¸Œì íŠ¸: ${object.name} at (${object.x}, ${object.y}) size: ${object.width}x${object.height}`);
                if (
                    [
                        "car1",
                        "car2", // car2 ì¶”ê°€
                        "car3", 
                        "car4",
                        "pot", // pot1, pot2ë¥¼ potìœ¼ë¡œ í†µí•©
                        "guryeong",
                        "sink",
                        "goal_post1",
                        "goal_post2",
                        "line_machine",
                        "badminton",
                        "main_entrance",
                        "front_gate", // front_gate ì¶”ê°€
                        "ball", // ball ì¶”ê°€
                        "cat1", // cat1 ì¶”ê°€
                        "cat2", // cat2 ì¶”ê°€
                        "nca", // nca ì¶”ê°€
                        "badminton", // badminton ì¶”ê°€
                        "director", // director ì¶”ê°€
                        "facil", // facil ì¶”ê°€
                    ].includes(object.name)
                ) {
                    const objectType = object.name;

                    // directorì™€ facilì˜ íŠ¹ë³„í•œ ì²˜ë¦¬ (yì¢Œí‘œ ì¡°ì •, ë„ˆë¹„ 5% ì¦ê°€)
                    if (objectType === "director" || objectType === "facil") {
                        const adjustedWidth = Math.round(object.width * 1.05); // ë„ˆë¹„ 5% ì¦ê°€
                        const adjustedY = object.y + (layer.offsety || 0) - 12; // Y ì¢Œí‘œë¥¼ ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¡°ì • (10ë§Œí¼ ë‚´ë¦¼)
                        
                        const npcEntity = map.add([
                            k.rect(adjustedWidth, object.height),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x + (layer.offsetx || 0), adjustedY),
                            k.opacity(0), // íˆ¬ëª…í•˜ê²Œ ì„¤ì •
                            objectType,
                            "interactive-object",
                            { objectType },
                        ]);

                        npcEntity.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = frontDialogues[locale]?.[objectType] || [
                                `Hello! I'm ${objectType}.`,
                                `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ${objectType}ì…ë‹ˆë‹¤.`,
                            ];

                            const speakerName =
                                frontDialogues.names[locale]?.[objectType] ||
                                objectType;

                            gameState.setInteractableObject(
                                npcEntity,
                                "npc",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                        });

                        npcEntity.onCollideEnd("player", () => {
                            gameState.clearInteractableObject();
                        });

                        entities.objects.push(npcEntity);
                        continue;
                    }

                    // Tiled ì¢Œí‘œê³„ì— ë§ì¶° ìœ„ì¹˜ ì¡°ì • (24x24 íƒ€ì¼ í¬ê¸° ê³ ë ¤, offsety ì ìš©)
                    const objectEntity = map.add([
                        k.rect(object.width, object.height),
                        k.area(),
                        k.body({ isStatic: true }),
                        k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0) - 12), // Y ìœ„ì¹˜ë¥¼ 12í”½ì…€ ìœ„ë¡œ ì¡°ì •
                        k.opacity(0), // íˆ¬ëª…í•˜ê²Œ ì„¤ì •
                        objectType,
                        "interactive-object",
                        { objectType },
                    ]);

                    // main_entranceì˜ ê²½ìš° firstë¡œ ì´ë™
                    objectEntity.onCollideUpdate("player", (player) => {
                        if (objectType === "main_entrance") {
                            console.log("ğŸšª ë©”ì¸ ì…êµ¬ ê°ì§€ë¨!");
                            k.play("boop-sfx");
                            gameState.setPreviousScene("front");
                            k.go("first");
                            return;
                        }

                        if (objectType === "front_gate") {
                            console.log("ğŸšª ì •ë¬¸ ê°ì§€ë¨!");
                            const locale = gameState.getLocale();
                            const content = frontObjectDialogues[locale]?.["front_gate"] || [
                                "This is the school's front gate. You can leave the school from here.",
                                "í•™êµ ì •ë¬¸ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œ í•™êµë¥¼ ë‚˜ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                            ];

                            const speakerName =
                                objectDialogues.names[locale]?.["front_gate"] ||
                                "Front Gate";

                            gameState.setInteractableObject(
                                objectEntity,
                                "object",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                            return;
                        }

                        // ball (í”¼êµ¬ê³µ) ì²˜ë¦¬ - ë¬¼ë¦¬ì ìœ¼ë¡œ ì°¨ì¼ ìˆ˜ ìˆëŠ” ì˜¤ë¸Œì íŠ¸
                        if (objectType === "ball") {
                            console.log("âš½ í”¼êµ¬ê³µ ê°ì§€ë¨!");
                            
                            // ê¸°ì¡´ objectEntity ì œê±°
                            objectEntity.destroy();
                            
                            // ìƒˆë¡œìš´ ball ì—”í‹°í‹° ìƒì„±
                            const ball = map.add([
                                k.sprite("main-assets", {
                                    frame: 5296, // main.jsì— ì •ì˜ëœ ball ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                                }),
                                k.area({
                                    shape: new k.Rect(k.vec2(0), 24, 24),
                                }),
                                k.body({
                                    isStatic: true,
                                    mass: 1,
                                    restitution: 0.6,
                                }),
                                k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0) - 12), // Y ìœ„ì¹˜ë¥¼ 12í”½ì…€ ìœ„ë¡œ ì¡°ì •
                                k.z(1),
                                "ball",
                                "kickable",
                                {
                                    objectType: "ball",
                                    lastKickTime: 0,
                                    isMoving: false,
                                },
                            ]);

                            ball.onCollideUpdate("player", (player) => {
                                if (!ball.isMoving) {
                                    kickBallOnCollision(k, ball, player);
                                }
                            });
                            
                            console.log("âš½ í”¼êµ¬ê³µ ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:", ball.pos);
                            return;
                        }

                        // cat1, cat2 ì²˜ë¦¬
                        if (objectType === "cat1" || objectType === "cat2") {
                            console.log(`ğŸ± ${objectType} ê°ì§€ë¨!`);
                            
                            // ê¸°ì¡´ objectEntity ì œê±°
                            objectEntity.destroy();
                            
                            // ìƒˆë¡œìš´ cat ì—”í‹°í‹° ìƒì„±
                            const cat = map.add([
                                k.sprite("main-assets", {
                                    frame: objectType === "cat1" ? 3784 : 3783, // main.jsì— ì •ì˜ëœ cat ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                                }),
                                k.area(),
                                k.body({ isStatic: true }),
                                k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0) - 12), // Y ìœ„ì¹˜ë¥¼ 12í”½ì…€ ìœ„ë¡œ ì¡°ì •
                                k.z(1),
                                objectType,
                                "interactive-object",
                                { objectType },
                            ]);

                            cat.onCollideUpdate("player", (player) => {
                                const locale = gameState.getLocale();
                                const content = dialogues[locale]?.[objectType] || [
                                    "Meow~",
                                    "ì•¼ì˜¹~",
                                ];

                                const speakerName =
                                    dialogues.names[locale]?.[objectType] ||
                                    (objectType === "cat1" ? "Cat" : "Another Cat");

                                gameState.setInteractableObject(
                                    cat,
                                    "npc",
                                    {
                                        content: content,
                                        speakerName: speakerName,
                                        speakerImage: null,
                                    }
                                );
                            });

                            cat.onCollideEnd("player", () => {
                                gameState.clearInteractableObject();
                            });
                            
                            console.log(`ğŸ± ${objectType} ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:`, cat.pos);
                            return;
                        }

                        // nca ì²˜ë¦¬
                        if (objectType === "nca") {
                            console.log("ğŸ“„ NCA ì „ë‹¨ì§€ ê°ì§€ë¨!");
                            
                            // ê¸°ì¡´ objectEntity ì œê±°
                            objectEntity.destroy();
                            
                            // ìƒˆë¡œìš´ nca ì—”í‹°í‹° ìƒì„±
                            const nca = map.add([
                                k.sprite("main-assets", {
                                    frame: 5386, // main.jsì— ì •ì˜ëœ nca ìŠ¤í”„ë¼ì´íŠ¸ ë²ˆí˜¸ ì‚¬ìš©
                                }),
                                k.area(),
                                k.body({ isStatic: true }),
                                k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0) - 12), // Y ìœ„ì¹˜ë¥¼ 12í”½ì…€ ìœ„ë¡œ ì¡°ì •
                                k.z(1),
                                objectType,
                                "interactive-object",
                                { objectType },
                            ]);

                            nca.onCollideUpdate("player", (player) => {
                                const locale = gameState.getLocale();
                                const content = objectDialogues[locale]?.[objectType] || [
                                    "NCA recruitment flyer.",
                                    "NCA ëª¨ì§‘ ì „ë‹¨ì§€ì…ë‹ˆë‹¤.",
                                ];

                                const speakerName =
                                    objectDialogues.names[locale]?.[objectType] ||
                                    "NCA Flyer";

                                gameState.setInteractableObject(
                                    nca,
                                    "object",
                                    {
                                        content: content,
                                        speakerName: speakerName,
                                        speakerImage: null,
                                    }
                                );
                            });

                            nca.onCollideEnd("player", () => {
                                gameState.clearInteractableObject();
                            });
                            
                            console.log("ğŸ“„ NCA ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:", nca.pos);
                            return;
                        }

                        // ìƒí˜¸ì‘ìš© ê°€ëŠ¥í•œ ê°ì²´ë¡œ ì„¤ì •
                        const locale = gameState.getLocale();
                        const content = frontObjectDialogues[locale]?.[
                            objectType
                        ] || [
                            `This is ${objectType}`,
                            `ì´ê²ƒì€ ${objectType}ì…ë‹ˆë‹¤`,
                        ];

                        const speakerName =
                            frontObjectDialogues.names[locale]?.[objectType] ||
                            objectType;

                        gameState.setInteractableObject(
                            objectEntity,
                            "object",
                            {
                                content: content,
                                speakerName: speakerName,
                                speakerImage: null,
                            }
                        );
                    });

                    objectEntity.onCollideEnd("player", (player) => {
                        if (objectType !== "main_entrance" && objectType !== "front_gate") {
                            gameState.clearInteractableObject();
                        }
                    });

                    if (objectType.startsWith("car")) {
                        entities.cars.push(objectEntity);
                    } else {
                        entities.objects.push(objectEntity);
                    }
                }
            }

            // drawBoundaries ëŒ€ì‹  front.jsonì— ë§ëŠ” ì»¤ìŠ¤í…€ boundary ì²˜ë¦¬
            for (const object of layer.objects) {
                // ì´ë¯¸ ì²˜ë¦¬í•œ íŠ¹ë³„í•œ ì˜¤ë¸Œì íŠ¸ë“¤ì€ ì œì™¸
                if ([
                    "car1", "car2", "car3", "car4", 
                    "pot", "guryeong", "sink",
                    "goal_post1", "goal_post2", "line_machine", 
                    "badminton", "main_entrance", "front_gate",
                    "ball", "cat1", "cat2", "nca", "badminton",
                    "director", "facil"
                ].includes(object.name)) {
                    continue;
                }

                // ì¼ë°˜ ê²½ê³„ì„  ì²˜ë¦¬ (ì´ë¦„ì´ ì—†ëŠ” ë²½ë“¤)
                const tag = object.name !== "" ? object.name : object.type || "wall";
                
                console.log(`ğŸ§± ì¼ë°˜ ê²½ê³„ì„  ìƒì„±: ${tag} at (${object.x}, ${object.y}) size: ${object.width}x${object.height}`);
                
                const collider = map.add([
                    k.rect(object.width, object.height),
                    k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0)), // front.jsonì— ë§ëŠ” offset ì ìš©
                    k.area(),
                    k.body({ isStatic: true }),
                    k.opacity(0), // íˆ¬ëª…í•˜ê²Œ ì„¤ì •
                    tag,
                ]);
            }
            continue;
        }

        if (layer.name === "spawnpoints") {
            console.log("ğŸ¯ Spawnpoints ë ˆì´ì–´ ë°œê²¬:", layer);
            // spawnpoints ë ˆì´ì–´ê°€ ìˆì§€ë§Œ objectsê°€ ìˆëŠ”ì§€ í™•ì¸
            if (layer.objects && layer.objects.length > 0) {
                console.log("ğŸ“ ìŠ¤í°í¬ì¸íŠ¸ ì˜¤ë¸Œì íŠ¸ë“¤:", layer.objects);
                for (const object of layer.objects) {
                    console.log(`ğŸ² ë°œê²¬ëœ ì˜¤ë¸Œì íŠ¸: ${object.name} at (${object.x}, ${object.y})`);
                    
                    // í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸ ì²˜ë¦¬ - ì¤‘ë³µ ìƒì„± ë°©ì§€
                    if (!entities.player) {
                        // garageì—ì„œ ëŒì•„ì˜¨ ê²½ìš° - player_garage ìœ„ì¹˜ ì‚¬ìš© (ìš°ì„ ìˆœìœ„ ìµœê³ )
                        if (
                            object.name === "player_garage" &&
                            previousScene === "garage"
                        ) {
                            console.log("ğŸš— garageì—ì„œ ëŒì•„ì˜¨ í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸ ì‚¬ìš©:", object);
                            entities.player = map.add(
                                generateFrontPlayerComponents(k, k.vec2(object.x, object.y))
                            );
                            continue;
                        }

                        // schoolfrontì—ì„œ ëŒì•„ì˜¨ ê²½ìš° - player2 ìœ„ì¹˜ ì‚¬ìš©
                    if (
                        object.name === "player2" &&
                        previousScene === "schoolfront"
                    ) {
                        console.log("ğŸšª í•™êµì—ì„œ ëŒì•„ì˜¨ í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸ ì‚¬ìš©:", object);
                        entities.player = map.add(
                            generateFrontPlayerComponents(k, k.vec2(object.x, object.y))
                        );
                        continue;
                    }

                    // firstì—ì„œ ëŒì•„ì˜¨ ê²½ìš° - player2 ìœ„ì¹˜ ì‚¬ìš©
                    if (
                        object.name === "player2" &&
                        previousScene === "first"
                    ) {
                        console.log("ğŸšª 1ì¸µì—ì„œ ëŒì•„ì˜¨ í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸ ì‚¬ìš©:", object);
                        entities.player = map.add(
                            generateFrontPlayerComponents(k, k.vec2(object.x, object.y))
                        );
                        continue;
                    }

                        // ê¸°ë³¸ í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸
                        if (object.name === "player") {
                            console.log("ğŸ® ê¸°ë³¸ í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸ ë°œê²¬:", object);
                        entities.player = map.add(
                            generateFrontPlayerComponents(k, k.vec2(object.x, object.y))
                        );
                        continue;
                        }
                    }

                    // NPCë“¤ ì²˜ë¦¬ - directorì™€ facilì€ ì´ì œ boundaries ë ˆì´ì–´ì—ì„œ ì²˜ë¦¬ë¨
                    // if (object.name === "director") {
                    //     console.log("ğŸ‘¨â€ğŸ« í•™ë…„ë¶€ì¥ ì„ ìƒë‹˜ ê°ì§€ë¨! (spawnpoints ë ˆì´ì–´)");
                    //     const locale = gameState.getLocale();
                    //     const content = dialogues[locale]?.["director"] || [
                    //         "Hello, I'm the grade director.",
                    //         "ì•ˆë…•í•˜ì„¸ìš”, í•™ë…„ë¶€ì¥ì…ë‹ˆë‹¤.",
                    //     ];

                    //     const speakerName =
                    //         dialogues.names[locale]?.["director"] ||
                    //         "Grade Director";

                    //     const directorEntity = map.add([
                    //         k.area({
                    //             shape: new k.Rect(k.vec2(0, 2), 16.8, 42), // ë„ˆë¹„ 5% ì¦ê°€ (16 * 1.05 = 16.8)
                    //         }),
                    //         k.body({ isStatic: true }),
                    //         k.pos(object.x - 2, object.y - 20), // Y ì¢Œí‘œë¥¼ 10ë§Œí¼ ìœ„ë¡œ ì´ë™
                    //         k.z(-1), // ìºë¦­í„°ë³´ë‹¤ ë’¤ì— ë°°ì¹˜ (invisible collision box)
                    //         "director",
                    //         "interactive-object",
                    //         { objectType: "director" },
                    //     ]);

                    //     directorEntity.onCollideUpdate("player", (player) => {
                    //         gameState.setInteractableObject(
                    //             directorEntity,
                    //             "npc",
                    //             {
                    //                 content: content,
                    //                 speakerName: speakerName,
                    //                 speakerImage: null,
                    //             }
                    //         );
                    //     });

                    //     directorEntity.onCollideEnd("player", () => {
                    //         gameState.clearInteractableObject();
                    //     });

                    //     entities.objects.push(directorEntity);
                    //     continue;
                    // }

                    // if (object.name === "facil") {
                    //     console.log("ğŸ‘¨â€ğŸ’¼ êµê° ì„ ìƒë‹˜ ê°ì§€ë¨! (spawnpoints ë ˆì´ì–´)");
                    //     const locale = gameState.getLocale();
                    //     const content = dialogues[locale]?.["facil"] || [
                    //         "Hello! I'm the vice principal.",
                    //         "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” êµê°ì…ë‹ˆë‹¤.",
                    //     ];

                    //     const speakerName =
                    //         dialogues.names[locale]?.["facil"] ||
                    //         "Vice Principal";

                    //     const facilEntity = map.add([
                    //         k.area({
                    //             shape: new k.Rect(k.vec2(0, 2), 16.8, 42), // ë„ˆë¹„ 5% ì¦ê°€ (16 * 1.05 = 16.8)
                    //         }),
                    //         k.body({ isStatic: true }),
                    //         k.pos(object.x - 2, object.y - 20), // Y ì¢Œí‘œë¥¼ 10ë§Œí¼ ìœ„ë¡œ ì´ë™
                    //         k.z(-1), // ìºë¦­í„°ë³´ë‹¤ ë’¤ì— ë°°ì¹˜ (invisible collision box)
                    //         "facil",
                    //         "interactive-object",
                    //         { objectType: "facil" },
                    //     ]);

                    //     facilEntity.onCollideEnd("player", () => {
                    //         gameState.clearInteractableObject();
                    //     });

                    //     entities.objects.push(facilEntity);
                    //     continue;
                    // }

                    // NPCë“¤ ì²˜ë¦¬ - directorì™€ facilì€ ì´ì œ spawnpointsì—ì„œ ì²˜ë¦¬
                    // if (object.name === "director") {
                    //     const director = map.add([
                    //         k.sprite("main-assets", {
                    //             anim: "director",
                    //         }),
                    //         k.area(),
                    //         k.body({ isStatic: true }),
                    //         k.pos(object.x, object.y),
                    //         k.z(1),
                    //         "director",
                    //         { npcType: "director" },
                    //     ]);

                    //     director.onCollideUpdate("player", (player) => {
                    //         const locale = gameState.getLocale();
                    //         const content = npcDialogues[locale]?.["director"] || [
                    //             "Hello! I'm the director of this school.",
                    //             "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì´ í•™êµì˜ êµì¥ì…ë‹ˆë‹¤.",
                    //         ];

                    //         const speakerName =
                    //             npcDialogues.names[locale]?.["director"] ||
                    //             "Director";

                    //         gameState.setInteractableObject(director, "npc", {
                    //             content: content,
                    //             speakerName: speakerName,
                    //             speakerImage: null,
                    //         });
                    //     });

                    //     director.onCollideEnd("player", (player) => {
                    //         gameState.clearInteractableObject();
                    //     });
                    //     continue;
                    // }

                    // cat1, cat2 ì²˜ë¦¬ (spawnpoints ë ˆì´ì–´ì—ì„œ)
                    if (object.name === "cat1" || object.name === "cat2") {
                        console.log(`ğŸ± ${object.name} ê°ì§€ë¨! (spawnpoints ë ˆì´ì–´)`);
                        
                        const objectType = object.name;
                        const cat = map.add([
                            k.sprite("main-assets", {
                                frame: objectType === "cat1" ? 3784 : 3783, // main.jsì— ì •ì˜ëœ cat ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                            }),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            objectType,
                            "interactive-object",
                            { objectType },
                        ]);

                        cat.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = dialogues[locale]?.[objectType] || [
                                "Meow~",
                                "ì•¼ì˜¹~",
                            ];

                            const speakerName =
                                dialogues.names[locale]?.[objectType] ||
                                (objectType === "cat1" ? "Cat" : "Another Cat");

                            gameState.setInteractableObject(
                                cat,
                                "npc",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                        });

                        cat.onCollideEnd("player", () => {
                            gameState.clearInteractableObject();
                        });
                        
                        console.log(`ğŸ± ${objectType} ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:`, cat.pos);
                        continue;
                    }

                    // ball ì²˜ë¦¬ (spawnpoints ë ˆì´ì–´ì—ì„œ)
                    if (object.name === "ball") {
                        console.log("âš½ í”¼êµ¬ê³µ ê°ì§€ë¨! (spawnpoints ë ˆì´ì–´)");
                        
                        const ball = map.add([
                            k.sprite("main-assets", {
                                frame: 5296, // main.jsì— ì •ì˜ëœ ball ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                            }),
                            k.area({
                                shape: new k.Rect(k.vec2(0), 24, 24),
                            }),
                            k.body({
                                isStatic: true,
                                mass: 1,
                                restitution: 0.6,
                            }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            "ball",
                            "kickable",
                            {
                                objectType: "ball",
                                lastKickTime: 0,
                                isMoving: false,
                            },
                        ]);

                        ball.onCollideUpdate("player", (player) => {
                            if (!ball.isMoving) {
                                kickBallOnCollision(k, ball, player);
                            }
                        });
                        
                        console.log("âš½ í”¼êµ¬ê³µ ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:", ball.pos);
                        continue;
                    }

                    // nca ì²˜ë¦¬ (spawnpoints ë ˆì´ì–´ì—ì„œ)
                    if (object.name === "nca") {
                        console.log("ğŸ“„ NCA ì „ë‹¨ì§€ ê°ì§€ë¨! (spawnpoints ë ˆì´ì–´)");
                        
                        const nca = map.add([
                            k.sprite("main-assets", {
                                frame: 5386, // main.jsì— ì •ì˜ëœ nca ìŠ¤í”„ë¼ì´íŠ¸ ë²ˆí˜¸ ì‚¬ìš©
                            }),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            "nca",
                            "interactive-object",
                            { objectType: "nca" },
                        ]);

                        nca.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = objectDialogues[locale]?.["nca"] || [
                                "NCA recruitment flyer.",
                                "NCA ëª¨ì§‘ ì „ë‹¨ì§€ì…ë‹ˆë‹¤.",
                            ];

                            const speakerName =
                                objectDialogues.names[locale]?.["nca"] ||
                                "NCA Flyer";

                            gameState.setInteractableObject(
                                nca,
                                "object",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                        });

                        nca.onCollideEnd("player", () => {
                            gameState.clearInteractableObject();
                        });
                        
                        console.log("ğŸ“„ NCA ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:", nca.pos);
                        continue;
                    }

                    // í¸ì§€ ì˜¤ë¸Œì íŠ¸ ì²˜ë¦¬
                    if (object.name.startsWith("letter")) {
                        const letterType = object.name;
                        const letter = map.add([
                            k.sprite("main-assets", {
                                anim: letterType,
                            }),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            "letter",
                            { letterType },
                        ]);

                        letter.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = objectDialogues[locale]?.[
                                letterType
                            ] || [
                                `This is ${letterType}`,
                                `ì´ê²ƒì€ ${letterType}ì…ë‹ˆë‹¤`,
                            ];

                            const speakerName =
                                objectDialogues.names[locale]?.[letterType] ||
                                letterType;

                            gameState.setInteractableObject(letter, "letter", {
                                content: content,
                                speakerName: speakerName,
                                speakerImage: null,
                            });
                        });

                        letter.onCollideEnd("player", (player) => {
                            gameState.clearInteractableObject();
                        });
                        continue;
                    }

                    // Student NPC ì²˜ë¦¬
                    if (object.name.startsWith("student")) {
                        const studentType = object.name;
                        const student = map.add([
                            k.sprite("main-assets", {
                                anim: studentType,
                            }),
                            k.area({
                                shape: new k.Rect(k.vec2(0, -10), 16, 24), // Y ì˜¤í”„ì…‹ -8ë¡œ ì½œë¼ì´ë”ë¥¼ ìœ„ë¡œ ì´ë™
                            }),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            "student",
                            { studentType },
                        ]);

                        student.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = frontDialogues[locale]?.[studentType] || [
                                `Hello! I'm ${studentType}.`,
                                `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ${studentType}ì…ë‹ˆë‹¤.`,
                            ];

                            const speakerName =
                                frontDialogues.names[locale]?.[studentType] ||
                                studentType;

                            gameState.setInteractableObject(student, "student", {
                                content: content,
                                speakerName: speakerName,
                                speakerImage: null,
                                onDialogStart: () => {
                                    // ëŒ€í™” ì‹œì‘ ì‹œ í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì²´í¬
                                    console.log(`[DEBUG] ${studentType}ê³¼ ëŒ€í™” ì‹œì‘ - í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì²´í¬`);
                                    console.log(`[DEBUG] í˜„ì¬ studentType: ${studentType}`);
                                    completeQuestByTarget("npc", studentType);
                                }
                            });
                        });

                        student.onCollideEnd("player", (player) => {
                            gameState.clearInteractableObject();
                        });
                        continue;
                    }
                }
            } else {
                console.log("âš ï¸ Spawnpoints ë ˆì´ì–´ëŠ” ìˆì§€ë§Œ ì˜¤ë¸Œì íŠ¸ê°€ ì—†ìŒ");
            }
            continue;
        }

        // Handle regular tile layers with chunks system (infinite maps)
        if (layer.chunks) {
            console.log(`ğŸ§© Processing chunks for layer: ${layer.name}`, layer.chunks.length);
            // Infinite ë§µì˜ chunks ì²˜ë¦¬
            for (const chunk of layer.chunks) {
                console.log(`ğŸ“¦ Processing chunk at (${chunk.x}, ${chunk.y}) size: ${chunk.width}x${chunk.height}`);
                let tileIndex = 0;
                let tilesAdded = 0;
                for (let y = 0; y < chunk.height; y++) {
                    for (let x = 0; x < chunk.width; x++) {
                        const tile = chunk.data[tileIndex];
                        tileIndex++;

                        if (tile === 0) continue;

                        // chunkì˜ ì ˆëŒ€ ìœ„ì¹˜ ê³„ì‚°
                        const tileX = (chunk.x + x) * mapData.tilewidth;
                        const tileY = (chunk.y + y) * mapData.tileheight;

                        // upmost ë ˆì´ì–´ëŠ” ìºë¦­í„°ë³´ë‹¤ ìœ„ì— ë°°ì¹˜ (z=3), cha ë ˆì´ì–´ëŠ” ìºë¦­í„°ì™€ ê°™ì€ ë ˆë²¨ (z=1), ë‹¤ë¥¸ íƒ€ì¼ì€ ê¸°ë³¸ (z=0)
                        const zIndex = layer.name === "upmost" ? 3 : layer.name === "cha" ? 1 : 0;

                        // front.jsonì€ rpg_spritesheet_front.pngë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ main-assets ìŠ¤í”„ë¼ì´íŠ¸ ì‚¬ìš©
                        map.add([
                            k.sprite("main-assets", { frame: tile - 1 }),
                            k.pos(tileX, tileY),
                            k.z(zIndex),
                            // k.offscreen(), // ì œê±°í•˜ì—¬ ëª¨ë“  íƒ€ì¼ì´ ë³´ì´ë„ë¡ í•¨
                        ]);
                        tilesAdded++;
                    }
                }
                console.log(`âœ… Layer ${layer.name} chunk: ${tilesAdded} tiles added`);
            }
            continue;
        }

        // Handle regular tile layers (non-infinite maps)
        if (layer.data) {
            console.log(`ğŸ¨ Processing regular tile layer: ${layer.name}, tiles: ${layer.data.length}`);
            let nbOfDrawnTiles = 0;
            let tilesAdded = 0;
            const tilePos = k.vec2(0, 0);
            for (const tile of layer.data) {
                if (nbOfDrawnTiles % layer.width === 0) {
                    tilePos.x = 0;
                    tilePos.y += mapData.tileheight;
                } else {
                    tilePos.x += mapData.tilewidth;
                }

                nbOfDrawnTiles++;

                if (tile === 0) continue;

                // upmost ë ˆì´ì–´ëŠ” ìºë¦­í„°ë³´ë‹¤ ìœ„ì— ë°°ì¹˜ (z=3), cha ë ˆì´ì–´ëŠ” ìºë¦­í„°ì™€ ê°™ì€ ë ˆë²¨ (z=1), ë‹¤ë¥¸ íƒ€ì¼ì€ ê¸°ë³¸ (z=0)
                const zIndex = layer.name === "upmost" ? 3 : layer.name === "cha" ? 1 : 0;

                // front.jsonì€ rpg_spritesheet_front.pngë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ main-assets ìŠ¤í”„ë¼ì´íŠ¸ ì‚¬ìš©
                map.add([
                    k.sprite("main-assets", { frame: tile - 1 }),
                    k.pos(tilePos),
                    k.z(zIndex),
                    // k.offscreen(), // ì œê±°í•˜ì—¬ ëª¨ë“  íƒ€ì¼ì´ ë³´ì´ë„ë¡ í•¨
                ]);
                tilesAdded++;
            }
            console.log(`âœ… Layer ${layer.name}: ${tilesAdded} tiles added out of ${layer.data.length} total`);
            continue;
        }
    }

    // ëª¨ë“  ë ˆì´ì–´ ì²˜ë¦¬ í›„ í”Œë ˆì´ì–´ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê¸°ë³¸ ìœ„ì¹˜ì— ìƒì„±
    if (!entities.player) {
        console.log("ğŸ® í”Œë ˆì´ì–´ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ, ê¸°ë³¸ ìœ„ì¹˜ì— ìƒì„±");
        entities.player = map.add(
            generateFrontPlayerComponents(k, k.vec2(0, 0))
        );
    } else {
        console.log("ğŸ® í”Œë ˆì´ì–´ ìƒì„± ì™„ë£Œ:", entities.player.pos);
        
        // ì²« ë²ˆì§¸ ì €ì¥ ë°ì´í„° ìƒì„± (í”Œë ˆì´ì–´ê°€ front ì”¬ì— ì§„ì…í–ˆì„ ë•Œ)
        try {
            const playerName = gameState.playerName || "í”Œë ˆì´ì–´";
            const existingSaves = gameDataManager.getSaveList();
            
            // ì´ë¯¸ front ì”¬ ì €ì¥ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            const hasFrontSave = existingSaves.some(save => 
                save.gameState && save.gameState.currentScene === "front"
            );
            
            if (!hasFrontSave && playerName !== "í”Œë ˆì´ì–´") {
                // ì´ˆê¸° ì €ì¥ ë°ì´í„° ìƒì„±
                const initialSaveData = gameDataManager.createSaveData(playerName);
                initialSaveData.gameState.currentScene = "front";
                initialSaveData.gameState.playerPosition = {
                    x: entities.player.pos.x,
                    y: entities.player.pos.y
                };
                initialSaveData.progressState.visitedScenes = ["prologue", "front"];
                
                // ì €ì¥
                gameDataManager.saveToBrowser(initialSaveData);
                console.log("ğŸ’¾ ì´ˆê¸° ì €ì¥ ë°ì´í„° ìƒì„± ì™„ë£Œ:", initialSaveData.id);
            }
            
            // ì¶”ê°€: í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° ìƒì„± (í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸ ê¸°ì¤€)
            createFrontTestDummyData();
            
        } catch (error) {
            console.error("âŒ ì €ì¥ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜:", error);
        }
    }

    // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° ìƒì„± í•¨ìˆ˜ (front.js ìŠ¤í°í¬ì¸íŠ¸ ê¸°ì¤€)
    function createFrontTestDummyData() {
        try {
            const existingSaves = gameDataManager.getSaveList();
            const testSaveExists = existingSaves.some(save => save.playerName === "í…ŒìŠ¤íŠ¸2");
            
            if (!testSaveExists && entities.player) {
                console.log("ğŸ¯ front.js í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° ìƒì„±");
                
                const currentPos = entities.player.pos;
                const dummyData = gameDataManager.createSaveData("í…ŒìŠ¤íŠ¸2");
                dummyData.gameState = {
                    currentScene: "front",
                    playerPosition: {
                        x: currentPos.x,
                        y: currentPos.y
                    },
                    playerDirection: "down",
                    health: 100,
                    inventory: [],
                    questsCompleted: [],
                    questsInProgress: [],
                    flags: {},
                    tutorialCompleted: true,
                    prologueCompleted: true,
                    introCompleted: true
                };
                
                // í˜„ì¬ ì‹œê°ìœ¼ë¡œ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
                dummyData.timestamp = new Date().toISOString();
                dummyData.lastPlayed = new Date().toISOString();
                
                gameDataManager.saveToBrowser(dummyData); // saveData â†’ saveToBrowser ìˆ˜ì •
                console.log("âœ… front.js í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° ìƒì„± ì™„ë£Œ:", dummyData);
            }
        } catch (error) {
            console.error("âŒ front.js ë”ë¯¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨:", error);
        }
    }

    // [DEBUG] í”Œë ˆì´ì–´ ì—”í‹°í‹° ìˆ˜ í™•ì¸
    const playerEntities = k.get("player");
    console.log(`[DEBUG] í˜„ì¬ í”Œë ˆì´ì–´ ì—”í‹°í‹° ìˆ˜: ${playerEntities.length}`);
    if (playerEntities.length > 1) {
        console.error(`âš ï¸ í”Œë ˆì´ì–´ê°€ ì¤‘ë³µ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ${playerEntities.length}ê°œ ë°œê²¬`);
        // ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì œê±°
        for (let i = 1; i < playerEntities.length; i++) {
            console.log(`[DEBUG] ì¤‘ë³µ í”Œë ˆì´ì–´ ${i} ì œê±° ì¤‘...`);
            playerEntities[i].destroy();
        }
    }

    // í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ì„ ì¦‰ì‹œ í™œì„±í™” (ì¹´ë©”ë¼ ì• ë‹ˆë©”ì´ì…˜ê³¼ ë…ë¦½ì ìœ¼ë¡œ)
    if (entities.player && entities.player.exists()) {
        console.log("ğŸ® í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ì¦‰ì‹œ í™œì„±í™”");
        setPlayerControls(k, entities.player);
    }

    // í”Œë ˆì´ì–´ ì¡´ì¬ í™•ì¸ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    if (entities.player && entities.player.exists()) {
        // front ì”¬ì—ì„œëŠ” main_entranceë¥¼ í†µí•´ firstë¡œ ì´ë™
        entities.player.onCollide("main_entrance", () => {
            gameState.setPreviousScene("front");
            k.go("first");
        });
        
        // garageë¡œ ì´ë™í•˜ëŠ” ë¬¸ ì¶”ê°€
        entities.player.onCollide("door_garage", () => {
            console.log("ğŸš— Garage ë¬¸ì— ì¶©ëŒ - garage ì”¬ìœ¼ë¡œ ì´ë™");
            k.play("boop-sfx"); // ë¬¸ ì—´ë¦¬ëŠ” íš¨ê³¼ìŒ (boop-sfx ì‚¬ìš©)
            gameState.setPreviousScene("front");
            k.go("garage");
        });
    }

    // ë§µ í¬ê¸° ê³„ì‚° (ì¹´ë©”ë¼ ì• ë‹ˆë©”ì´ì…˜ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë¯¸ë¦¬ ì •ì˜)
    const mapBounds = {
        minX: -48 * 24, // ê°€ì¥ ì™¼ìª½ chunk x * tilewidth
        minY: -48 * 24, // ê°€ì¥ ìœ„ìª½ chunk y * tileheight  
        maxX: (30 + 16) * 24, // ë§µ ë„ˆë¹„ë¥¼ ê³ ë ¤í•œ ìµœëŒ€ X
        maxY: (20 + 16) * 24, // ë§µ ë†’ì´ë¥¼ ê³ ë ¤í•œ ìµœëŒ€ Y
    };

    console.log("ğŸ—ºï¸ ë§µ ê²½ê³„:", mapBounds);

    // ì´ì „ ì”¬ì´ tutorialì¼ ë•Œë§Œ íŠ¹ë³„í•œ ì¹´ë©”ë¼ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
    console.log("ğŸ” ì¹´ë©”ë¼ ì• ë‹ˆë©”ì´ì…˜ ì¡°ê±´ í™•ì¸ - previousScene:", previousScene, "=== 'tutorial':", previousScene === "tutorial");
    if (previousScene === "tutorial") {
        console.log("ğŸ¬ Tutorialì—ì„œ ì§„ì… - ì¹´ë©”ë¼ ìˆ˜ì§ ì´ë™ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘");
        k.camScale(2); // ì¼ë°˜ ìŠ¤ì¼€ì¼ë¡œ ì‹œì‘

        // í”Œë ˆì´ì–´ ìœ„ì¹˜ì—ì„œ ì‹œì‘
        if (entities.player && entities.player.exists()) {
            const playerPos = entities.player.pos;
            k.camPos(playerPos);
            
            // ì¹´ë©”ë¼ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì—ëŠ” í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ì¼ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”
            gameState.setFreezePlayer(true);
            
            // ë§µ ìƒë‹¨ ìœ„ì¹˜ ê³„ì‚° (500í”½ì…€ ìœ„ë¡œ)
            const mapTopY = playerPos.y - 600; // í”Œë ˆì´ì–´ ìœ„ì¹˜ì—ì„œ 600í”½ì…€ ìœ„ë¡œ
            const topPosition = k.vec2(playerPos.x, mapTopY);
            
            console.log("ğŸ“¹ ì¹´ë©”ë¼ê°€ ìœ„ë¡œ ì´ë™í•©ë‹ˆë‹¤:", playerPos, "â†’", topPosition);
            
            // 1ë‹¨ê³„: ìœ„ë¡œ ì²œì²œíˆ ì˜¬ë¼ê°€ê¸° (5ì´ˆë¡œ ì¦ê°€)
            k.tween(k.camPos(), topPosition, 5.0, (val) => {
                k.camPos(val);
            }, k.easings.easeInOutQuad).then(() => {
                console.log("ğŸ“¹ ì¹´ë©”ë¼ê°€ ìœ„ì— ë„ë‹¬, 2ì´ˆ ëŒ€ê¸° í›„ ë‹¤ì‹œ ë‚´ë ¤ê°‘ë‹ˆë‹¤");
                
                // 2ë‹¨ê³„: 2ì´ˆ ëŒ€ê¸° í›„ í”Œë ˆì´ì–´ ìœ„ì¹˜ë¡œ ë‹¤ì‹œ ë‚´ë ¤ì˜¤ê¸° (4ì´ˆë¡œ ì¦ê°€)
                k.wait(2, () => {
                    k.tween(k.camPos(), playerPos, 4.0, (val) => {
                        k.camPos(val);
                    }, k.easings.easeInOutQuad).then(() => {
                        // ì¹´ë©”ë¼ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ í”Œë ˆì´ì–´ ëŒ€í™” í‘œì‹œ
                        console.log("ğŸ® ì¹´ë©”ë¼ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ - í”Œë ˆì´ì–´ ëŒ€í™” ì‹œì‘");
                        
                        // í”Œë ˆì´ì–´ ì´ë¦„ ìš°ì„ ìˆœìœ„: ì…ë ¥ë°›ì€ ì´ë¦„ â†’ ë¡œê·¸ ì €ì¥ëœ ì´ë¦„ â†’ ê¸°ë³¸ê°’ "í”Œë ˆì´ì–´"
                        let playerName = gameState.playerName;
                        if (!playerName || playerName.trim() === "") {
                            // gameStateì— ì—†ìœ¼ë©´ ìë™ ë¡œë“œ ì‹œë„
                            console.log("ğŸ” í”Œë ˆì´ì–´ ì´ë¦„ì´ ì—†ì–´ ìë™ ë¡œë“œ ì‹œë„");
                            playerName = "í”Œë ˆì´ì–´"; // ìµœì¢… ê¸°ë³¸ê°’
                        }
                        console.log("ğŸ­ í”Œë ˆì´ì–´ ëŒ€í™” í™”ì:", playerName);
                        
                        // í”Œë ˆì´ì–´ ëŒ€í™” ë‚´ìš© (prologueì—ì„œ ì´ì–´ì§€ëŠ” ë‚´ìš©)
                        const playerDialogue = [
                            "í›„... ë“œë””ì–´ í•™êµì— ë„ì°©í–ˆë‹¤.",
                            "ì•„ê¹Œ ê·¸ ëª©ì†Œë¦¬ëŠ” ë­ì˜€ì„ê¹Œ... ê¿ˆì´ì—ˆë‚˜?",
                            "ì•„ë¬´íŠ¼ ì—¬ê¸°ê°€ ìš°ë¦¬ í•™êµêµ¬ë‚˜. ìƒê°ë³´ë‹¤ í¬ë„¤.",
                            "ìƒˆë¡œìš´ í•™êµ... ì–´ë””ë¶€í„° ë‘˜ëŸ¬ë´ì•¼ í• ê¹Œ?",
                            "ìš°ì¸¡ ìƒë‹¨ì— í¸ì§€ ì•„ì´ì½˜ì„ í´ë¦­í•´ë³´ì!",
                        ];
                        
                        // ëŒ€í™”ì°½ í‘œì‹œ (NPC ëŒ€í™”ì°½ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
                        dialog(
                            k,
                            k.vec2(250, 500), // NPC ëŒ€í™”ì°½ê³¼ ë™ì¼í•œ ìœ„ì¹˜
                            playerDialogue,
                            {
                                font: "galmuri", // í•œêµ­ì–´ í°íŠ¸
                                speakerName: playerName, // í”Œë ˆì´ì–´ ì´ë¦„ì„ í™”ìë¡œ í‘œì‹œ
                                speakerImage: null, // í”Œë ˆì´ì–´ ì´ë¯¸ì§€ëŠ” ì—†ìŒ
                                onComplete: () => {
                                    // ëŒ€í™” ì™„ë£Œ í›„ í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ í™œì„±í™”
                                    console.log("ğŸ® í”Œë ˆì´ì–´ ëŒ€í™” ì™„ë£Œ - í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ì¬í™œì„±í™”");
                                    gameState.setFreezePlayer(false);
                                }
                            }
                        );
                    });
                });
            });
        }
    } else {
        console.log("ğŸ¬ ë‹¤ë¥¸ ì”¬ì—ì„œ ì§„ì… - ì¼ë°˜ ì¹´ë©”ë¼ ìŠ¤ì¼€ì¼ ì ìš©");
        // ë‹¤ë¥¸ ì”¬ì—ì„œ ì˜¬ ë•ŒëŠ” ë°”ë¡œ ì¼ë°˜ ìŠ¤ì¼€ì¼(2ë°°) ì ìš©
        k.camScale(2);
        
        // í”Œë ˆì´ì–´ ìœ„ì¹˜ë¡œ ì¹´ë©”ë¼ ì´ë™
        if (entities.player && entities.player.exists()) {
            k.camPos(entities.player.pos);
        }
    }

    // ì¹´ë©”ë¼ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
    if (entities.player && entities.player.exists()) {
        k.camPos(entities.player.pos);
    }

    // ê²½ê³„ ê¸°ë°˜ ì¹´ë©”ë¼ ì¶”ì  ì‹œìŠ¤í…œ
    const CAMERA_EDGE_BUFFER = 120; // í™”ë©´ ê°€ì¥ìë¦¬ 120px ë°˜ê²½
    const CAMERA_SMOOTH_FACTOR = 0.1; // ì¹´ë©”ë¼ ë¶€ë“œëŸ¬ì›€ ì •ë„ (0.1 = 10%ì”© ì´ë™)
    const CAMERA_MIN_DISTANCE = 8; // ìµœì†Œ ì´ë™ ê±°ë¦¬ (í”½ì…€)
    let targetCameraPos = k.camPos();
    let lastPlayerPos = entities.player ? entities.player.pos.clone() : k.vec2(0, 0);

    function updateCameraWithBoundaries() {
        if (!entities.player || !entities.player.exists()) return;

        const playerPos = entities.player.pos;
        const currentCamPos = k.camPos();
        const screenHalfWidth = k.width() / (2 * k.camScale().x);
        const screenHalfHeight = k.height() / (2 * k.camScale().y);
        
        // í”Œë ˆì´ì–´ê°€ ì‹¤ì œë¡œ ì´ë™í–ˆì„ ë•Œë§Œ ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸ ê³„ì‚°
        if (playerPos.dist(lastPlayerPos) < 1) return; // 1í”½ì…€ ì´í•˜ ì´ë™ì€ ë¬´ì‹œ
        
        // í”Œë ˆì´ì–´ê°€ í™”ë©´ ê°€ì¥ìë¦¬ ê·¼ì²˜ì— ìˆëŠ”ì§€ í™•ì¸
        const playerScreenPos = playerPos.sub(currentCamPos);
        
        let newTargetX = targetCameraPos.x;
        let newTargetY = targetCameraPos.y;
        let shouldUpdate = false;
        
        // Xì¶• ê²½ê³„ í™•ì¸ - ë°ë“œì¡´ì„ ë” í¬ê²Œ ì„¤ì •
        if (playerScreenPos.x > screenHalfWidth - CAMERA_EDGE_BUFFER) {
            newTargetX = playerPos.x - (screenHalfWidth - CAMERA_EDGE_BUFFER);
            shouldUpdate = true;
        } else if (playerScreenPos.x < -screenHalfWidth + CAMERA_EDGE_BUFFER) {
            newTargetX = playerPos.x + (screenHalfWidth - CAMERA_EDGE_BUFFER);
            shouldUpdate = true;
        }
        
        // Yì¶• ê²½ê³„ í™•ì¸ - ë°ë“œì¡´ì„ ë” í¬ê²Œ ì„¤ì •
        if (playerScreenPos.y > screenHalfHeight - CAMERA_EDGE_BUFFER) {
            newTargetY = playerPos.y - (screenHalfHeight - CAMERA_EDGE_BUFFER);
            shouldUpdate = true;
        } else if (playerScreenPos.y < -screenHalfHeight + CAMERA_EDGE_BUFFER) {
            newTargetY = playerPos.y + (screenHalfHeight - CAMERA_EDGE_BUFFER);
            shouldUpdate = true;
        }
        
        // íƒ€ê²Ÿ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        if (shouldUpdate) {
            // ë§µ ê²½ê³„ ë‚´ì—ì„œ ì¹´ë©”ë¼ ì œí•œ
            newTargetX = Math.max(mapBounds.minX + screenHalfWidth, 
                                 Math.min(mapBounds.maxX - screenHalfWidth, newTargetX));
            newTargetY = Math.max(mapBounds.minY + screenHalfHeight, 
                                 Math.min(mapBounds.maxY - screenHalfHeight, newTargetY));
            
            targetCameraPos = k.vec2(newTargetX, newTargetY);
        }
        
        // ë¶€ë“œëŸ¬ìš´ ì¹´ë©”ë¼ ì´ë™
        const distance = targetCameraPos.dist(currentCamPos);
        if (distance > CAMERA_MIN_DISTANCE) {
            const newCamPos = currentCamPos.lerp(targetCameraPos, CAMERA_SMOOTH_FACTOR);
            k.camPos(newCamPos);
        }
        
        lastPlayerPos = playerPos.clone();
    }

    // ë§¤ í”„ë ˆì„ë§ˆë‹¤ ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸
    k.onUpdate(updateCameraWithBoundaries);

    // UI ìš”ì†Œë“¤ ìˆ¨ê¹€ - front ì”¬ì—ì„œëŠ” UI ì—†ìŒ
    // healthBar(k);
    // watchPlayerHealth(k);

    let isLocaleLocked = { value: false };
    let isMuteLocked = { value: false };

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    k.onKeyPress("l", () => {
        toggleLocale(k, gameState, isLocaleLocked);
    });

    k.onKeyPress("ã…£", () => {
        toggleLocale(k, gameState, isLocaleLocked);
    });

    k.onKeyPress("m", () => {
        toggleMute(k, gameState, isMuteLocked);
    });

    k.onKeyPress("ã…¡", () => {
        toggleMute(k, gameState, isMuteLocked);
    });

    // ê²Œì„íŒ¨ë“œ ì»¨íŠ¸ë¡¤
    k.onGamepadButtonPress("lshoulder", () => {
        console.log("ğŸ® Lë²„íŠ¼ ëˆŒë¦¼ - ì–¸ì–´ ë³€ê²½");
        toggleLocale(k, gameState, isLocaleLocked);
    });

    k.onGamepadButtonPress("rshoulder", () => {
        console.log("ğŸ® Rë²„íŠ¼ ëˆŒë¦¼ - ìŒì†Œê±° í† ê¸€");
        toggleMute(k, gameState, isMuteLocked);
    });

    k.onGamepadButtonPress("ltrigger", () => {
        console.log("ğŸ® L2 íŠ¸ë¦¬ê±° ëˆŒë¦¼ - ì–¸ì–´ ë³€ê²½");
        toggleLocale(k, gameState, isLocaleLocked);
    });

    k.onGamepadButtonPress("rtrigger", () => {
        console.log("ğŸ® R2 íŠ¸ë¦¬ê±° ëˆŒë¦¼ - ìŒì†Œê±° í† ê¸€");
        toggleMute(k, gameState, isMuteLocked);
    });

    // 1ë²ˆ í‚¤ë¡œ ë©”ì¸ ë©”ë‰´ ì´ë™
    setupMainMenuShortcut(k, gameState);

    // ìƒí˜¸ì‘ìš© í‚¤ (ìŠ¤í˜ì´ìŠ¤, ì—”í„°) ê°ì§€ë¡œ í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì²´í¬
    k.onKeyPress("space", () => {
        const interactableData = gameState.getInteractableData();
        if (interactableData && interactableData.onDialogStart) {
            interactableData.onDialogStart();
        }
    });
    
    k.onKeyPress("enter", () => {
        const interactableData = gameState.getInteractableData();
        if (interactableData && interactableData.onDialogStart) {
            interactableData.onDialogStart();
        }
    });

    // í€˜ìŠ¤íŠ¸ UI ì¶”ê°€ ë° ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    questSystem = setupQuestUI(k, gameState);
    
    // ==============================
    // ì‹¤ì‹œê°„ ìë™ ì €ì¥ ì‹œìŠ¤í…œ (10ì´ˆë§ˆë‹¤)
    // ==============================
    
    let lastAutoSaveTime = Date.now();
    const AUTO_SAVE_INTERVAL = 10000; // 10ì´ˆ
    
    // ìë™ì €ì¥ ì•Œë¦¼ UI
    let autoSaveNotification = null;
    
    function showAutoSaveNotification() {
        // ê¸°ì¡´ ì•Œë¦¼ì´ ìˆë‹¤ë©´ ì œê±°
        if (autoSaveNotification) {
            k.destroy(autoSaveNotification);
        }
        
        // ìƒˆ ì•Œë¦¼ ìƒì„±
        autoSaveNotification = k.add([
            k.text("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", { 
                size: 14, // 8ì—ì„œ 14ë¡œ ë³€ê²½ (í¬ê¸° ì¦ê°€)
                font: "galmuri" 
            }),
            k.pos(10, 10), // ì¢Œì¸¡ ìƒë‹¨
            k.color(138, 43, 226), // ë³´ë¼ìƒ‰ìœ¼ë¡œ ë³€ê²½
            k.z(10000), // ìµœìƒìœ„ ë ˆì´ì–´
            k.fixed(),
            k.opacity(1)
        ]);
        
        // 3ì´ˆ í›„ í˜ì´ë“œ ì•„ì›ƒ
        k.wait(2, () => {
            if (autoSaveNotification) {
                k.tween(autoSaveNotification.opacity, 0, 1, (val) => {
                    if (autoSaveNotification) {
                        autoSaveNotification.opacity = val;
                    }
                }).then(() => {
                    if (autoSaveNotification) {
                        k.destroy(autoSaveNotification);
                        autoSaveNotification = null;
                    }
                });
            }
        });
    }
    
    function performAutoSave() {
        try {
            const playerName = gameState.playerName;
            if (!playerName || playerName.trim() === "" || playerName === "í”Œë ˆì´ì–´") {
                console.log("â° ìë™ì €ì¥ ê±´ë„ˆëœ€: ìœ íš¨í•œ í”Œë ˆì´ì–´ ì´ë¦„ ì—†ìŒ");
                return;
            }
            
            // í˜„ì¬ í”Œë ˆì´ì–´ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            const currentPosition = entities.player ? {
                x: Math.round(entities.player.pos.x),
                y: Math.round(entities.player.pos.y)
            } : { x: 0, y: 0 };
            
            // í˜„ì¬ ì €ì¥ ìŠ¬ë¡¯ì´ ìˆëŠ”ì§€ í™•ì¸
            let currentSaveSlot = gameDataManager.getCurrentSaveSlot();
            
            if (!currentSaveSlot) {
                // í”Œë ˆì´ì–´ ì´ë¦„ìœ¼ë¡œ ê¸°ì¡´ ì €ì¥ ë°ì´í„° ì°¾ê¸°
                const existingSaves = gameDataManager.getSaveList();
                const playerSave = existingSaves.find(save => save.playerName === playerName);
                
                if (playerSave) {
                    currentSaveSlot = playerSave.id;
                    gameDataManager.setCurrentSaveSlot(currentSaveSlot);
                    console.log("ğŸ”„ ê¸°ì¡´ ì €ì¥ ìŠ¬ë¡¯ ì—°ê²°:", currentSaveSlot);
                } else {
                    // ìƒˆë¡œìš´ ì €ì¥ ë°ì´í„° ìƒì„±
                    const newSaveData = gameDataManager.createSaveData(playerName);
                    currentSaveSlot = newSaveData.id;
                    console.log("âœ¨ ìƒˆë¡œìš´ ì €ì¥ ìŠ¬ë¡¯ ìƒì„±:", currentSaveSlot);
                }
            }
            
            // ì‹¤ì‹œê°„ ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            const updateResult = gameDataManager.updateCurrentSave(
                gameState,
                window.questItems ? { questItems: window.questItems } : null,
                currentPosition,
                "front"
            );
            
            if (updateResult) {
                console.log("ğŸ’¾ ìë™ì €ì¥ ì™„ë£Œ:", {
                    playerName: playerName,
                    position: currentPosition,
                    time: new Date().toLocaleTimeString('ko-KR')
                });
                
                // ìë™ì €ì¥ ì•Œë¦¼ í‘œì‹œ
                showAutoSaveNotification();
            } else {
                console.warn("âš ï¸ ìë™ì €ì¥ ì‹¤íŒ¨");
            }
            
        } catch (error) {
            console.error("âŒ ìë™ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
        }
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
    window.performAutoSave = performAutoSave;
    window.showQuestCompletionMessage = showQuestCompletionMessage;
    window.showQuestAddedMessage = showQuestAddedMessage;
    
    // ìë™ ì €ì¥ ë£¨í”„ (onUpdate ì‚¬ìš©)
    k.onUpdate(() => {
        const now = Date.now();
        if (now - lastAutoSaveTime >= AUTO_SAVE_INTERVAL) {
            performAutoSave();
            lastAutoSaveTime = now;
        }
    });
    
    // ì”¬ ì¢…ë£Œ ì‹œ ë§ˆì§€ë§‰ ì €ì¥
    k.onSceneLeave(() => {
        console.log("ğŸ§¹ Front ì”¬ ì •ë¦¬ ì‹œì‘");
        
        // ë§ˆì§€ë§‰ ìë™ ì €ì¥ ìˆ˜í–‰
        console.log("ğŸ’¾ ì”¬ ì¢…ë£Œ ì „ ë§ˆì§€ë§‰ ì €ì¥ ìˆ˜í–‰");
        performAutoSave();
        
        // window.previousKeyHandlerê°€ ìˆë‹¤ë©´ ì œê±°
        if (window.previousKeyHandler) {
            document.removeEventListener('keydown', window.previousKeyHandler, true);
            document.removeEventListener('keyup', window.previousKeyHandler, true);
            window.previousKeyHandler = null;
            console.log("âœ… Front ì”¬ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì™„ë£Œ");
        }
        
        console.log("âœ… Front ì”¬ ì •ë¦¬ ì™„ë£Œ");
    });
    
    } catch (error) {
        console.error("âŒ Front ì”¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì§„í–‰
        if (!map) {
            map = k.add([k.pos(0, 0)]);
        }
        entities.player = map.add(
            generateFrontPlayerComponents(k, k.vec2(0, 0))
        );
        setPlayerControls(k, entities.player);
        k.camScale(1.5); // ì¤Œì•„ì›ƒ: 3 â†’ 1.5ë¡œ ë³€ê²½
        k.camPos(entities.player.worldPos());
    }

    // í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
    function completeQuestByTarget(targetType, targetId) {
        console.log(`[DEBUG] completeQuestByTarget í˜¸ì¶œë¨ - íƒ€ì…: ${targetType}, ëŒ€ìƒ: ${targetId}`);
        
        const currentQuestItems = window.questItems || questItems;
        console.log(`[DEBUG] í˜„ì¬ í€˜ìŠ¤íŠ¸ ëª©ë¡:`, currentQuestItems);
        
        currentQuestItems.forEach((quest, index) => {
            console.log(`[DEBUG] í€˜ìŠ¤íŠ¸ ${index}: ${quest.title}, ì™„ë£Œë¨: ${quest.completed}, targetNpc: ${quest.targetNpc}, targetObject: ${quest.targetObject}`);
            
            if (!quest.completed) {
                // NPC ëŒ€í™”ë¡œ ì™„ë£Œë˜ëŠ” í€˜ìŠ¤íŠ¸
                if (targetType === "npc" && quest.targetNpc === targetId) {
                    console.log(`[DEBUG] í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì¡°ê±´ ì¶©ì¡± - NPC: ${targetId}`);
                    quest.completed = true;
                    showQuestCompletionMessage(quest.title);
                    
                    // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©)
                    if (window.updateQuestIcon) {
                        window.updateQuestIcon();
                    }
                    
                    // ìë™ ì €ì¥ (ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©)
                    if (window.performAutoSave) {
                        window.performAutoSave();
                    }
                    
                    console.log(`âœ… í€˜ìŠ¤íŠ¸ ì™„ë£Œ: ${quest.title} (ëŒ€í™” ëŒ€ìƒ: ${targetId})`);
                }
                
                // ì˜¤ë¸Œì íŠ¸ ìƒí˜¸ì‘ìš©ìœ¼ë¡œ ì™„ë£Œë˜ëŠ” í€˜ìŠ¤íŠ¸
                if (targetType === "object" && quest.targetObject === targetId) {
                    console.log(`[DEBUG] í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì¡°ê±´ ì¶©ì¡± - ì˜¤ë¸Œì íŠ¸: ${targetId}`);
                    quest.completed = true;
                    showQuestCompletionMessage(quest.title);
                    
                    // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©)
                    if (window.updateQuestIcon) {
                        window.updateQuestIcon();
                    }
                    
                    // ìë™ ì €ì¥ (ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©)
                    if (window.performAutoSave) {
                        window.performAutoSave();
                    }
                    
                    console.log(`âœ… í€˜ìŠ¤íŠ¸ ì™„ë£Œ: ${quest.title} (ìƒí˜¸ì‘ìš© ëŒ€ìƒ: ${targetId})`);
                }
            }
        });
    }

    // ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    window.completeQuestByTarget = completeQuestByTarget;
}
