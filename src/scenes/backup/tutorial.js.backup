import { gameState } from "../../state/stateManagers.js";
import { colorizeBackground, audioManager } from "../../utils.js";

export default function tutorial(k) {
    console.log("ğŸ“ Tutorial ì”¬ ì‹œì‘");
    
    // ê¸°ì¡´ BGM ì •ì§€ ë° ìƒˆ BGM ì¬ìƒ
    audioManager.stopBGM();
    audioManager.playBGM("rpg-main-bgm");
    
    // ê²€ì€ìƒ‰ ë°°ê²½
    colorizeBackground(k, 0, 0, 0);
    
    // ë¬¸ì„œ ë°°ê²½ë„ ê²€ì€ìƒ‰ìœ¼ë¡œ ì„¤ì •
    document.body.style.backgroundColor = 'black';
    
    // JavaScriptë¡œ í˜ì´ë“œ ì¸ íš¨ê³¼
    const fadeInOverlay = document.createElement('div');
    fadeInOverlay.style.position = 'fixed';
    fadeInOverlay.style.top = '0';
    fadeInOverlay.style.left = '0';
    fadeInOverlay.style.width = '100vw';
    fadeInOverlay.style.height = '100vh';
    fadeInOverlay.style.backgroundColor = 'black';
    fadeInOverlay.style.opacity = '1';
    fadeInOverlay.style.zIndex = '10000';
    fadeInOverlay.style.pointerEvents = 'none';
    fadeInOverlay.style.transition = 'opacity 2s ease-out';
    document.body.appendChild(fadeInOverlay);
    
    console.log("ğŸŒ… Tutorial í˜ì´ë“œ ì¸ ì‹œì‘");
    
    // í˜ì´ë“œ ì¸ ì‹œì‘
    setTimeout(() => {
        fadeInOverlay.style.opacity = '0';
        console.log("ğŸŒ… Tutorial í˜ì´ë“œ ì§„í–‰: ì‹œì‘");
    }, 50);
    
    // í˜ì´ë“œ ì¸ ì™„ë£Œ í›„ ì˜¤ë²„ë ˆì´ ì œê±°
    setTimeout(() => {
        console.log("âœ¨ Tutorial Fade In ì™„ë£Œ");
        if (fadeInOverlay && fadeInOverlay.parentNode) {
            document.body.removeChild(fadeInOverlay);
        }
    }, 2100); // 2ì´ˆ + ì—¬ìœ  ì‹œê°„

    // íŒ¨í„´ ë°°ê²½ ì¶”ê°€ (1280x1280 ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©) - pattern_lightgreen.png
    const patterns = [];
    const patternSize = 1280; // ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°
    
    console.log("í™”ë©´ í¬ê¸°:", k.width(), "x", k.height());
    
    // ì›ë³¸ í¬ê¸° íŒ¨í„´ìœ¼ë¡œ íƒ€ì¼ë§
    const screenWidth = k.width();
    const screenHeight = k.height();
    const extraPadding = patternSize; // ì—¬ë¶„ íŒ¨ë”©
    
    console.log("ì‹¤ì œ ë Œë”ë§ ì˜ì—­:", screenWidth, "x", screenHeight);
    
    // ì›ë³¸ í¬ê¸°ë¡œ íŒ¨í„´ ë°°ì¹˜ (ìŠ¤ì¼€ì¼ë§ ë° ìƒ‰ìƒ í•„í„°ë§ ì—†ìŒ)
    for (let x = -extraPadding; x <= screenWidth + extraPadding; x += patternSize) {
        for (let y = -extraPadding; y <= screenHeight + extraPadding; y += patternSize) {
            const pattern = k.add([
                k.sprite("pattern_lightgreen"),
                k.pos(x, y),
                k.z(0), // z-index 0
                k.fixed(), // ì¹´ë©”ë¼ ì›€ì§ì„ì— ê³ ì •
            ]);
            patterns.push(pattern);
        }
    }
    
    console.log("íŒ¨í„´ ìƒì„± ì™„ë£Œ, ì´ íŒ¨í„´ ìˆ˜:", patterns.length);

    // íŒ¨í„´ ì• ë‹ˆë©”ì´ì…˜ (ì¢Œí•˜í–¥ìœ¼ë¡œ íë¦„) - ìì—°ìŠ¤ëŸ¬ìš´ ë˜í•‘
    const patternSpeed = 30; // ì†ë„ ì¡°ì •
    k.onUpdate(() => {
        patterns.forEach(pattern => {
            pattern.pos.x -= patternSpeed * k.dt(); // ì™¼ìª½ìœ¼ë¡œ ì´ë™
            pattern.pos.y += patternSpeed * k.dt(); // ì•„ë˜ë¡œ ì´ë™
            
            // ìì—°ìŠ¤ëŸ¬ìš´ ë˜í•‘ - íŒ¨í„´ì´ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ë°˜ëŒ€í¸ì—ì„œ ë‹¤ì‹œ ë“±ì¥
            if (pattern.pos.x <= -patternSize) {
                pattern.pos.x += patternSize * Math.ceil((screenWidth + extraPadding * 2) / patternSize);
            }
            if (pattern.pos.y >= screenHeight + patternSize) {
                pattern.pos.y -= patternSize * Math.ceil((screenHeight + extraPadding * 2) / patternSize);
            }
        });
    });

    // ìƒë‹¨ ê°€ìš´ë°ì— TUTORIAL í…ìŠ¤íŠ¸ (gameboy í°íŠ¸) - 20% ì‘ê²Œ
    const titleText = k.add([
        k.text("TUTORIAL", { 
            size: 38, // 48ì—ì„œ 38ë¡œ ì¤„ì„ (20% ê°ì†Œ)
            font: "gameboy"
        }),
        k.anchor("center"),
        k.pos(k.center().x, 120), // 80ì—ì„œ 120ìœ¼ë¡œ ì¦ê°€ (íŒ¨ë”© ëŠ˜ë¦¼)
     k.color(105, 215, 23), // ë…¹ìƒ‰
        k.z(10),
        k.fixed(), // ì¹´ë©”ë¼ ì›€ì§ì„ì— ê³ ì •
    ]);

    // ê°€ìš´ë° í…ìŠ¤íŠ¸ (galmuri í°íŠ¸) - fade in/out íš¨ê³¼
    const centerText = k.add([
        k.text("íŠœ í†  ë¦¬ ì–¼ ì„  ì‹œ ì‘ í•© ë‹ˆ ë‹¤ .", { 
            size: 26, // 22ì—ì„œ 26ìœ¼ë¡œ ì¦ê°€
            font: "galmuri"
        }),
        k.anchor("center"),
        k.pos(k.center().x, k.center().y),
        k.color(111, 111, 111), // ì‚´ì§ ì˜…ì€ ê²€ì€ìƒ‰
        k.opacity(0),
        k.z(10),
        k.fixed(), // ì¹´ë©”ë¼ ì›€ì§ì„ì— ê³ ì •
    ]);

    // í”Œë ˆì´ì–´ ìºë¦­í„° ë³€ìˆ˜
    let player = null;
    
    // NPC ìºë¦­í„° ë³€ìˆ˜
    let npc = null;
    
    // ìƒí˜¸ì‘ìš© ê´€ë ¨ ë³€ìˆ˜
    let isNearNPC = false;
    let exclamationMark = null; // ì‹¤ì œë¡œëŠ” í•˜íŠ¸ í‘œì‹œ
    
    // íŠœí† ë¦¬ì–¼ í…ìŠ¤íŠ¸
    let tutorialText = null;

    // ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
    let tutorialStep = 0; // 0: ì´ˆê¸° í…ìŠ¤íŠ¸, 1: ìºë¦­í„° ì´ë™ íŠœí† ë¦¬ì–¼, 2: ì˜í–ˆìŠµë‹ˆë‹¤, 3: NPC ë“±ì¥, 4: ëŒ€í™” íŠœí† ë¦¬ì–¼
    let hasPlayerMoved = false; // í”Œë ˆì´ì–´ê°€ í•œ ë²ˆì´ë¼ë„ ì›€ì§ì˜€ëŠ”ì§€
    
    // ì´ë™ ë°©í–¥ ì¶”ì  ë³€ìˆ˜
    let movementTracking = {
        left: false,
        right: false,
        up: false,
        down: false,
        startTime: null,
        indicators: {},
        // ê° ë°©í–¥ë³„ ëˆ„ë¥¸ ì‹œê°„ ì¶”ì 
        directionTimes: {
            left: 0,
            right: 0,
            up: 0,
            down: 0
        },
        requiredTime: 500 // 0.5ì´ˆ
    };

    // 1ë‹¨ê³„: ì´ˆê¸° í…ìŠ¤íŠ¸ fade in/out
    k.wait(2.5, () => { // í˜ì´ë“œ ì¸ ì™„ë£Œ í›„ ì‹œì‘
        console.log("ğŸ“ íŠœí† ë¦¬ì–¼ ì´ˆê¸° í…ìŠ¤íŠ¸ fade in ì‹œì‘");
        
        // Fade in
        k.tween(centerText.opacity, 1, 1, (val) => {
            centerText.opacity = val;
        }).then(() => {
            console.log("ğŸ“ ì´ˆê¸° í…ìŠ¤íŠ¸ í‘œì‹œ ì™„ë£Œ, 3ì´ˆ ëŒ€ê¸°");
            
            // 1ì´ˆ ëŒ€ê¸° í›„ fade out (3ì´ˆì—ì„œ 1ì´ˆë¡œ ë‹¨ì¶•)
            k.wait(1, () => {
                k.tween(centerText.opacity, 0, 1, (val) => {
                    centerText.opacity = val;
                }).then(() => {
                    console.log("ğŸ“ ì´ˆê¸° í…ìŠ¤íŠ¸ fade out ì™„ë£Œ, ìºë¦­í„° ìƒì„±");
                    // í…ìŠ¤íŠ¸ fade out ì™„ë£Œ í›„ ìºë¦­í„° ë“±ì¥
                    k.wait(0.5, () => {
                        startCharacterTutorial();
                    });
                });
            });
        });
    });

    function startCharacterTutorial() {
        tutorialStep = 1;
        
        // ê°€ìš´ë° í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
        centerText.opacity = 0;
        
        // í”Œë ˆì´ì–´ ìºë¦­í„° ìƒì„± (í™”ë©´ ì •ê°€ìš´ë°) - 3.6ë°° í¬ê¸° (10% ê°ì†Œ)
        player = k.add([
            k.sprite("main-assets", { anim: "player-idle-down" }),
            k.anchor("center"),
            k.pos(k.center().x, k.center().y), // í™”ë©´ ì •ê°€ìš´ë°
            k.scale(0.1), // ë§¤ìš° ì‘ê²Œ ì‹œì‘ (ease-in íš¨ê³¼ìš©)
            k.area({ width: 86, height: 86 }), // ì½œë¼ì´ë” ì˜ì—­ (24*3.6 = 86.4)
            k.body(), // ì½œë¼ì´ë” ì¶”ê°€
            k.opacity(0), // ì²˜ìŒì—ëŠ” íˆ¬ëª…
            k.z(20),
            "player"
        ]);
        
        // íŠœí† ë¦¬ì–¼ í…ìŠ¤íŠ¸ ìƒì„± (í•˜ë‹¨ì— ëŒ€ì¹­ ë°°ì¹˜) - í¬ê¸° ì¤„ì„
        tutorialText = k.add([
            k.text("í™”ì‚´í‘œ í‚¤ë¥¼ ëˆŒëŸ¬ ìƒí•˜ì¢Œìš°ë¡œ ì›€ì§ì—¬ë³´ì„¸ìš”.", { 
                size: 20, // ëª¨ë“  ì•ˆë‚´ í…ìŠ¤íŠ¸ì™€ ë™ì¼í•˜ê²Œ
                font: "galmuri",
                width: k.width() - 100,
                align: "center"
            }),
            k.anchor("center"),
            k.pos(k.center().x, k.height() - 120), // 80ì—ì„œ 120ìœ¼ë¡œ ì¦ê°€ (íŒ¨ë”© ëŠ˜ë¦¼)
            k.color(50, 200, 50), // "ì˜í–ˆìŠµë‹ˆë‹¤" ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½ (ë…¹ìƒ‰)
            k.opacity(0), // ì²˜ìŒì—ëŠ” íˆ¬ëª…
            k.z(10),
            k.fixed(), // ì¹´ë©”ë¼ ì›€ì§ì„ì— ê³ ì •
        ]);
        
        // ë°©í–¥ ì¸ë””ì¼€ì´í„° ìƒì„±
        createMovementIndicators();
        
        console.log("ğŸ“ í”Œë ˆì´ì–´ ìºë¦­í„° ìƒì„± ì™„ë£Œ:", player.pos);
        
        // í”Œë ˆì´ì–´ ease-in íš¨ê³¼ (í¬ê¸°ì™€ íˆ¬ëª…ë„ ë™ì‹œì—)
        k.tween(player.scale, k.vec2(3.6, 3.6), 1.2, (val) => {
            player.scale = val;
        }, k.easings.easeOutBack); // ì‚´ì§ íŠ€ëŠ” íš¨ê³¼
        
        k.tween(player.opacity, 1, 1.2, (val) => {
            player.opacity = val;
        });
        
        // í…ìŠ¤íŠ¸ëŠ” í”Œë ˆì´ì–´ê°€ ë“±ì¥í•œ í›„ì— í‘œì‹œ
        k.wait(0.8, () => {
            k.tween(tutorialText.opacity, 1, 0.8, (val) => {
                tutorialText.opacity = val;
            });
            
            // ì¸ë””ì¼€ì´í„°ë„ í•¨ê»˜ í‘œì‹œ
            k.wait(0.2, () => {
                showMovementIndicators();
                // ì´ë™ ì¶”ì  ì‹œì‘
                movementTracking.startTime = Date.now();
            });
        });
        
        console.log("ğŸ“ ìºë¦­í„° ì´ë™ íŠœí† ë¦¬ì–¼ ì‹œì‘");
    }

    // ë°©í–¥ ì¸ë””ì¼€ì´í„° ìƒì„± í•¨ìˆ˜
    function createMovementIndicators() {
        const baseY = k.height() - 160; // í…ìŠ¤íŠ¸ ìœ„ìª½ì— ë°°ì¹˜
        const centerX = k.center().x;
        const spacing = 60; // ì¸ë””ì¼€ì´í„° ê°„ê²©
        
        const directions = [
            { key: 'left', pos: { x: centerX - spacing * 1.5, y: baseY }, symbol: 'â†' },
            { key: 'right', pos: { x: centerX - spacing * 0.5, y: baseY }, symbol: 'â†’' },
            { key: 'up', pos: { x: centerX + spacing * 0.5, y: baseY }, symbol: 'â†‘' },
            { key: 'down', pos: { x: centerX + spacing * 1.5, y: baseY }, symbol: 'â†“' }
        ];
        
        directions.forEach(dir => {
            // ë°°ê²½ ì› (íšŒìƒ‰)
            const bgCircle = k.add([
                k.circle(16),
                k.pos(dir.pos.x, dir.pos.y),
                k.anchor("center"),
                k.color(60, 60, 60), // ì–´ë‘ìš´ íšŒìƒ‰
                k.opacity(0),
                k.z(15),
                k.fixed(),
                "movementIndicator"
            ]);
            
            // ì™„ë£Œ ì› (ë…¹ìƒ‰)
            const completeCircle = k.add([
                k.circle(16),
                k.pos(dir.pos.x, dir.pos.y),
                k.anchor("center"),
                k.color(50, 200, 50), // ë…¹ìƒ‰
                k.opacity(0),
                k.z(16),
                k.fixed(),
                "movementIndicator"
            ]);
            
            // ë°©í–¥ ê¸°í˜¸ í…ìŠ¤íŠ¸
            const dirText = k.add([
                k.text(dir.symbol, {
                    size: 20,
                    font: "galmuri"
                }),
                k.pos(dir.pos.x, dir.pos.y),
                k.anchor("center"),
                k.color(255, 255, 255), // í°ìƒ‰
                k.opacity(0),
                k.z(17),
                k.fixed(),
                "movementIndicator"
            ]);
            
            movementTracking.indicators[dir.key] = {
                background: bgCircle,
                complete: completeCircle,
                text: dirText,
                completed: false
            };
        });
    }
    
    // ì¸ë””ì¼€ì´í„° í‘œì‹œ í•¨ìˆ˜
    function showMovementIndicators() {
        Object.values(movementTracking.indicators).forEach(indicator => {
            k.tween(indicator.background.opacity, 0.7, 0.5, (val) => {
                indicator.background.opacity = val;
            });
            k.tween(indicator.text.opacity, 1, 0.5, (val) => {
                indicator.text.opacity = val;
            });
        });
    }
    
    // ë°©í–¥ ì™„ë£Œ í‘œì‹œ í•¨ìˆ˜
    function markDirectionComplete(direction) {
        if (movementTracking.indicators[direction] && !movementTracking.indicators[direction].completed) {
            movementTracking.indicators[direction].completed = true;
            movementTracking[direction] = true;
            
            const indicator = movementTracking.indicators[direction];
            
            // ë…¹ìƒ‰ ì› í˜ì´ë“œ ì¸ (0.5ì´ˆ ë™ì•ˆ)
            k.tween(indicator.complete.opacity, 0.9, 0.5, (val) => {
                indicator.complete.opacity = val;
            });
            
            // í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ê²€ì€ìƒ‰ìœ¼ë¡œ í˜ì´ë“œ (0.5ì´ˆ ë™ì•ˆ)
            k.tween(indicator.text.color.r, 0, 0.5, (val) => {
                indicator.text.color = k.rgb(val, val, val);
            });
            
            console.log(`âœ… ë°©í–¥ ì™„ë£Œ: ${direction} (0.5ì´ˆ ì´ìƒ ìœ ì§€)`);
            
            // ëª¨ë“  ë°©í–¥ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            checkMovementCompletion();
        }
    }
    
    // ê° ë°©í–¥ë³„ ëˆ„ë¥¸ ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateDirectionTime(direction, deltaTime) {
        if (!movementTracking.indicators[direction].completed) {
            movementTracking.directionTimes[direction] += deltaTime;
            
            // 0.5ì´ˆ ì´ìƒ ëˆ„ë¥´ë©´ ì™„ë£Œë¡œ í‘œì‹œ
            if (movementTracking.directionTimes[direction] >= movementTracking.requiredTime) {
                markDirectionComplete(direction);
            }
        }
    }
    
    // ì´ë™ ì™„ë£Œ í™•ì¸ í•¨ìˆ˜
    function checkMovementCompletion() {
        const allDirectionsComplete = movementTracking.left && 
                                    movementTracking.right && 
                                    movementTracking.up && 
                                    movementTracking.down;
        
        // ì‹œê°„ ì¡°ê±´ ì œê±° - ëª¨ë“  ë°©í–¥ë§Œ ì™„ë£Œí•˜ë©´ ë¨
        if (allDirectionsComplete) {
            console.log("ğŸ‰ ëª¨ë“  ë°©í–¥ ì´ë™ ì™„ë£Œ! ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰");
            
            // ì¸ë””ì¼€ì´í„° ì œê±°
            k.destroyAll("movementIndicator");
            
            // 0.3ì´ˆ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰
            k.wait(0.3, () => {
                showWellDoneMessage();
            });
        }
    }

    // "ì˜í–ˆìŠµë‹ˆë‹¤!" ë©”ì‹œì§€ í‘œì‹œ
    function showWellDoneMessage() {
        tutorialStep = 2;
        
        // ì¸ë””ì¼€ì´í„° ì •ë¦¬ (í˜¹ì‹œ ë‚¨ì•„ìˆë‹¤ë©´)
        k.destroyAll("movementIndicator");
        
        // í”Œë ˆì´ì–´ë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ì™„ì „íˆ ë³µì›
        if (player) {
            player.play("player-idle-down");
            currentAnimDirection = "down";
            isCurrentlyMoving = false;
            
            // í‚¤ ìƒíƒœë„ ëª¨ë‘ ì´ˆê¸°í™”
            keyStates = {
                left: false,
                right: false,
                up: false,
                down: false
            };
            
            // ì´ë™ ì¶”ì  ìƒíƒœë„ ì™„ì „íˆ ì´ˆê¸°í™”
            movementTracking = {
                left: false,
                right: false,
                up: false,
                down: false,
                startTime: null,
                indicators: {},
                directionTimes: {
                    left: 0,
                    right: 0,
                    up: 0,
                    down: 0
                },
                requiredTime: 500
            };
            
            console.log("ğŸ­ í”Œë ˆì´ì–´ ë° ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ");
        }
        
        // ê¸°ì¡´ í…ìŠ¤íŠ¸ í˜ì´ë“œ ì•„ì›ƒ
        k.tween(tutorialText.opacity, 0, 1, (val) => {
            tutorialText.opacity = val;
        }).then(() => {
            // "ì˜í–ˆìŠµë‹ˆë‹¤!" í…ìŠ¤íŠ¸ ìƒì„±
            const wellDoneText = k.add([
                k.text("ì˜í–ˆìŠµë‹ˆë‹¤!", { 
                    size: 28, // ëª¨ë“  "ì˜í–ˆìŠµë‹ˆë‹¤" í…ìŠ¤íŠ¸ì™€ ë™ì¼í•˜ê²Œ
                    font: "galmuri",
                    align: "center"
                }),
                k.anchor("center"),
                k.pos(k.center().x, k.height() - 120),
                k.color(50, 200, 50), // ë…¹ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                k.opacity(0),
                k.z(10),
                k.fixed(),
            ]);
            
            // í˜ì´ë“œ ì¸
            k.tween(wellDoneText.opacity, 1, 1, (val) => {
                wellDoneText.opacity = val;
            }).then(() => {
                // 2ì´ˆ ëŒ€ê¸° í›„ í˜ì´ë“œ ì•„ì›ƒ
                k.wait(2, () => {
                    k.tween(wellDoneText.opacity, 0, 1, (val) => {
                        wellDoneText.opacity = val;
                    }).then(() => {
                        wellDoneText.destroy();
                        showNPCAndDialogueTutorial();
                    });
                });
            });
        });
    }

    // NPC ë“±ì¥ ë° ëŒ€í™” íŠœí† ë¦¬ì–¼
    function showNPCAndDialogueTutorial() {
        tutorialStep = 3;
        
        // letter1 ì˜¤ë¸Œì íŠ¸ ìƒì„± (í”Œë ˆì´ì–´ ì™¼ìª½ì— ê°„ê²©ì„ ë‘ê³ )
        npc = k.add([
            k.sprite("main-assets", { frame: 5378 }), // letter1 í”„ë ˆì„ ì‚¬ìš©
            k.anchor("center"),
            k.pos(player.pos.x - 120, player.pos.y), // í”Œë ˆì´ì–´ ì™¼ìª½ì— 120px ê°„ê²© (180ì—ì„œ 120ìœ¼ë¡œ ì¤„ì„)
            k.scale(3.6), // í”Œë ˆì´ì–´ì™€ ê°™ì€ í¬ê¸°
            k.area({ width: 25, height: 25 }), // ì½œë¼ì´ë”ë¥¼ ìŠ¤í”„ë¼ì´íŠ¸ í¬ê¸°ì— ë§ê²Œ ì¡°ì • (ì‘ì€ ì‚¬ë¬¼ìš©)
            k.body({ isStatic: true }), // ì •ì  ì½œë¼ì´ë” (ì›€ì§ì´ì§€ ì•ŠìŒ)
            k.opacity(0), // ì²˜ìŒì—ëŠ” íˆ¬ëª…
            k.z(20),
            "npc",
            "letter" // íƒœê·¸ ì¶”ê°€
        ]);
        
        // Letter í˜ì´ë“œ ì¸
        k.tween(npc.opacity, 1, 1, (val) => {
            npc.opacity = val;
        }).then(() => {
            // í¸ì§€ íŠœí† ë¦¬ì–¼ í…ìŠ¤íŠ¸ í‘œì‹œ
            showDialogueTutorialText();
        });
    }

    // ëŒ€í™” íŠœí† ë¦¬ì–¼ í…ìŠ¤íŠ¸ í‘œì‹œ
    function showDialogueTutorialText() {
        tutorialStep = 4;
        
        const dialogueText = k.add([
            k.text("ìª½ì§€ì™€ ê°™ì€ ì‚¬ë¬¼ë„ ë˜‘ê°™ì´ ìŠ¤í˜ì´ìŠ¤ë¥¼ ëˆŒëŸ¬ ìƒí˜¸ì‘ìš© í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!", { 
                size: 20, // ëª¨ë“  ì•ˆë‚´ í…ìŠ¤íŠ¸ì™€ ë™ì¼í•˜ê²Œ
                font: "galmuri",
                width: k.width() - 100,
                align: "center"
            }),
            k.anchor("center"),
            k.pos(k.center().x, k.height() - 120),
            k.color(50, 200, 50), // "ì˜í–ˆìŠµë‹ˆë‹¤" ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½ (ë…¹ìƒ‰)
            k.opacity(0),
            k.z(10),
            k.fixed(),
            "tutorialText"
        ]);
        
        // í˜ì´ë“œ ì¸
        k.tween(dialogueText.opacity, 1, 1, (val) => {
            dialogueText.opacity = val;
        });
    }

    // í”Œë ˆì´ì–´ ì´ë™ ì²˜ë¦¬
    const MOVE_SPEED = 120; // ì†ë„ ì¡°ì • (í”½ì…€/ì´ˆ)
    const CENTER_X = k.center().x;
    const CENTER_Y = k.center().y; // í”Œë ˆì´ì–´ ì´ˆê¸° Y ìœ„ì¹˜ (ì •ê°€ìš´ë°)
    const MOVE_RADIUS = 100; // ì´ë™ ê°€ëŠ¥ ë°˜ê²½
    
    // ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ì¶”ì 
    let currentAnimDirection = "down"; // í˜„ì¬ ì• ë‹ˆë©”ì´ì…˜ ë°©í–¥
    let isCurrentlyMoving = false; // í˜„ì¬ ì´ë™ ì¤‘ì¸ì§€

    // í•œê¸€ ì…ë ¥ ìƒíƒœì—ì„œë„ í™”ì‚´í‘œ í‚¤ê°€ ì‘ë™í•˜ë„ë¡ ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    let documentKeyHandler = null;
    let keyStates = {
        left: false,
        right: false,
        up: false,
        down: false
    };

    documentKeyHandler = (e) => {
        if (tutorialStep !== 1 && tutorialStep !== 4 && tutorialStep !== 7 && tutorialStep !== 9) {
            // í—ˆìš©ë˜ì§€ ì•ŠëŠ” tutorialStepì—ì„œëŠ” í‚¤ ìƒíƒœ ì´ˆê¸°í™”
            if (e.type === 'keyup') {
                keyStates = {
                    left: false,
                    right: false,
                    up: false,
                    down: false
                };
            }
            return; // Mí‚¤ íŠœí† ë¦¬ì–¼ë„ í—ˆìš©
        }
        
        // í™”ì‚´í‘œ í‚¤ë§Œ ì²˜ë¦¬
        switch(e.code) {
            case 'ArrowLeft':
                keyStates.left = (e.type === 'keydown');
                e.preventDefault();
                break;
            case 'ArrowRight':
                keyStates.right = (e.type === 'keydown');
                e.preventDefault();
                break;
            case 'ArrowUp':
                keyStates.up = (e.type === 'keydown');
                e.preventDefault();
                break;
            case 'ArrowDown':
                keyStates.down = (e.type === 'keydown');
                e.preventDefault();
                break;
            case 'Space':
                if (e.type === 'keydown' && (tutorialStep === 4 || tutorialStep === 7) && isNearNPC) {
                    e.preventDefault(); // ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë™ì‘ ë°©ì§€
                    console.log(`ğŸ” ë¸Œë¼ìš°ì € ìŠ¤í˜ì´ìŠ¤ë°” ì´ë²¤íŠ¸! tutorialStep: ${tutorialStep}, isNearNPC: ${isNearNPC}`);
                    
                    if (tutorialStep === 4) {
                        console.log("ğŸ‰ Letterì™€ ì„±ê³µì ìœ¼ë¡œ ìƒí˜¸ì‘ìš©! (ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸)");
                        handleLetterInteraction();
                    } else if (tutorialStep === 7) {
                        console.log("ğŸ‰ NPCì™€ ì„±ê³µì ìœ¼ë¡œ ìƒí˜¸ì‘ìš©! (ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸)");
                        handleNPCInteraction();
                    }
                } else if (e.type === 'keydown') {
                    console.log(`âŒ ë¸Œë¼ìš°ì € ìŠ¤í˜ì´ìŠ¤ë°” ì¡°ê±´ ë¶ˆë§Œì¡±: tutorialStep=${tutorialStep}, isNearNPC=${isNearNPC}`);
                }
                break;
            case 'KeyM':
                if (e.type === 'keydown' && tutorialStep === 9) {
                    e.preventDefault();
                    console.log("ğŸµ Mí‚¤ë¡œ ìŒì•… í† ê¸€! (ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸)");
                    handleMusicToggle();
                }
                break;
        }
    };

    document.addEventListener('keydown', documentKeyHandler);
    document.addEventListener('keyup', documentKeyHandler);

    // ìŠ¤í˜ì´ìŠ¤ë°” ìƒí˜¸ì‘ìš© ì´ë²¤íŠ¸ (Kaboom)
    k.onKeyPress("space", () => {
        console.log(`ğŸ” ìŠ¤í˜ì´ìŠ¤ë°” ëˆŒë¦¼! tutorialStep: ${tutorialStep}, isNearNPC: ${isNearNPC}`);
        
        if ((tutorialStep === 4 || tutorialStep === 7) && isNearNPC) {
            if (tutorialStep === 4) {
                console.log("ğŸ‰ Letterì™€ ì„±ê³µì ìœ¼ë¡œ ìƒí˜¸ì‘ìš©! (Kaboom ì´ë²¤íŠ¸)");
                handleLetterInteraction();
            } else if (tutorialStep === 7) {
                console.log("ğŸ‰ NPCì™€ ì„±ê³µì ìœ¼ë¡œ ìƒí˜¸ì‘ìš©! (Kaboom ì´ë²¤íŠ¸)");
                handleNPCInteraction();
            }
        } else {
            console.log(`âŒ ìƒí˜¸ì‘ìš© ì¡°ê±´ ë¶ˆë§Œì¡±: tutorialStep=${tutorialStep}, isNearNPC=${isNearNPC}`);
        }
    });

    // Mí‚¤ ìŒì•… í† ê¸€ ì´ë²¤íŠ¸ (Kaboom)
    k.onKeyPress("m", () => {
        if (tutorialStep === 9) {
            console.log("ğŸµ Mí‚¤ë¡œ ìŒì•… í† ê¸€!");
            handleMusicToggle();
        }
    });

    // Letter ìƒí˜¸ì‘ìš© í•¸ë“¤ëŸ¬
    function handleLetterInteraction() {
        // Letter ìƒí˜¸ì‘ìš© ì™„ë£Œ í›„ ë°”ë¡œ Friend íŠœí† ë¦¬ì–¼ë¡œ
        console.log("ğŸ† Letter ìƒí˜¸ì‘ìš© ì™„ë£Œ!");
        tutorialStep = 5; // ë‹¤ìŒ ë‹¨ê³„ë¡œ
        
        // ê¸°ì¡´ í…ìŠ¤íŠ¸ë“¤ ì œê±°
        k.destroyAll("tutorialText");
        
        // Letter ìƒí˜¸ì‘ìš© ì™„ë£Œ ë©”ì‹œì§€ (ì›ë˜ í…ìŠ¤íŠ¸ ìœ„ì¹˜ì—)
        const letterComplete = k.add([
            k.text("ì˜í–ˆìŠµë‹ˆë‹¤!", {
                font: "galmuri",
                size: 28,
                align: "center"
            }),
            k.color(50, 200, 50), // ë…¹ìƒ‰
            k.pos(k.center().x, k.height() - 120), // ì›ë˜ í…ìŠ¤íŠ¸ ìœ„ì¹˜
            k.anchor("center"),
            k.opacity(0),
            k.z(10),
            k.fixed(),
            "tutorialText"
        ]);
        
        // í˜ì´ë“œ ì¸
        k.tween(letterComplete.opacity, 1, 1, (val) => {
            letterComplete.opacity = val;
        }).then(() => {
            // 2ì´ˆ í›„ í˜ì´ë“œ ì•„ì›ƒí•˜ê³  Friend íŠœí† ë¦¬ì–¼
            k.wait(2, () => {
                k.tween(letterComplete.opacity, 0, 1, (val) => {
                    letterComplete.opacity = val;
                }).then(() => {
                    letterComplete.destroy();
                    showFriendTutorial(); // Letter ë‹¤ìŒì— ì¹œêµ¬ íŠœí† ë¦¬ì–¼
                });
            });
        });
    }
    
    // NPC ìƒí˜¸ì‘ìš© í•¸ë“¤ëŸ¬
    function handleNPCInteraction() {
        // ë§í’ì„  ìƒì„± ë° ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        if (npc && tutorialStep === 7) {
            exclamationMark = k.add([
                k.sprite("main-assets", { frame: 5776 }), // bubble_angry ìŠ¤í”„ë¼ì´íŠ¸ ì‚¬ìš©
                k.pos(npc.pos.x, npc.pos.y - 60), // NPC ìœ„ìª½ì— í‘œì‹œ
                k.anchor("center"),
                k.scale(2), // ê¸°ë³¸ í¬ê¸° 2ë°°
                k.z(1000),
                "bubble-indicator"
            ]);
            
            // ë§í’ì„  ì»¤ì§€ë©´ì„œ í”ë“¤ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜
            k.tween(exclamationMark.scale, k.vec2(2.5, 2.5), 0.3, (val) => {
                exclamationMark.scale = val;
            }, k.easings.easeOutBack);
            
            // í”ë“¤ë¦¬ê¸° íš¨ê³¼ (ì¢Œìš°ë¡œ ì‚´ì§)
            const originalX = exclamationMark.pos.x;
            let shakeCount = 0;
            const shakeInterval = setInterval(() => {
                if (exclamationMark && shakeCount < 6) {
                    const shakeAmount = 3;
                    exclamationMark.pos.x = originalX + (shakeCount % 2 === 0 ? shakeAmount : -shakeAmount);
                    shakeCount++;
                } else {
                    clearInterval(shakeInterval);
                    if (exclamationMark) {
                        exclamationMark.pos.x = originalX; // ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
                    }
                }
            }, 100); // 0.1ì´ˆë§ˆë‹¤ í”ë“¤ê¸°
            
            // 1ì´ˆ í›„ ë§í’ì„  ì œê±°í•˜ê³  ëŒ€í™” ì‹œì‘
            k.wait(1, () => {
                if (exclamationMark) {
                    exclamationMark.destroy();
                    exclamationMark = null;
                }
                
                // ëŒ€í™” ì‹œì‘
                startTutorialDialog();
            });
        }
    }
    
    // íŠœí† ë¦¬ì–¼ ëŒ€í™” ì‹œìŠ¤í…œ
    function startTutorialDialog() {
        console.log("ğŸ­ íŠœí† ë¦¬ì–¼ ëŒ€í™” ì‹œì‘");
        
        // íŠœí† ë¦¬ì–¼ ëŒ€í™” ë‚´ìš©
        const dialogData = [
            {
                character: "???",
                text: "..."
            },
            {
                character: "???", 
                text: "......"
            },
            {
                character: "???",
                text: "...ê¹œì§ì´ì•¼!!!"
            }
        ];
        
        const shiftDialogData = [
            {
                character: "???",
                text: "ë­ì•¼ ë„Œ! ì²˜ìŒë³´ëŠ” ì–¼êµ´ì¸ë°."
            },
            {
                character: "???",
                text: "ì™œ ë‚  ë°©í•´í•˜ëŠ”ê±°ì•¼?"
            }
        ];
        
        let currentDialogIndex = 0;
        let isDialogActive = true;
        let dialogBox = null;
        let dialogText = null;
        let nameTab = null;
        let nameText = null;
        let helpText = null;
        let helpTextVisible = false;
        let helpTextTimer = null;
        let isShiftTutorial = false;
        
        // ëŒ€í™”ì°½ ìƒì„±
        function createDialogBox() {
            // ëŒ€í™”ì°½ ë°°ê²½
            dialogBox = k.add([
                k.rect(k.width() - 120, 160),
                k.pos(60, k.height() - 200),
                k.color(0, 0, 0),
                k.opacity(0.8),
                k.z(2000),
                k.fixed(),
                "tutorialDialog"
            ]);
            
            // í…Œë‘ë¦¬
            k.add([
                k.rect(k.width() - 120, 160),
                k.pos(60, k.height() - 200),
                k.outline(3, k.rgb(255, 255, 255)),
                k.z(2001),
                k.fixed(),
                "tutorialDialog"
            ]);
            
            // ì´ë¦„ íƒ­
            nameTab = k.add([
                k.rect(120, 40),
                k.pos(80, k.height() - 220),
                k.color(50, 50, 50),
                k.z(2002),
                k.fixed(),
                "tutorialDialog"
            ]);
            
            // ì´ë¦„ íƒ­ í…Œë‘ë¦¬
            k.add([
                k.rect(120, 40),
                k.pos(80, k.height() - 220),
                k.outline(2, k.rgb(255, 255, 255)),
                k.z(2003),
                k.fixed(),
                "tutorialDialog"
            ]);
            
            // ì´ë¦„ í…ìŠ¤íŠ¸
            nameText = k.add([
                k.text("???", {
                    size: 18,
                    font: "galmuri"
                }),
                k.pos(140, k.height() - 200),
                k.anchor("center"),
                k.color(255, 255, 255),
                k.z(2004),
                k.fixed(),
                "tutorialDialog"
            ]);
            
            // ëŒ€í™” í…ìŠ¤íŠ¸
            dialogText = k.add([
                k.text("", {
                    size: 20,
                    font: "galmuri",
                    width: k.width() - 180
                }),
                k.pos(90, k.height() - 170),
                k.color(255, 255, 255),
                k.z(2004),
                k.fixed(),
                "tutorialDialog"
            ]);
            
            showCurrentDialog();
        }
        
        // í˜„ì¬ ëŒ€í™” í‘œì‹œ
        function showCurrentDialog() {
            hideHelpText(); // ê¸°ì¡´ ë„ì›€ë§ í…ìŠ¤íŠ¸ ì œê±°
            
            if (!isShiftTutorial && currentDialogIndex < dialogData.length) {
                const dialog = dialogData[currentDialogIndex];
                dialogText.text = dialog.text;
                nameText.text = dialog.character;
                
                // 1ì´ˆ í›„ ë„ì›€ë§ í…ìŠ¤íŠ¸ í‘œì‹œ
                helpTextTimer = setTimeout(() => {
                    showHelpText("ìŠ¤í˜ì´ìŠ¤ í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”");
                }, 1000);
                
            } else if (isShiftTutorial && currentDialogIndex < shiftDialogData.length) {
                const dialog = shiftDialogData[currentDialogIndex];
                dialogText.text = dialog.text;
                nameText.text = dialog.character;
                
                // ì²« ë²ˆì§¸ Shift ëŒ€í™”ì—ì„œë§Œ ë„ì›€ë§ í‘œì‹œ
                if (currentDialogIndex === 0) {
                    helpTextTimer = setTimeout(() => {
                        showHelpText("Shift í‚¤ë¥¼ ëˆ„ë¥´ë©´ ë¹ ë¥´ê²Œ ë„˜ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
                    }, 100);
                }
            }
        }
        
        // ë„ì›€ë§ í…ìŠ¤íŠ¸ í‘œì‹œ
        function showHelpText(text) {
            if (helpText) {
                helpText.destroy();
                helpText = null;
            }
            
            helpText = k.add([
                k.text(text, {
                    size: 14,
                    font: "galmuri"
                }),
                k.pos(k.center().x, k.height() - 240),
                k.anchor("center"),
                k.color(150, 150, 150),
                k.opacity(0),
                k.z(2005),
                k.fixed(),
                "tutorialDialog"
            ]);
            
            helpTextVisible = true;
            
            // ê¹œë°•ì´ëŠ” íš¨ê³¼
            const blinkTween = () => {
                if (helpTextVisible && helpText) {
                    k.tween(helpText.opacity, 1, 0.8, (val) => {
                        if (helpText) helpText.opacity = val;
                    }).then(() => {
                        if (helpTextVisible && helpText) {
                            k.tween(helpText.opacity, 0.3, 0.8, (val) => {
                                if (helpText) helpText.opacity = val;
                            }).then(() => {
                                if (helpTextVisible) {
                                    blinkTween();
                                }
                            });
                        }
                    });
                }
            };
            blinkTween();
        }
        
        // ë„ì›€ë§ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
        function hideHelpText() {
            helpTextVisible = false;
            if (helpText) {
                helpText.destroy();
                helpText = null;
            }
            if (helpTextTimer) {
                clearTimeout(helpTextTimer);
                helpTextTimer = null;
            }
        }
        
        // í‚¤ ì…ë ¥ ì²˜ë¦¬
        const dialogKeyHandler = (e) => {
            if (!isDialogActive) return;
            
            if (e.type === 'keydown') {
                if (e.code === 'Space' && !isShiftTutorial) {
                    e.preventDefault();
                    hideHelpText();
                    
                    currentDialogIndex++;
                    if (currentDialogIndex >= dialogData.length) {
                        // ì²« ë²ˆì§¸ ëŒ€í™” ì™„ë£Œ, Shift íŠœí† ë¦¬ì–¼ ì‹œì‘
                        isShiftTutorial = true;
                        currentDialogIndex = 0;
                        showCurrentDialog();
                    } else {
                        showCurrentDialog();
                    }
                } else if ((e.code === 'ShiftLeft' || e.code === 'ShiftRight') && isShiftTutorial) {
                    e.preventDefault();
                    hideHelpText();
                    
                    currentDialogIndex++;
                    if (currentDialogIndex >= shiftDialogData.length) {
                        // ëª¨ë“  ëŒ€í™” ì™„ë£Œ
                        endDialog();
                    } else {
                        showCurrentDialog();
                    }
                }
            }
        };
        
        // ëŒ€í™” ì¢…ë£Œ
        function endDialog() {
            console.log("ğŸ­ ëŒ€í™” ì¢…ë£Œ");
            isDialogActive = false;
            hideHelpText();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            document.removeEventListener('keydown', dialogKeyHandler);
            document.removeEventListener('keyup', dialogKeyHandler);
            
            // ëŒ€í™”ì°½ í˜ì´ë“œ ì•„ì›ƒ
            const allDialogElements = k.get("tutorialDialog");
            allDialogElements.forEach(element => {
                if (element.opacity !== undefined) {
                    k.tween(element.opacity, 0, 1, (val) => {
                        element.opacity = val;
                    });
                }
            });
            
            // 1ì´ˆ í›„ ëŒ€í™”ì°½ ì œê±° ë° ë‹¤ìŒ ë‹¨ê³„
            k.wait(1, () => {
                k.destroyAll("tutorialDialog");
                showFinalWellDoneMessage();
            });
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.addEventListener('keydown', dialogKeyHandler);
        document.addEventListener('keyup', dialogKeyHandler);
        
        // ëŒ€í™”ì°½ ìƒì„± ë° ì‹œì‘
        createDialogBox();
    }
    
    // ìµœì¢… "ì˜í–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€
    function showFinalWellDoneMessage() {
        tutorialStep = 8;
        
        const finalWellDone = k.add([
            k.text("ì˜í–ˆìŠµë‹ˆë‹¤!", {
                font: "galmuri",
                size: 28,
                align: "center"
            }),
            k.color(50, 200, 50), // ë…¹ìƒ‰
            k.pos(k.center().x, k.height() - 120),
            k.anchor("center"),
            k.opacity(0),
            k.z(10),
            k.fixed(),
        ]);
        
        // í˜ì´ë“œ ì¸
        k.tween(finalWellDone.opacity, 1, 1, (val) => {
            finalWellDone.opacity = val;
        }).then(() => {
            // 2ì´ˆ í›„ í˜ì´ë“œ ì•„ì›ƒí•˜ê³  íŠœí† ë¦¬ì–¼ ì™„ë£Œ ë©”ì‹œì§€
            k.wait(2, () => {
                k.tween(finalWellDone.opacity, 0, 1, (val) => {
                    finalWellDone.opacity = val;
                }).then(() => {
                    finalWellDone.destroy();
                    showTutorialCompleteMessage();
                });
            });
        });
    }
    
    // íŠœí† ë¦¬ì–¼ ì™„ë£Œ ë©”ì‹œì§€
    function showTutorialCompleteMessage() {
        tutorialStep = 9;
        
        const completeText = k.add([
            k.text("íŠœ í†  ë¦¬ ì–¼ ì„  ëª¨ ë‘  ë§ˆ ì¹˜ ì…¨ ìŠµ ë‹ˆ ë‹¤ .", { 
                size: 26,
                font: "galmuri"
            }),
            k.anchor("center"),
            k.pos(k.center().x, k.center().y),
            k.color(111, 111, 111), // ì‚´ì§ ì˜…ì€ ê²€ì€ìƒ‰
            k.opacity(0),
            k.z(10),
            k.fixed(),
        ]);
        
        // í˜ì´ë“œ ì¸
        k.tween(completeText.opacity, 1, 1, (val) => {
            completeText.opacity = val;
        }).then(() => {
            // 3ì´ˆ í›„ í˜ì´ë“œ ì•„ì›ƒ
            k.wait(3, () => {
                k.tween(completeText.opacity, 0, 1, (val) => {
                    completeText.opacity = val;
                }).then(() => {
                    completeText.destroy();
                    // ì—¬ê¸°ì„œ ë©”ì¸ ê²Œì„ìœ¼ë¡œ ì „í™˜í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì”¬ìœ¼ë¡œ ì´ë™
                    console.log("ğŸ‰ íŠœí† ë¦¬ì–¼ ì™„ì „íˆ ì¢…ë£Œ!");
                });
            });
        });
    }
    
    // Mí‚¤ ìŒì•… í† ê¸€ í•¸ë“¤ëŸ¬
    function handleMusicToggle() {
        // ìŒì•… í† ê¸€ (ê°„ë‹¨í•œ ì˜ˆì‹œ - ì‹¤ì œë¡œëŠ” audioManager ì‚¬ìš©)
        try {
            // í˜„ì¬ ë³¼ë¥¨ ì²´í¬í•´ì„œ í† ê¸€
            const currentVolume = audioManager.getBGMVolume();
            if (currentVolume > 0) {
                audioManager.setBGMVolume(0);
                console.log("ğŸ”‡ ìŒì•… ë”");
            } else {
                audioManager.setBGMVolume(0.5);
                console.log("ğŸ”Š ìŒì•… ì¼¬");
            }
            
            // íŠœí† ë¦¬ì–¼ ì™„ë£Œ
            showFinalComplete();
        } catch (error) {
            console.error("ìŒì•… í† ê¸€ ì‹¤íŒ¨:", error);
            // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ íŠœí† ë¦¬ì–¼ì€ ì™„ë£Œ
            showFinalComplete();
        }
    }

    k.onUpdate(() => {
        if (!player || (tutorialStep !== 1 && tutorialStep !== 4 && tutorialStep !== 7)) {
            // íŠœí† ë¦¬ì–¼ ë‹¨ê³„ê°€ ë°”ë€Œë©´ í‚¤ ìƒíƒœ ì´ˆê¸°í™”
            if (tutorialStep !== 1) {
                keyStates = {
                    left: false,
                    right: false,
                    up: false,
                    down: false
                };
            }
            return; // tutorialStep 7ë„ í—ˆìš©
        }
        
        // ì´ë™ ë²¡í„°
        let moveX = 0;
        let moveY = 0;
        let isMoving = false;
        let direction = null;
        
        // í‚¤ ì…ë ¥ ì²˜ë¦¬ ë° ì• ë‹ˆë©”ì´ì…˜ (Kaboomê³¼ ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸ ëª¨ë‘ ì²´í¬)
        if (k.isKeyDown("left") || keyStates.left) {
            moveX = -MOVE_SPEED * k.dt();
            isMoving = true;
            direction = "left";
        }
        if (k.isKeyDown("right") || keyStates.right) {
            moveX = MOVE_SPEED * k.dt();
            isMoving = true;
            direction = "right";
        }
        if (k.isKeyDown("up") || keyStates.up) {
            moveY = -MOVE_SPEED * k.dt();
            isMoving = true;
            direction = "up";
        }
        if (k.isKeyDown("down") || keyStates.down) {
            moveY = MOVE_SPEED * k.dt();
            isMoving = true;
            direction = "down";
        }
        
        // ë””ë²„ê¹…: í‚¤ ì…ë ¥ í™•ì¸ (ê°„í—ì ìœ¼ë¡œë§Œ)
        if (isMoving && Math.random() < 0.01) { // 1% í™•ë¥ ë¡œë§Œ ë¡œê·¸ ì¶œë ¥
            console.log(`ğŸ® í‚¤ ì…ë ¥ ê°ì§€: ${direction}, moveX: ${moveX.toFixed(2)}, moveY: ${moveY.toFixed(2)}`);
        }
        
        // ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬
        if (isMoving && direction) {
            // ë°©í–¥ì´ ë°”ë€Œì—ˆê±°ë‚˜ ì²˜ìŒ ì›€ì§ì´ê¸° ì‹œì‘í•  ë•Œë§Œ ì• ë‹ˆë©”ì´ì…˜ ë³€ê²½
            if (!isCurrentlyMoving || currentAnimDirection !== direction) {
                console.log(`ğŸ­ ì• ë‹ˆë©”ì´ì…˜ ë³€ê²½: player-${direction}`);
                player.play(`player-${direction}`);
                currentAnimDirection = direction;
            }
            isCurrentlyMoving = true;
        } else {
            // ì›€ì§ì´ì§€ ì•Šì„ ë•ŒëŠ” idle ì• ë‹ˆë©”ì´ì…˜ (í•œ ë²ˆë§Œ)
            if (isCurrentlyMoving) {
                console.log(`ğŸ­ idle ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë³€ê²½: player-idle-${currentAnimDirection}`);
                player.play(`player-idle-${currentAnimDirection}`);
                isCurrentlyMoving = false;
            }
        }
        
        // ì´ë™ ì²˜ë¦¬
        if (isMoving) {
            // tutorialStep 1ì—ì„œ ë°©í–¥ë³„ ì‹œê°„ ì¶”ì 
            if (tutorialStep === 1) {
                // í˜„ì¬ í”„ë ˆì„ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
                const deltaTime = k.dt() * 1000;
                
                // ê° ë°©í–¥ë³„ë¡œ ì‹œê°„ ëˆ„ì 
                if (direction === "left") {
                    updateDirectionTime("left", deltaTime);
                } else if (direction === "right") {
                    updateDirectionTime("right", deltaTime);
                } else if (direction === "up") {
                    updateDirectionTime("up", deltaTime);
                } else if (direction === "down") {
                    updateDirectionTime("down", deltaTime);
                }
                
                // ì²« ë²ˆì§¸ ì´ë™ ê°ì§€ (ê¸°ì¡´ ë¡œì§ì€ ìœ ì§€í•˜ë˜ ìë™ ì§„í–‰ì€ ì œê±°)
                if (!hasPlayerMoved) {
                    hasPlayerMoved = true;
                    console.log("ğŸ‰ í”Œë ˆì´ì–´ ì²« ì´ë™ ê°ì§€!");
                    // ìë™ ì§„í–‰ ì œê±° - ì´ì œ ëª¨ë“  ë°©í–¥ ì™„ë£Œ í›„ì—ë§Œ ì§„í–‰
                }
            }
            
            // ìƒˆë¡œìš´ ìœ„ì¹˜ ê³„ì‚°
            const newX = player.pos.x + moveX;
            const newY = player.pos.y + moveY;
            
            // tutorialStep 1ì—ì„œëŠ” ë°˜ê²½ ì œí•œ, tutorialStep 4ì—ì„œëŠ” ììœ  ì´ë™
            if (tutorialStep === 1) {
                // ì¤‘ì‹¬ì ìœ¼ë¡œë¶€í„°ì˜ ê±°ë¦¬ ê³„ì‚°
                const distanceFromCenter = Math.sqrt(
                    Math.pow(newX - CENTER_X, 2) + Math.pow(newY - CENTER_Y, 2)
                );
                
                // ë°˜ê²½ ë‚´ì—ì„œë§Œ ì´ë™ í—ˆìš©
                if (distanceFromCenter <= MOVE_RADIUS) {
                    player.pos.x = newX;
                    player.pos.y = newY;
                } else {
                    // ë°˜ê²½ì„ ë²—ì–´ë‚˜ëŠ” ê²½ìš°, ë°˜ê²½ ê²½ê³„ì— ìœ„ì¹˜ì‹œí‚´
                    const angle = Math.atan2(newY - CENTER_Y, newX - CENTER_X);
                    player.pos.x = CENTER_X + Math.cos(angle) * MOVE_RADIUS;
                    player.pos.y = CENTER_Y + Math.sin(angle) * MOVE_RADIUS;
                }
            } else if (tutorialStep === 4 || tutorialStep === 7) {
                // tutorialStep 4ì™€ 7ì—ì„œëŠ” ììœ  ì´ë™ (í™”ë©´ ê²½ê³„ë§Œ ì²´í¬)
                const padding = 50;
                player.pos.x = Math.max(padding, Math.min(k.width() - padding, newX));
                player.pos.y = Math.max(padding, Math.min(k.height() - padding, newY));
            }
        }
        
        // tutorialStep 4ì™€ 7ì—ì„œ NPCì™€ì˜ ê·¼ì ‘ ê°ì§€
        if ((tutorialStep === 4 || tutorialStep === 7) && player && npc) {
            const distance = Math.sqrt(
                Math.pow(player.pos.x - npc.pos.x, 2) + 
                Math.pow(player.pos.y - npc.pos.y, 2)
            );
            
            const INTERACTION_DISTANCE = 120; // ìƒí˜¸ì‘ìš© ê°€ëŠ¥ ê±°ë¦¬ (60ì—ì„œ 120ìœ¼ë¡œ ì¦ê°€)
            
            // ë””ë²„ê¹…: ê±°ë¦¬ í‘œì‹œ (ê°„í—ì ìœ¼ë¡œ)
            if (Math.random() < 0.01) { // 1% í™•ë¥ ë¡œë§Œ ë¡œê·¸ ì¶œë ¥
                console.log(`ğŸ“ í”Œë ˆì´ì–´-NPC ê±°ë¦¬: ${distance.toFixed(1)}px (ìƒí˜¸ì‘ìš©: ${INTERACTION_DISTANCE}px)`);
            }
            
            // ê·¼ì ‘ ì—¬ë¶€ë§Œ í™•ì¸ (ë§í’ì„ ì€ ìƒí˜¸ì‘ìš© ì‹œì—ë§Œ í‘œì‹œ)
            if (distance <= INTERACTION_DISTANCE) {
                if (!isNearNPC) {
                    isNearNPC = true;
                    console.log("ğŸ‘« NPC ê·¼ì²˜ì— ë„ì°©! ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ëŒ€í™”í•˜ì„¸ìš”.");
                }
    }
    
    // Friend ìƒí˜¸ì‘ìš© íŠœí† ë¦¬ì–¼
    function showFriendTutorial() {
        tutorialStep = 6;
        
        // NPC ì œê±°
        if (npc) {
            npc.destroy();
        }
        
        // student1 NPC ìƒì„± (í”Œë ˆì´ì–´ ì˜¤ë¥¸ìª½ì—)
        npc = k.add([
            k.sprite("main-assets", { frame: 3781 }), // student1 í”„ë ˆì„ ì‚¬ìš©
            k.anchor("center"),
            k.pos(player.pos.x + 120, player.pos.y), // í”Œë ˆì´ì–´ ì˜¤ë¥¸ìª½ì— 120px ê°„ê²©
            k.scale(3.6), // ê°™ì€ í¬ê¸°
            k.area({ width: 30, height: 86 }), // ì½œë¼ì´ë”ë¥¼ ì‚¬ëŒ í¬ê¸°ì— ë§ê²Œ ì¡°ì •
            k.body({ isStatic: true }), // ì •ì  ì½œë¼ì´ë”
            k.opacity(0), // ì²˜ìŒì—ëŠ” íˆ¬ëª…
            k.z(20),
            "npc",
            "student1" // íƒœê·¸ ë³€ê²½
        ]);
        
        // Friend í˜ì´ë“œ ì¸
        k.tween(npc.opacity, 1, 1, (val) => {
            npc.opacity = val;
        }).then(() => {
            // Friend íŠœí† ë¦¬ì–¼ í…ìŠ¤íŠ¸ í‘œì‹œ
            showFriendTutorialText();
        });
    }
    
    // Friend íŠœí† ë¦¬ì–¼ í…ìŠ¤íŠ¸ í‘œì‹œ
    function showFriendTutorialText() {
        tutorialStep = 7;
        
        const friendText = k.add([
            k.text("ì¹œêµ¬ì—ê²Œ ë‹¤ê°€ê°€ì„œ ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ ë§ì„ ê±°ì„¸ìš”.", { 
                size: 20,
                font: "galmuri",
                width: k.width() - 100,
                align: "center"
            }),
            k.anchor("center"),
            k.pos(k.center().x, k.height() - 120),
            k.color(50, 200, 50), // ë…¹ìƒ‰
            k.opacity(0),
            k.z(10),
            k.fixed(),
            "tutorialText"
        ]);
        
        // í˜ì´ë“œ ì¸
        k.tween(friendText.opacity, 1, 1, (val) => {
            friendText.opacity = val;
        });
    }
    
    // Mí‚¤ ìŒì•… í† ê¸€ í•¸ë“¤ëŸ¬
    function handleMusicToggle() {
        // ìŒì•… í† ê¸€ (ê°„ë‹¨í•œ ì˜ˆì‹œ - ì‹¤ì œë¡œëŠ” audioManager ì‚¬ìš©)
        try {
            if (audioManager.bgmMuted) {
                audioManager.unmuteBGM();
                console.log("ğŸµ BGM ìŒì†Œê±° í•´ì œ");
            } else {
                audioManager.muteBGM();
                console.log("ğŸ”‡ BGM ìŒì†Œê±°");
            }
        } catch (error) {
            console.log("ğŸµ ìŒì•… í† ê¸€ ì™„ë£Œ (audioManager ì—†ìŒ)");
        }
        
        // Mí‚¤ íŠœí† ë¦¬ì–¼ ì™„ë£Œ ë©”ì‹œì§€
        tutorialStep = 10;
        
        // ê¸°ì¡´ í…ìŠ¤íŠ¸ë“¤ ì œê±°
        k.destroyAll("tutorialText");
        
        // "ì˜í–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€
        const finalWellDone = k.add([
            k.text("ì˜í–ˆìŠµë‹ˆë‹¤!", {
                font: "galmuri",
                size: 28,
                align: "center"
            }),
            k.color(50, 200, 50), // ë…¹ìƒ‰
            k.pos(k.center().x, k.height() - 120),
            k.anchor("center"),
            k.opacity(0),
            k.z(10),
            k.fixed(),
        ]);
        
        // í˜ì´ë“œ ì¸
        k.tween(finalWellDone.opacity, 1, 1, (val) => {
            finalWellDone.opacity = val;
        }).then(() => {
            // 2ì´ˆ í›„ í˜ì´ë“œ ì•„ì›ƒí•˜ê³  ìµœì¢… ì™„ë£Œ ë©”ì‹œì§€
            k.wait(2, () => {
                k.tween(finalWellDone.opacity, 0, 1, (val) => {
                    finalWellDone.opacity = val;
                }).then(() => {
                    finalWellDone.destroy();
                    showTutorialCompleteMessage();
                });
            });
        });
    }

    // ì”¬ ì •ë¦¬
    k.onSceneLeave(() => {
        document.body.style.backgroundColor = '';
        
        // ë¸Œë¼ìš°ì € í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        if (documentKeyHandler) {
            document.removeEventListener('keydown', documentKeyHandler);
            document.removeEventListener('keyup', documentKeyHandler);
        }
        
        // ëŒ€í™” ì‹œìŠ¤í…œ ì •ë¦¬
        k.destroyAll("tutorialDialog");
        
        // í˜ì´ë“œ ì˜¤ë²„ë ˆì´ ì •ë¦¬ (í˜¹ì‹œ ë‚¨ì•„ìˆë‹¤ë©´)
        const fadeOverlays = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 10000"]');
        fadeOverlays.forEach(overlay => {
            if (overlay.parentNode) {
                document.body.removeChild(overlay);
                console.log("ğŸ§¹ Tutorial í˜ì´ë“œ ì˜¤ë²„ë ˆì´ ì •ë¦¬ë¨");
            }
        });
        console.log("âœ… Tutorial ì”¬ ì¢…ë£Œ");
    });

    // ìƒí˜¸ì‘ìš© ê°ì§€ ì‹œìŠ¤í…œ
    k.onUpdate(() => {
        if (!player || !npc || (tutorialStep !== 4 && tutorialStep !== 7)) return;
        
        // í”Œë ˆì´ì–´ì™€ NPC ê°„ì˜ ê±°ë¦¬ ê³„ì‚°
        const distance = player.pos.dist(npc.pos);
        
        // ì´ë™ ì¶”ì  ë° ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬ (tutorialStep 1ì—ì„œë§Œ)
        if (tutorialStep === 1 && player) {
            const deltaTime = k.dt() * 1000; // ë°€ë¦¬ì´ˆë¡œ ë³€í™˜
            
            // í‚¤ ìƒíƒœì— ë”°ë¥¸ ì´ë™ ì²˜ë¦¬
            let isMoving = false;
            const moveVector = k.vec2(0, 0);
            
            if (keyStates.left) {
                moveVector.x -= MOVE_SPEED * k.dt();
                updateDirectionTime('left', deltaTime);
                isMoving = true;
            }
            if (keyStates.right) {
                moveVector.x += MOVE_SPEED * k.dt();
                updateDirectionTime('right', deltaTime);
                isMoving = true;
            }
            if (keyStates.up) {
                moveVector.y -= MOVE_SPEED * k.dt();
                updateDirectionTime('up', deltaTime);
                isMoving = true;
            }
            if (keyStates.down) {
                moveVector.y += MOVE_SPEED * k.dt();
                updateDirectionTime('down', deltaTime);
                isMoving = true;
            }
            
            // ì´ë™ ì œí•œ (ë°˜ê²½ ë‚´ì—ì„œë§Œ)
            const newPos = player.pos.add(moveVector);
            const distanceFromCenter = newPos.dist(k.vec2(CENTER_X, CENTER_Y));
            
            if (distanceFromCenter <= MOVE_RADIUS) {
                player.pos = newPos;
                hasPlayerMoved = true;
            }
            
            // ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬
            if (isMoving) {
                let direction = "down"; // ê¸°ë³¸ê°’
                
                // ìš°ì„ ìˆœìœ„: ìƒí•˜ > ì¢Œìš°
                if (keyStates.up) {
                    direction = "up";
                } else if (keyStates.down) {
                    direction = "down";
                } else if (keyStates.left) {
                    direction = "left";
                } else if (keyStates.right) {
                    direction = "right";
                }
                
                if (currentAnimDirection !== direction || !isCurrentlyMoving) {
                    player.play(`player-walk-${direction}`);
                    currentAnimDirection = direction;
                    isCurrentlyMoving = true;
                }
            } else {
                if (isCurrentlyMoving) {
                    player.play(`player-idle-${currentAnimDirection}`);
                    isCurrentlyMoving = false;
                }
            }
        }
        
        // ìƒí˜¸ì‘ìš© ê°ì§€ (tutorialStep 4, 7ì—ì„œë§Œ)
        if ((tutorialStep === 4 || tutorialStep === 7) && player && npc) {
            // ìƒí˜¸ì‘ìš© ê±°ë¦¬ (100px)
            if (distance <= 100) {
                if (!isNearNPC) {
                    isNearNPC = true;
                    console.log("ğŸ’¬ NPCì— ê°€ê¹Œì›Œì§, ìƒí˜¸ì‘ìš© ê°€ëŠ¥");
                    
                    // í•˜íŠ¸ í‘œì‹œ
                    if (exclamationMark) {
                        exclamationMark.destroy();
                    }
                    exclamationMark = k.add([
                        k.sprite("main-assets", { frame: 5777 }), // heart ìŠ¤í”„ë¼ì´íŠ¸ ì‚¬ìš©
                        k.pos(npc.pos.x, npc.pos.y - 60), // NPC ìœ„ìª½ì— í‘œì‹œ
                        k.anchor("center"),
                        k.scale(2), // ê¸°ë³¸ í¬ê¸° 2ë°°
                        k.z(1000),
                        "interaction-indicator"
                    ]);
                    
                    // í•˜íŠ¸ ì• ë‹ˆë©”ì´ì…˜ (ìœ„ì•„ë˜ë¡œ ì²œì²œíˆ ì›€ì§ì„)
                    const originalY = exclamationMark.pos.y;
                    const floatTween = () => {
                        if (exclamationMark) {
                            k.tween(exclamationMark.pos.y, originalY - 10, 1, (val) => {
                                if (exclamationMark) exclamationMark.pos.y = val;
                            }).then(() => {
                                if (exclamationMark) {
                                    k.tween(exclamationMark.pos.y, originalY, 1, (val) => {
                                        if (exclamationMark) exclamationMark.pos.y = val;
                                    }).then(() => {
                                        if (exclamationMark) {
                                            floatTween();
                                        }
                                    });
                                }
                            });
                        }
                    };
                    floatTween();
                }
            } else {
                if (isNearNPC) {
                    isNearNPC = false;
                    console.log("ï¿½ NPCì—ì„œ ë©€ì–´ì§");
                    
                    // í•˜íŠ¸ í‘œì‹œ ì œê±°
                    if (exclamationMark) {
                        exclamationMark.destroy();
                        exclamationMark = null;
                    }
                }
            }
        }
    });
}
