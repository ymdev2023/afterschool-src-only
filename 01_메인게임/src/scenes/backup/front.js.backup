import { healthBar } from "../uiComponents/healthbar.js";
import {
    generatePlayerComponents,
    generateFrontPlayerComponents,
    setPlayerControls,
    watchPlayerHealth,
} from "../entities/player.js";
import { generateNoteComponents } from "../entities/note.js";
import { gameState } from "../state/stateManagers.js";
import { fadeInBGM } from "../utils.js";

import {
    colorizeBackground,
    fetchMapData,
    drawBoundaries,
    onAttacked,
    onCollideWithPlayer,
} from "../utils.js";


import dialogues from "../content/Dialogue.js";
import objectDialogues from "../content/objectDialogue.js";

import {
    toggleLocale,
    toggleMute,
    setupMainMenuShortcut,
    initializeQuestBubbles,
    updateQuestBubbles,
    SPEECH_BUBBLE_STATES,
} from "../utils.js";

// ì¶”ê°€ëœ ë¶€ë¶„: ì¶©ëŒ ì‹œ í¬ë¬¼ì„  í‚¥ í•¨ìˆ˜
function kickBallOnCollision(k, ball, player) {
    const currentTime = Date.now();
    const KICK_COOLDOWN = 1000; // 1ì´ˆ ì¿¨ë‹¤ìš´

    // ì¿¨ë‹¤ìš´ ì²´í¬
    if (currentTime - ball.lastKickTime < KICK_COOLDOWN) {
        return;
    }

    ball.lastKickTime = currentTime;

    // í”Œë ˆì´ì–´ì™€ ê³µì˜ ìœ„ì¹˜ ì°¨ì´ë¡œ í‚¥ ë°©í–¥ ê³„ì‚°
    const kickDirection = ball.pos.sub(player.pos).unit();
    const kickDistance = 100;
    const kickHeight = 20;

    // ëª©í‘œ ìœ„ì¹˜ ê³„ì‚°
    const targetPos = ball.pos.add(kickDirection.scale(kickDistance));

    // í‚¥ íš¨ê³¼ìŒ ì¬ìƒ
    k.play("boop-sfx");
    k.play("kick-sfx");

    // ê¸°ì¨ì˜ ë§í’ì„  í‘œì‹œ
    k.wait(0.7, () => {
        showJoyBubble(k, player);
    });

    // í¬ë¬¼ì„  ì• ë‹ˆë©”ì´ì…˜
    const startPos = ball.pos.clone();
    const duration = 0.8;
    let animTime = 0;

    ball.isMoving = true;

    if (ball.body) {
        ball.body.vel = k.vec2(0, 0);
    }

    const animateParabola = () => {
        animTime += k.dt();
        const progress = Math.min(animTime / duration, 1);

        if (progress >= 1) {
            ball.pos = targetPos;
            ball.isMoving = false;

            if (ball.body) {
                ball.body.vel = k.vec2(0, 0);
            }

            console.log("ğŸ¾ ê³µì´ í¬ë¬¼ì„ ì„ ê·¸ë¦¬ë©° ë‚ ì•„ê°”ìŠµë‹ˆë‹¤!");
            return;
        }

        const x = k.lerp(startPos.x, targetPos.x, progress);
        const baseY = k.lerp(startPos.y, targetPos.y, progress);
        const parabolaOffset = kickHeight * Math.sin(progress * Math.PI);
        const y = baseY - parabolaOffset;

        ball.pos = k.vec2(x, y);

        k.wait(0, animateParabola);
    };

    animateParabola();

    console.log("ğŸ¦µ í”Œë ˆì´ì–´ê°€ ê³µì— ì¶©ëŒí•˜ì—¬ í¬ë¬¼ì„  í‚¥!");
}

// ì¶”ê°€ëœ ë¶€ë¶„: í”Œë ˆì´ì–´ ìœ„ì— ê¸°ì¨ì˜ ë§í’ì„ ì„ ë„ìš°ëŠ” í•¨ìˆ˜
function showJoyBubble(k, player) {
    if (player.joyBubble && player.joyBubble.exists()) {
        player.joyBubble.destroy();
    }

    const BUBBLE_OFFSET_X = 5; 
    const BUBBLE_OFFSET_Y = -14;

    const joyBubble = k.add([
        k.sprite("tiny-speech-indicators", {
            frame: SPEECH_BUBBLE_STATES.VERY_HAPPY,
        }),
        k.pos(player.pos.x + BUBBLE_OFFSET_X, player.pos.y + BUBBLE_OFFSET_Y),
        k.scale(1.176), // 1.68ì˜ 70%: 1.68 * 0.7 = 1.176
        k.z(20),
        k.opacity(1.0),
        "joy-bubble",
    ]);

    let time = 0;

    joyBubble.onUpdate(() => {
        time += k.dt();

        if (player.exists()) {
            joyBubble.pos.x = player.pos.x + BUBBLE_OFFSET_X;
            if (time < 0.1) {
                joyBubble.pos.y = player.pos.y + BUBBLE_OFFSET_Y;
            } else {
                joyBubble.pos.y =
                    player.pos.y +
                    BUBBLE_OFFSET_Y +
                    Math.sin((time - 0.1) * 4) * 3;
            }
        }
    });

    player.joyBubble = joyBubble;

    k.wait(2, () => {
        if (joyBubble.exists()) {
            k.tween(
                joyBubble.opacity,
                0,
                0.5,
                (val) => {
                    joyBubble.opacity = val;
                },
                k.easings.easeOutQuad
            ).then(() => {
                if (joyBubble.exists()) {
                    joyBubble.destroy();
                }
            });
        }
    });
}

// í€˜ìŠ¤íŠ¸ UI ì‹œìŠ¤í…œ
function setupQuestUI(k, gameState) {
    // í€˜ìŠ¤íŠ¸ ìƒíƒœ ê´€ë¦¬
    const questState = {
        hasNewQuests: true, // ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ ì—¬ë¶€
        isPopupOpen: false,
    };

    // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ (í™”ë©´ ìš°ì¸¡ ìƒë‹¨)
    const questIcon = k.add([
        k.sprite("front-assets", {
            frame: questState.hasNewQuests ? 5771 : 5770, // ì—´ë¦°í¸ì§€ : ë‹«íŒí¸ì§€
        }),
        k.pos(k.width() - 60, 20), // í™”ë©´ ìš°ì¸¡ ìƒë‹¨
        k.scale(2),
        k.z(100),
        k.area(),
        k.fixed(), // ì¹´ë©”ë¼ ì´ë™ì— ê³ ì •
        "quest-icon",
    ]);

    // í€˜ìŠ¤íŠ¸ íŒì—… ë°°ê²½
    let questPopup = null;
    let questPopupContent = null;
    let closeButton = null;

    // í€˜ìŠ¤íŠ¸ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸
    questIcon.onClick(() => {
        if (questState.isPopupOpen) {
            closeQuestPopup();
        } else {
            openQuestPopup();
        }
    });

    // í€˜ìŠ¤íŠ¸ íŒì—… ì—´ê¸°
    function openQuestPopup() {
        if (questState.isPopupOpen) return;

        questState.isPopupOpen = true;

        // íŒì—… ë°°ê²½
        questPopup = k.add([
            k.rect(k.width() * 0.8, k.height() * 0.7),
            k.pos(k.width() * 0.1, k.height() * 0.15),
            k.color(20, 20, 40),
            k.outline(4, k.Color.WHITE),
            k.z(150),
            k.fixed(),
            "quest-popup",
            "quest-popup-element", // íƒœê·¸ ì¶”ê°€
        ]);

        // íŒì—… ì œëª©
        const title = k.add([
            k.text("Quest Log", {
                size: 32,
                font: "galmuri",
            }),
            k.pos(k.width() * 0.15, k.height() * 0.2),
            k.color(255, 255, 255),
            k.z(151),
            k.fixed(),
            "quest-popup-element", // íƒœê·¸ ì¶”ê°€
        ]);

        // íŒì—… ë‚´ìš© (ì„ì‹œ)
        questPopupContent = k.add([
            k.text("â€¢ Welcome to the school!\nâ€¢ Explore the campus\nâ€¢ Talk to other students\nâ€¢ Find the main entrance", {
                size: 20,
                font: "galmuri",
                width: k.width() * 0.7,
            }),
            k.pos(k.width() * 0.15, k.height() * 0.3),
            k.color(200, 200, 200),
            k.z(151),
            k.fixed(),
            "quest-popup-element", // íƒœê·¸ ì¶”ê°€
        ]);

        // ë‹«ê¸° ë²„íŠ¼
        closeButton = k.add([
            k.rect(80, 40),
            k.pos(k.width() * 0.8, k.height() * 0.75),
            k.color(60, 60, 80),
            k.outline(2, k.Color.WHITE),
            k.area(),
            k.z(151),
            k.fixed(),
            "close-button",
            "quest-popup-element", // íƒœê·¸ ì¶”ê°€
        ]);

        const closeButtonText = k.add([
            k.text("Close", {
                size: 16,
                font: "galmuri",
            }),
            k.pos(k.width() * 0.82, k.height() * 0.76),
            k.color(255, 255, 255),
            k.z(152),
            k.fixed(),
            "quest-popup-element", // íƒœê·¸ ì¶”ê°€
        ]);

        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        closeButton.onClick(() => {
            closeQuestPopup();
        });

        // í€˜ìŠ¤íŠ¸ë¥¼ í™•ì¸í–ˆìœ¼ë¯€ë¡œ ì•„ì´ì½˜ì„ ë‹«íŒí¸ì§€ë¡œ ë³€ê²½
        if (questState.hasNewQuests) {
            questState.hasNewQuests = false;
            questIcon.frame = 5770; // ë‹«íŒí¸ì§€
        }
    }

    // í€˜ìŠ¤íŠ¸ íŒì—… ë‹«ê¸°
    function closeQuestPopup() {
        if (!questState.isPopupOpen) return;

        questState.isPopupOpen = false;

        // í€˜ìŠ¤íŠ¸ íŒì—… ê´€ë ¨ ëª¨ë“  ìš”ì†Œ ì œê±°
        k.get("quest-popup-element").forEach(obj => {
            if (obj.exists()) {
                obj.destroy();
            }
        });
        
        // ì¶”ê°€ ì•ˆì „ì¥ì¹˜: ê° ë³€ìˆ˜ë“¤ ì§ì ‘ ì œê±°
        if (questPopup && questPopup.exists()) {
            questPopup.destroy();
            questPopup = null;
        }
        
        if (questPopupContent && questPopupContent.exists()) {
            questPopupContent.destroy();
            questPopupContent = null;
        }
        
        if (closeButton && closeButton.exists()) {
            closeButton.destroy();
            closeButton = null;
        }
    }

    // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
    k.onKeyPress("escape", () => {
        if (questState.isPopupOpen) {
            closeQuestPopup();
        }
    });

    // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì•„ì´ì½˜ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    k.onResize(() => {
        questIcon.pos = k.vec2(k.width() - 60, 20);
    });

    // ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸ ì¶”ê°€ í•¨ìˆ˜ (ë‚˜ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡)
    return {
        addNewQuest: () => {
            questState.hasNewQuests = true;
            questIcon.frame = 5771; // ì—´ë¦°í¸ì§€
        },
        markQuestsAsRead: () => {
            questState.hasNewQuests = false;
            questIcon.frame = 5770; // ë‹«íŒí¸ì§€
        }
    };
}

export default async function front(k) {
    console.log("ğŸŒŸ Front ì”¬ ì‹œì‘");
    fadeInBGM(k, "rpg-front-bgm");

    const previousScene = gameState.getPreviousScene();

    // ì–¸ì–´ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì •
    gameState.setLocale("korean");

    colorizeBackground(k, 173, 216, 230); // ì—°í•œ íŒŒë€ìƒ‰ ë°°ê²½ (í•˜ëŠ˜ìƒ‰)
    
    const entities = {
        player: null,
        cars: [],
        objects: [],
    };
    
    let map;
    
    try {
        const mapData = await fetchMapData("./assets/images/front.json");
        console.log("ğŸ—ºï¸ Front ë§µ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", mapData);
        map = k.add([k.pos(0, 0)]);

        const layers = mapData.layers;
        console.log("ğŸ—ºï¸ ë ˆì´ì–´ ì •ë³´:", layers.map(l => ({ name: l.name, type: l.type, objects: l.objects?.length || 'N/A' })));
        
    for (const layer of layers) {
        if (layer.name === "boundaries") {
            console.log("ğŸš§ Boundaries ë ˆì´ì–´ ë°œê²¬:", layer);
            console.log("ğŸš§ Layer offset:", layer.offsetx, layer.offsety);
            // boundaries ë ˆì´ì–´ì—ì„œ íŠ¹ë³„í•œ ì˜¤ë¸Œì íŠ¸ë“¤ ì²˜ë¦¬
            for (const object of layer.objects) {
                console.log(`ğŸ¯ ë°œê²¬ëœ boundary ì˜¤ë¸Œì íŠ¸: ${object.name} at (${object.x}, ${object.y}) size: ${object.width}x${object.height}`);
                if (
                    [
                        "car1",
                        "car2", // car2 ì¶”ê°€
                        "car3", 
                        "car4",
                        "pot", // pot1, pot2ë¥¼ potìœ¼ë¡œ í†µí•©
                        "guryeong",
                        "sink",
                        "goal_post1",
                        "goal_post2",
                        "line_machine",
                        "badminton",
                        "main_entrance",
                        "front_gate", // front_gate ì¶”ê°€
                        "ball", // ball ì¶”ê°€
                        "cat1", // cat1 ì¶”ê°€
                        "cat2", // cat2 ì¶”ê°€
                        "nca", // nca ì¶”ê°€
                        "badminton", // badminton ì¶”ê°€
                    ].includes(object.name)
                ) {
                    const objectType = object.name;

                    // Tiled ì¢Œí‘œê³„ì— ë§ì¶° ìœ„ì¹˜ ì¡°ì • (24x24 íƒ€ì¼ í¬ê¸° ê³ ë ¤, offsety ì ìš©)
                    const objectEntity = map.add([
                        k.rect(object.width, object.height),
                        k.area(),
                        k.body({ isStatic: true }),
                        k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0) - 12), // Y ìœ„ì¹˜ë¥¼ 12í”½ì…€ ìœ„ë¡œ ì¡°ì •
                        k.opacity(0), // íˆ¬ëª…í•˜ê²Œ ì„¤ì •
                        objectType,
                        "interactive-object",
                        { objectType },
                    ]);

                    // main_entranceì˜ ê²½ìš° schoolfrontë¡œ ì´ë™
                    objectEntity.onCollideUpdate("player", (player) => {
                        if (objectType === "main_entrance") {
                            console.log("ğŸšª ë©”ì¸ ì…êµ¬ ê°ì§€ë¨!");
                            k.play("boop-sfx");
                            k.go("schoolfront");
                            return;
                        }

                        if (objectType === "front_gate") {
                            console.log("ğŸšª ì •ë¬¸ ê°ì§€ë¨!");
                            const locale = gameState.getLocale();
                            const content = objectDialogues[locale]?.["front_gate"] || [
                                "This is the school's front gate. You can leave the school from here.",
                                "í•™êµ ì •ë¬¸ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œ í•™êµë¥¼ ë‚˜ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                            ];

                            const speakerName =
                                objectDialogues.names[locale]?.["front_gate"] ||
                                "Front Gate";

                            gameState.setInteractableObject(
                                objectEntity,
                                "object",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                            return;
                        }

                        // ball (í”¼êµ¬ê³µ) ì²˜ë¦¬ - ë¬¼ë¦¬ì ìœ¼ë¡œ ì°¨ì¼ ìˆ˜ ìˆëŠ” ì˜¤ë¸Œì íŠ¸
                        if (objectType === "ball") {
                            console.log("âš½ í”¼êµ¬ê³µ ê°ì§€ë¨!");
                            
                            // ê¸°ì¡´ objectEntity ì œê±°
                            objectEntity.destroy();
                            
                            // ìƒˆë¡œìš´ ball ì—”í‹°í‹° ìƒì„±
                            const ball = map.add([
                                k.sprite("front-assets", {
                                    frame: 5296, // main.jsì— ì •ì˜ëœ ball ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                                }),
                                k.area({
                                    shape: new k.Rect(k.vec2(0), 24, 24),
                                }),
                                k.body({
                                    isStatic: true,
                                    mass: 1,
                                    restitution: 0.6,
                                }),
                                k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0) - 12), // Y ìœ„ì¹˜ë¥¼ 12í”½ì…€ ìœ„ë¡œ ì¡°ì •
                                k.z(1),
                                "ball",
                                "kickable",
                                {
                                    objectType: "ball",
                                    lastKickTime: 0,
                                    isMoving: false,
                                },
                            ]);

                            ball.onCollideUpdate("player", (player) => {
                                if (!ball.isMoving) {
                                    kickBallOnCollision(k, ball, player);
                                }
                            });
                            
                            console.log("âš½ í”¼êµ¬ê³µ ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:", ball.pos);
                            return;
                        }

                        // cat1, cat2 ì²˜ë¦¬
                        if (objectType === "cat1" || objectType === "cat2") {
                            console.log(`ğŸ± ${objectType} ê°ì§€ë¨!`);
                            
                            // ê¸°ì¡´ objectEntity ì œê±°
                            objectEntity.destroy();
                            
                            // ìƒˆë¡œìš´ cat ì—”í‹°í‹° ìƒì„±
                            const cat = map.add([
                                k.sprite("front-assets", {
                                    frame: objectType === "cat1" ? 3784 : 3783, // main.jsì— ì •ì˜ëœ cat ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                                }),
                                k.area(),
                                k.body({ isStatic: true }),
                                k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0) - 12), // Y ìœ„ì¹˜ë¥¼ 12í”½ì…€ ìœ„ë¡œ ì¡°ì •
                                k.z(1),
                                objectType,
                                "interactive-object",
                                { objectType },
                            ]);

                            cat.onCollideUpdate("player", (player) => {
                                const locale = gameState.getLocale();
                                const content = dialogues[locale]?.[objectType] || [
                                    "Meow~",
                                    "ì•¼ì˜¹~",
                                ];

                                const speakerName =
                                    dialogues.names[locale]?.[objectType] ||
                                    (objectType === "cat1" ? "Cat" : "Another Cat");

                                gameState.setInteractableObject(
                                    cat,
                                    "npc",
                                    {
                                        content: content,
                                        speakerName: speakerName,
                                        speakerImage: null,
                                    }
                                );
                            });

                            cat.onCollideEnd("player", () => {
                                gameState.clearInteractableObject();
                            });
                            
                            console.log(`ï¿½ ${objectType} ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:`, cat.pos);
                            return;
                        }

                        // nca ì²˜ë¦¬
                        if (objectType === "nca") {
                            console.log("ğŸ“„ NCA ì „ë‹¨ì§€ ê°ì§€ë¨!");
                            
                            // ê¸°ì¡´ objectEntity ì œê±°
                            objectEntity.destroy();
                            
                            // ìƒˆë¡œìš´ nca ì—”í‹°í‹° ìƒì„±
                            const nca = map.add([
                                k.sprite("front-assets", {
                                    frame: 5298, // main.jsì— ì •ì˜ëœ nca ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                                }),
                                k.area(),
                                k.body({ isStatic: true }),
                                k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0) - 12), // Y ìœ„ì¹˜ë¥¼ 12í”½ì…€ ìœ„ë¡œ ì¡°ì •
                                k.z(1),
                                objectType,
                                "interactive-object",
                                { objectType },
                            ]);

                            nca.onCollideUpdate("player", (player) => {
                                const locale = gameState.getLocale();
                                const content = objectDialogues[locale]?.[objectType] || [
                                    "NCA recruitment flyer.",
                                    "NCA ëª¨ì§‘ ì „ë‹¨ì§€ì…ë‹ˆë‹¤.",
                                ];

                                const speakerName =
                                    objectDialogues.names[locale]?.[objectType] ||
                                    "NCA Flyer";

                                gameState.setInteractableObject(
                                    nca,
                                    "object",
                                    {
                                        content: content,
                                        speakerName: speakerName,
                                        speakerImage: null,
                                    }
                                );
                            });

                            nca.onCollideEnd("player", () => {
                                gameState.clearInteractableObject();
                            });
                            
                            console.log("ï¿½ NCA ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:", nca.pos);
                            return;
                        }

                        // ìƒí˜¸ì‘ìš© ê°€ëŠ¥í•œ ê°ì²´ë¡œ ì„¤ì •
                        const locale = gameState.getLocale();
                        const content = objectDialogues[locale]?.[
                            objectType
                        ] || [
                            `This is ${objectType}`,
                            `ì´ê²ƒì€ ${objectType}ì…ë‹ˆë‹¤`,
                        ];

                        const speakerName =
                            objectDialogues.names[locale]?.[objectType] ||
                            objectType;

                        gameState.setInteractableObject(
                            objectEntity,
                            "object",
                            {
                                content: content,
                                speakerName: speakerName,
                                speakerImage: null,
                            }
                        );
                    });

                    objectEntity.onCollideEnd("player", (player) => {
                        if (objectType !== "main_entrance" && objectType !== "front_gate") {
                            gameState.clearInteractableObject();
                        }
                    });

                    if (objectType.startsWith("car")) {
                        entities.cars.push(objectEntity);
                    } else {
                        entities.objects.push(objectEntity);
                    }
                }
            }

            // drawBoundaries ëŒ€ì‹  front.jsonì— ë§ëŠ” ì»¤ìŠ¤í…€ boundary ì²˜ë¦¬
            for (const object of layer.objects) {
                // ì´ë¯¸ ì²˜ë¦¬í•œ íŠ¹ë³„í•œ ì˜¤ë¸Œì íŠ¸ë“¤ì€ ì œì™¸
                if ([
                    "car1", "car2", "car3", "car4", 
                    "pot", "guryeong", "sink",
                    "goal_post1", "goal_post2", "line_machine", 
                    "badminton", "main_entrance", "front_gate",
                    "ball", "cat1", "cat2", "nca", "badminton"
                ].includes(object.name)) {
                    continue;
                }

                // ì¼ë°˜ ê²½ê³„ì„  ì²˜ë¦¬ (ì´ë¦„ì´ ì—†ëŠ” ë²½ë“¤)
                const tag = object.name !== "" ? object.name : object.type || "wall";
                
                console.log(`ğŸ§± ì¼ë°˜ ê²½ê³„ì„  ìƒì„±: ${tag} at (${object.x}, ${object.y}) size: ${object.width}x${object.height}`);
                
                const collider = map.add([
                    k.rect(object.width, object.height),
                    k.pos(object.x + (layer.offsetx || 0), object.y + (layer.offsety || 0)), // front.jsonì— ë§ëŠ” offset ì ìš©
                    k.area(),
                    k.body({ isStatic: true }),
                    k.opacity(0), // íˆ¬ëª…í•˜ê²Œ ì„¤ì •
                    tag,
                ]);
            }
            continue;
        }

        if (layer.name === "cha") {
            console.log("ğŸ‘¥ ìºë¦­í„°(cha) ë ˆì´ì–´ ë°œê²¬:", layer);
            if (layer.objects && layer.objects.length > 0) {
                console.log("ï¿½ ìºë¦­í„° ì˜¤ë¸Œì íŠ¸ë“¤:", layer.objects);
                for (const object of layer.objects) {
                    console.log(`ğŸ‘¤ ë°œê²¬ëœ ìºë¦­í„°: ${object.name} at (${object.x}, ${object.y})`);
                    
                    // director ì²˜ë¦¬
                    if (object.name === "director") {
                        console.log("ğŸ‘¨â€ğŸ« í•™ë…„ë¶€ì¥ ì„ ìƒë‹˜ ê°ì§€ë¨! (cha ë ˆì´ì–´)");
                        const locale = gameState.getLocale();
                        const content = dialogues[locale]?.["director"] || [
                            "Hello, I'm the grade director.",
                            "ì•ˆë…•í•˜ì„¸ìš”, í•™ë…„ë¶€ì¥ì…ë‹ˆë‹¤.",
                        ];

                        const speakerName =
                            dialogues.names[locale]?.["director"] ||
                            "Grade Director";

                        const directorEntity = map.add([
                            k.sprite("front-assets", {
                                anim: "director",
                            }),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(0.5), // í”Œë ˆì´ì–´(z=1)ë³´ë‹¤ ë’¤ì— ë°°ì¹˜
                            "director",
                            "interactive-object",
                            { objectType: "director" },
                        ]);

                        directorEntity.onCollideUpdate("player", (player) => {
                            gameState.setInteractableObject(
                                directorEntity,
                                "npc",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                        });

                        directorEntity.onCollideEnd("player", () => {
                            gameState.clearInteractableObject();
                        });

                        entities.objects.push(directorEntity);
                        continue;
                    }

                    // facil ì²˜ë¦¬
                    if (object.name === "facil") {
                        console.log("ğŸ‘¨â€ğŸ’¼ êµê° ì„ ìƒë‹˜ ê°ì§€ë¨! (cha ë ˆì´ì–´)");
                        const locale = gameState.getLocale();
                        const content = dialogues[locale]?.["facil"] || [
                            "Hello! I'm the vice principal.",
                            "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” êµê°ì…ë‹ˆë‹¤.",
                        ];

                        const speakerName =
                            dialogues.names[locale]?.["facil"] ||
                            "Vice Principal";

                        const facilEntity = map.add([
                            k.sprite("front-assets", {
                                anim: "facil",
                            }),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(0.5), // í”Œë ˆì´ì–´(z=1)ë³´ë‹¤ ë’¤ì— ë°°ì¹˜
                            "facil",
                            "interactive-object",
                            { objectType: "facil" },
                        ]);

                        facilEntity.onCollideUpdate("player", (player) => {
                            gameState.setInteractableObject(
                                facilEntity,
                                "npc",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                        });

                        facilEntity.onCollideEnd("player", () => {
                            gameState.clearInteractableObject();
                        });

                        entities.objects.push(facilEntity);
                        continue;
                    }
                }
            } else {
                console.log("âš ï¸ cha ë ˆì´ì–´ëŠ” ìˆì§€ë§Œ ì˜¤ë¸Œì íŠ¸ê°€ ì—†ìŒ");
            }
            continue;
        }

        if (layer.name === "spawnpoints") {
            console.log("ğŸ¯ Spawnpoints ë ˆì´ì–´ ë°œê²¬:", layer);
            // spawnpoints ë ˆì´ì–´ê°€ ìˆì§€ë§Œ objectsê°€ ìˆëŠ”ì§€ í™•ì¸
            if (layer.objects && layer.objects.length > 0) {
                console.log("ğŸ“ ìŠ¤í°í¬ì¸íŠ¸ ì˜¤ë¸Œì íŠ¸ë“¤:", layer.objects);
                for (const object of layer.objects) {
                    console.log(`ğŸ² ë°œê²¬ëœ ì˜¤ë¸Œì íŠ¸: ${object.name} at (${object.x}, ${object.y})`);
                    
                    // front ì”¬ì—ì„œëŠ” ê¸°ë³¸ player ìŠ¤í°í¬ì¸íŠ¸ë§Œ ì‚¬ìš©
                    if (object.name === "player") {
                        console.log("ğŸ® í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸ ë°œê²¬:", object);
                        entities.player = map.add(
                            generateFrontPlayerComponents(k, k.vec2(object.x, object.y))
                        );
                        continue;
                    }

                    // schoolfrontì—ì„œ ëŒì•„ì˜¨ ê²½ìš°
                    if (
                        object.name === "player2" &&
                        previousScene === "schoolfront"
                    ) {
                        console.log("ğŸšª í•™êµì—ì„œ ëŒì•„ì˜¨ í”Œë ˆì´ì–´ ìŠ¤í°í¬ì¸íŠ¸ ì‚¬ìš©:", object);
                        entities.player = map.add(
                            generateFrontPlayerComponents(k, k.vec2(object.x, object.y))
                        );
                        continue;
                    }

                    // NPCë“¤ ì²˜ë¦¬ - directorì™€ facilì€ ì´ì œ spawnpointsì—ì„œ ì²˜ë¦¬
                    // if (object.name === "director") {
                    //     const director = map.add([
                    //         k.sprite("front-assets", {
                    //             anim: "director",
                    //         }),
                    //         k.area(),
                    //         k.body({ isStatic: true }),
                    //         k.pos(object.x, object.y),
                    //         k.z(1),
                    //         "director",
                    //         { npcType: "director" },
                    //     ]);

                    //     director.onCollideUpdate("player", (player) => {
                    //         const locale = gameState.getLocale();
                    //         const content = npcDialogues[locale]?.["director"] || [
                    //             "Hello! I'm the director of this school.",
                    //             "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì´ í•™êµì˜ êµì¥ì…ë‹ˆë‹¤.",
                    //         ];

                    //         const speakerName =
                    //             npcDialogues.names[locale]?.["director"] ||
                    //             "Director";

                    //         gameState.setInteractableObject(director, "npc", {
                    //             content: content,
                    //             speakerName: speakerName,
                    //             speakerImage: null,
                    //         });
                    //     });

                    //     director.onCollideEnd("player", (player) => {
                    //         gameState.clearInteractableObject();
                    //     });
                    //     continue;
                    // }

                    // cat1, cat2 ì²˜ë¦¬ (spawnpoints ë ˆì´ì–´ì—ì„œ)
                    if (object.name === "cat1" || object.name === "cat2") {
                        console.log(`ğŸ± ${object.name} ê°ì§€ë¨! (spawnpoints ë ˆì´ì–´)`);
                        
                        const objectType = object.name;
                        const cat = map.add([
                            k.sprite("front-assets", {
                                frame: objectType === "cat1" ? 3784 : 3783, // main.jsì— ì •ì˜ëœ cat ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                            }),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            objectType,
                            "interactive-object",
                            { objectType },
                        ]);

                        cat.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = dialogues[locale]?.[objectType] || [
                                "Meow~",
                                "ì•¼ì˜¹~",
                            ];

                            const speakerName =
                                dialogues.names[locale]?.[objectType] ||
                                (objectType === "cat1" ? "Cat" : "Another Cat");

                            gameState.setInteractableObject(
                                cat,
                                "npc",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                        });

                        cat.onCollideEnd("player", () => {
                            gameState.clearInteractableObject();
                        });
                        
                        console.log(`ï¿½ ${objectType} ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:`, cat.pos);
                        continue;
                    }

                    // ball ì²˜ë¦¬ (spawnpoints ë ˆì´ì–´ì—ì„œ)
                    if (object.name === "ball") {
                        console.log("âš½ í”¼êµ¬ê³µ ê°ì§€ë¨! (spawnpoints ë ˆì´ì–´)");
                        
                        const ball = map.add([
                            k.sprite("front-assets", {
                                frame: 5296, // main.jsì— ì •ì˜ëœ ball ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                            }),
                            k.area({
                                shape: new k.Rect(k.vec2(0), 24, 24),
                            }),
                            k.body({
                                isStatic: true,
                                mass: 1,
                                restitution: 0.6,
                            }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            "ball",
                            "kickable",
                            {
                                objectType: "ball",
                                lastKickTime: 0,
                                isMoving: false,
                            },
                        ]);

                        ball.onCollideUpdate("player", (player) => {
                            if (!ball.isMoving) {
                                kickBallOnCollision(k, ball, player);
                            }
                        });
                        
                        console.log("âš½ í”¼êµ¬ê³µ ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:", ball.pos);
                        continue;
                    }

                    // nca ì²˜ë¦¬ (spawnpoints ë ˆì´ì–´ì—ì„œ)
                    if (object.name === "nca") {
                        console.log("ğŸ“„ NCA ì „ë‹¨ì§€ ê°ì§€ë¨! (spawnpoints ë ˆì´ì–´)");
                        
                        const nca = map.add([
                            k.sprite("front-assets", {
                                frame: 5298, // main.jsì— ì •ì˜ëœ nca ìŠ¤í”„ë¼ì´íŠ¸ ì¸ë±ìŠ¤
                            }),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            "nca",
                            "interactive-object",
                            { objectType: "nca" },
                        ]);

                        nca.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = objectDialogues[locale]?.["nca"] || [
                                "NCA recruitment flyer.",
                                "NCA ëª¨ì§‘ ì „ë‹¨ì§€ì…ë‹ˆë‹¤.",
                            ];

                            const speakerName =
                                objectDialogues.names[locale]?.["nca"] ||
                                "NCA Flyer";

                            gameState.setInteractableObject(
                                nca,
                                "object",
                                {
                                    content: content,
                                    speakerName: speakerName,
                                    speakerImage: null,
                                }
                            );
                        });

                        nca.onCollideEnd("player", () => {
                            gameState.clearInteractableObject();
                        });
                        
                        console.log("ï¿½ NCA ìŠ¤í”„ë¼ì´íŠ¸ ìƒì„±ë¨ at:", nca.pos);
                        continue;
                    }

                    // í¸ì§€ ì˜¤ë¸Œì íŠ¸ ì²˜ë¦¬
                    if (object.name.startsWith("letter")) {
                        const letterType = object.name;
                        const letter = map.add([
                            k.sprite("front-assets", {
                                anim: letterType,
                            }),
                            k.area(),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            "letter",
                            { letterType },
                        ]);

                        letter.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = objectDialogues[locale]?.[
                                letterType
                            ] || [
                                `This is ${letterType}`,
                                `ì´ê²ƒì€ ${letterType}ì…ë‹ˆë‹¤`,
                            ];

                            const speakerName =
                                objectDialogues.names[locale]?.[letterType] ||
                                letterType;

                            gameState.setInteractableObject(letter, "letter", {
                                content: content,
                                speakerName: speakerName,
                                speakerImage: null,
                            });
                        });

                        letter.onCollideEnd("player", (player) => {
                            gameState.clearInteractableObject();
                        });
                        continue;
                    }

                    // Student NPC ì²˜ë¦¬
                    if (object.name.startsWith("student")) {
                        const studentType = object.name;
                        const student = map.add([
                            k.sprite("front-assets", {
                                anim: studentType,
                            }),
                            k.area({
                                shape: new k.Rect(k.vec2(0, -10), 16, 24), // Y ì˜¤í”„ì…‹ -8ë¡œ ì½œë¼ì´ë”ë¥¼ ìœ„ë¡œ ì´ë™
                            }),
                            k.body({ isStatic: true }),
                            k.pos(object.x, object.y),
                            k.z(1),
                            "student",
                            { studentType },
                        ]);

                        student.onCollideUpdate("player", (player) => {
                            const locale = gameState.getLocale();
                            const content = dialogues[locale]?.[studentType] || [
                                `Hello! I'm ${studentType}.`,
                                `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ${studentType}ì…ë‹ˆë‹¤.`,
                            ];

                            const speakerName =
                                dialogues.names[locale]?.[studentType] ||
                                studentType;

                            gameState.setInteractableObject(student, "student", {
                                content: content,
                                speakerName: speakerName,
                                speakerImage: null,
                            });
                        });

                        student.onCollideEnd("player", (player) => {
                            gameState.clearInteractableObject();
                        });
                        continue;
                    }
                }
            } else {
                console.log("âš ï¸ Spawnpoints ë ˆì´ì–´ëŠ” ìˆì§€ë§Œ ì˜¤ë¸Œì íŠ¸ê°€ ì—†ìŒ");
            }
            continue;
        }

        // Handle regular tile layers with chunks system (infinite maps)
        if (layer.chunks) {
            console.log(`ğŸ§© Processing chunks for layer: ${layer.name}`, layer.chunks.length);
            // Infinite ë§µì˜ chunks ì²˜ë¦¬
            for (const chunk of layer.chunks) {
                console.log(`ğŸ“¦ Processing chunk at (${chunk.x}, ${chunk.y}) size: ${chunk.width}x${chunk.height}`);
                let tileIndex = 0;
                for (let y = 0; y < chunk.height; y++) {
                    for (let x = 0; x < chunk.width; x++) {
                        const tile = chunk.data[tileIndex];
                        tileIndex++;

                        if (tile === 0) continue;

                        // chunkì˜ ì ˆëŒ€ ìœ„ì¹˜ ê³„ì‚°
                        const tileX = (chunk.x + x) * mapData.tilewidth;
                        const tileY = (chunk.y + y) * mapData.tileheight;

                        // upmost ë ˆì´ì–´ëŠ” ìºë¦­í„°ë³´ë‹¤ ìœ„ì— ë°°ì¹˜ (z=3), ë‹¤ë¥¸ íƒ€ì¼ì€ ê¸°ë³¸ (z=0)
                        const zIndex = layer.name === "upmost" ? 3 : 0;

                        // front.jsonì€ rpg_spritesheet_front.pngë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ front-assets ìŠ¤í”„ë¼ì´íŠ¸ ì‚¬ìš©
                        map.add([
                            k.sprite("front-assets", { frame: tile - 1 }),
                            k.pos(tileX, tileY),
                            k.z(zIndex),
                            k.offscreen(),
                        ]);
                    }
                }
            }
            continue;
        }

        // Handle regular tile layers (non-infinite maps)
        if (layer.data) {
            let nbOfDrawnTiles = 0;
            const tilePos = k.vec2(0, 0);
            for (const tile of layer.data) {
                if (nbOfDrawnTiles % layer.width === 0) {
                    tilePos.x = 0;
                    tilePos.y += mapData.tileheight;
                } else {
                    tilePos.x += mapData.tilewidth;
                }

                nbOfDrawnTiles++;

                if (tile === 0) continue;

                // upmost ë ˆì´ì–´ëŠ” ìºë¦­í„°ë³´ë‹¤ ìœ„ì— ë°°ì¹˜ (z=3), ë‹¤ë¥¸ íƒ€ì¼ì€ ê¸°ë³¸ (z=0)
                const zIndex = layer.name === "upmost" ? 3 : 0;

                // front.jsonì€ rpg_spritesheet_front.pngë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ front-assets ìŠ¤í”„ë¼ì´íŠ¸ ì‚¬ìš©
                map.add([
                    k.sprite("front-assets", { frame: tile - 1 }),
                    k.pos(tilePos),
                    k.z(zIndex),
                    k.offscreen(),
                ]);
            }
            continue;
        }
    }

    // ëª¨ë“  ë ˆì´ì–´ ì²˜ë¦¬ í›„ í”Œë ˆì´ì–´ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê¸°ë³¸ ìœ„ì¹˜ì— ìƒì„±
    if (!entities.player) {
        console.log("ğŸ® í”Œë ˆì´ì–´ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ, ê¸°ë³¸ ìœ„ì¹˜ì— ìƒì„±");
        entities.player = map.add(
            generateFrontPlayerComponents(k, k.vec2(0, 0))
        );
    } else {
        console.log("ğŸ® í”Œë ˆì´ì–´ ìƒì„± ì™„ë£Œ:", entities.player.pos);
    }

    setPlayerControls(k, entities.player);

    // í”Œë ˆì´ì–´ ì¡´ì¬ í™•ì¸ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    if (entities.player && entities.player.exists()) {
        // front ì”¬ì—ì„œëŠ” main_entranceë¥¼ í†µí•´ schoolfrontë¡œ ì´ë™
        entities.player.onCollide("main_entrance", () => k.go("schoolfront"));
    }

    k.camScale(2); // ì¤Œì•„ì›ƒ: 3 â†’ 1.5ë¡œ ë³€ê²½

    // í”Œë ˆì´ì–´ ì¡´ì¬ í™•ì¸ í›„ ì¹´ë©”ë¼ ì„¤ì •
    if (entities.player && entities.player.exists()) {
        k.camPos(entities.player.worldPos());
    }

    k.onUpdate(async () => {
        // í”Œë ˆì´ì–´ ì¡´ì¬ í™•ì¸ í›„ ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸ (í”ë“¤ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ë¶€ë“œëŸ½ê²Œ ì¡°ì •)
        if (
            entities.player &&
            entities.player.exists() &&
            entities.player.pos.dist(k.camPos()) > 10 // ê±°ë¦¬ ì„ê³„ê°’ ì¦ê°€
        ) {
            // íŠ¸ìœˆ ëŒ€ì‹  lerpë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ë¶€ë“œëŸ¬ìš´ ì¹´ë©”ë¼ ì´ë™
            const targetPos = entities.player.worldPos();
            const currentPos = k.camPos();
            const lerpFactor = 0.05; // ë” ë¶€ë“œëŸ¬ìš´ ì´ë™ì„ ìœ„í•´ ê°’ ê°ì†Œ
            
            const newPos = k.vec2(
                k.lerp(currentPos.x, targetPos.x, lerpFactor),
                k.lerp(currentPos.y, targetPos.y, lerpFactor)
            );
            
            k.camPos(newPos);
        }
    });

    // UI ìš”ì†Œë“¤ ìˆ¨ê¹€ - front ì”¬ì—ì„œëŠ” UI ì—†ìŒ
    // healthBar(k);
    // watchPlayerHealth(k);

    let isLocaleLocked = { value: false };
    let isMuteLocked = { value: false };

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    k.onKeyPress("l", () => {
        toggleLocale(k, gameState, isLocaleLocked);
    });

    k.onKeyPress("ã…£", () => {
        toggleLocale(k, gameState, isLocaleLocked);
    });

    k.onKeyPress("m", () => {
        toggleMute(k, gameState, isMuteLocked);
    });

    k.onKeyPress("ã…¡", () => {
        toggleMute(k, gameState, isMuteLocked);
    });

    // ê²Œì„íŒ¨ë“œ ì»¨íŠ¸ë¡¤
    k.onGamepadButtonPress("lshoulder", () => {
        console.log("ğŸ® Lë²„íŠ¼ ëˆŒë¦¼ - ì–¸ì–´ ë³€ê²½");
        toggleLocale(k, gameState, isLocaleLocked);
    });

    k.onGamepadButtonPress("rshoulder", () => {
        console.log("ğŸ® Rë²„íŠ¼ ëˆŒë¦¼ - ìŒì†Œê±° í† ê¸€");
        toggleMute(k, gameState, isMuteLocked);
    });

    k.onGamepadButtonPress("ltrigger", () => {
        console.log("ğŸ® L2 íŠ¸ë¦¬ê±° ëˆŒë¦¼ - ì–¸ì–´ ë³€ê²½");
        toggleLocale(k, gameState, isLocaleLocked);
    });

    k.onGamepadButtonPress("rtrigger", () => {
        console.log("ğŸ® R2 íŠ¸ë¦¬ê±° ëˆŒë¦¼ - ìŒì†Œê±° í† ê¸€");
        toggleMute(k, gameState, isMuteLocked);
    });

    // 1ë²ˆ í‚¤ë¡œ ë©”ì¸ ë©”ë‰´ ì´ë™
    setupMainMenuShortcut(k, gameState);

    // í€˜ìŠ¤íŠ¸ UI ì¶”ê°€
    setupQuestUI(k, gameState);
    
    } catch (error) {
        console.error("âŒ Front ì”¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì§„í–‰
        if (!map) {
            map = k.add([k.pos(0, 0)]);
        }
        entities.player = map.add(
            generateFrontPlayerComponents(k, k.vec2(0, 0))
        );
        setPlayerControls(k, entities.player);
        k.camScale(1.5); // ì¤Œì•„ì›ƒ: 3 â†’ 1.5ë¡œ ë³€ê²½
        k.camPos(entities.player.worldPos());
    }
}
