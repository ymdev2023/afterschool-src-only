import menuText from "../../content/menuText.js";
import { gameState } from "../../state/stateManagers.js";
import { colorizeBackground } from "../../utils.js";
import { fadeInBGM } from "../utils.js ";

export default function mainMenu(k) {
    // ì´ë¯¸ ë©”ì¸ ë©”ë‰´ BGMì´ ìž¬ìƒ ì¤‘ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì‹œìž‘
    if (!gameState.isMainMenuBGMPlaying) {
        fadeInBGM(k, "rpg-main-bgm"); // ìˆ˜ì •ëœ ë¶€ë¶„: main-bgm â†’ rpg-main-bgm
        gameState.isMainMenuBGMPlaying = true;
    }

    const currentLocale = gameState.getLocale() ?? "korean";
    gameState.setLocale(currentLocale);

    const currentFont = currentLocale === "korean" ? "neodgm" : "gameboy";
    const oppositeLocale = currentLocale === "korean" ? "english" : "korean";

    const isKorean = currentLocale === "korean";

    colorizeBackground(k, 255, 192, 203);

    k.add([
        k.text(menuText[currentLocale].title, {
            size: 50,
            font: "gameboy",
            ...(isKorean ? { outline: { width: 2, color: k.BLACK } } : {}),
        }),
        k.anchor("center"),
        k.pos(k.center().x, k.center().y - 140),
    ]);

    const menuLabels = menuText[currentLocale].menu;

    const menuItems = [
        {
            label: menuLabels[0],
            action: () => {
                gameState.isMainMenuBGMPlaying = false; // BGM ìƒíƒœ ë¦¬ì…‹
                k.go("prologue");
            },
        },
        {
            label: menuLabels[1],
            action: () => {
                gameState.setLocale(oppositeLocale);
                k.go("mainMenu");
            },
        },
        {
            label: menuLabels[2],
            action: () => {
                k.go("tutorial");
            },
        },
        { label: menuLabels[3], action: () => k.go("credits") },
    ];

    let selectedIndex = 0;
    const menuTextObjs = [];
    const startY = k.center().y - 10;

    // âœ… letterSpacingê³¼ bold ì¶”ê°€ (í•œê¸€ì¸ ê²½ìš°ë§Œ)
    const textOptions = {
        size: 42,
        font: currentFont,
        ...(isKorean
            ? { letterSpacing: 15, outline: { width: 2, color: k.BLACK } }
            : {}),
    };

    menuItems.forEach((item, index) => {
        const label = k.add([
            k.text(item.label, textOptions),
            k.anchor("left"),
            k.pos(k.center().x - 220, startY + index * 60),
        ]);
        menuTextObjs.push(label);
    });

    const cursor = k.add([
        k.text("â–¶", {
            size: 32,
            font: currentFont,
            ...(isKorean ? { outline: { width: 2, color: k.BLACK } } : {}),
        }),
        k.anchor("left"),
        k.pos(k.center().x - 260, startY + selectedIndex * 60),
    ]);

    function updateCursor() {
        cursor.pos.y = startY + selectedIndex * 60;
    }

    k.wait(0, updateCursor);

    k.onKeyPress("down", () => {
        k.play("confirm-beep-sfx");
        selectedIndex = (selectedIndex + 1) % menuItems.length;
        updateCursor();
    });

    k.onKeyPress("up", () => {
        k.play("confirm-beep-sfx");
        selectedIndex =
            (selectedIndex - 1 + menuItems.length) % menuItems.length;
        updateCursor();
    });

    k.onKeyPress("space", () => {
        k.play("boop-sfx");
        menuItems[selectedIndex].action();
    });

    // ê²Œìž„íŒ¨ë“œ DíŒ¨ë“œ ìœ„/ì•„ëž˜ë¡œ ë©”ë‰´ ì´ë™
    k.onGamepadButtonPress("dpad-up", () => {
        console.log("ðŸ•¹ï¸ ë©”ë‰´ - DíŒ¨ë“œ ìœ„ìª½ ëˆŒë¦¼");
        k.play("confirm-beep-sfx");
        selectedIndex =
            (selectedIndex - 1 + menuItems.length) % menuItems.length;
        updateCursor();
    });

    k.onGamepadButtonPress("dpad-down", () => {
        console.log("ðŸ•¹ï¸ ë©”ë‰´ - DíŒ¨ë“œ ì•„ëž˜ìª½ ëˆŒë¦¼");
        k.play("confirm-beep-sfx");
        selectedIndex = (selectedIndex + 1) % menuItems.length;
        updateCursor();
    });

    // ê²Œìž„íŒ¨ë“œ ABXY ë²„íŠ¼ìœ¼ë¡œ ë©”ë‰´ ì„ íƒ - ìˆ˜ì •ëœ ë¶€ë¶„: A/B ë§¤í•‘ ë³€ê²½
    k.onGamepadButtonPress("east", () => {
        // Aë²„íŠ¼ - í™•ì¸
        console.log("ðŸ…°ï¸ ë©”ë‰´ - Aë²„íŠ¼ ëˆŒë¦¼");
        k.play("boop-sfx");
        menuItems[selectedIndex].action();
    });

    k.onGamepadButtonPress("south", () => {
        // Bë²„íŠ¼ - ì·¨ì†Œ (ë©”ë‰´ì—ì„œëŠ” í™•ì¸ê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
        console.log("ðŸ…±ï¸ ë©”ë‰´ - Bë²„íŠ¼ ëˆŒë¦¼");
        k.play("boop-sfx");
        menuItems[selectedIndex].action();
    });

    k.onGamepadButtonPress("west", () => {
        // Xë²„íŠ¼
        console.log("âŒ ë©”ë‰´ - Xë²„íŠ¼ ëˆŒë¦¼");
        k.play("boop-sfx");
        menuItems[selectedIndex].action();
    });

    k.onGamepadButtonPress("north", () => {
        // Yë²„íŠ¼
        console.log("ðŸ”º ë©”ë‰´ - Yë²„íŠ¼ ëˆŒë¦¼");
        k.play("boop-sfx");
        menuItems[selectedIndex].action();
    });

    // âœ… M í‚¤ë¡œ ë°°ê²½ìŒ ìŒì†Œê±°
    k.onKeyPress("m", () => {
        if (gameState.bgmHandle) {
            gameState.bgmHandle.paused = !gameState.bgmHandle.paused;
        }
    });

    // ìˆ˜ì •ëœ ë¶€ë¶„: í•œê¸€ ìžíŒ 'ã…¡' (mí‚¤)ë„ ìŒì†Œê±° í† ê¸€
    k.onKeyPress("ã…¡", () => {
        if (gameState.bgmHandle) {
            gameState.bgmHandle.paused = !gameState.bgmHandle.paused;
        }
    });
}
