using UnityEngine;
using System.Collections.Generic;

public class SoundManager : MonoBehaviour
{
    public static SoundManager Instance;

    [Header("Audio Sources")]
    public AudioSource bgmSource;
    public AudioSource sfxSource;

    [Header("BGM Clips")]
    public AudioClip selectBGM;  // select-bgm
    public AudioClip introBGM;   // intro-bgm
    public AudioClip mainBGM;    // main-bgm

    [Header("SFX Clips")]
    public AudioClip boopSFX;        // boop-sfx
    public AudioClip bubbleSFX;      // bubble-sfx 
    public AudioClip coinSFX;        // coin-sfx
    public AudioClip confirmBeepSFX; // confirmbeep-sfx
    public AudioClip talkSFX;        // talk-sfx
    public AudioClip textSFX;        // text-sfx
    public AudioClip bookSFX;        // book-sfx (Ïï®Î≤î ÌéòÏù¥ÏßÄ ÎÑòÍ∏∞Í∏∞)

    [Header("Volume Settings")]
    [Range(0f, 1f)]
    public float bgmVolume = 0.7f;
    [Range(0f, 1f)]
    public float sfxVolume = 1f;

    [Header("Auto Play Settings")]
    public bool playBGMOnStart = true;
    public string currentSceneName = "";

    void Awake()
    {
        // Singleton pattern
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
            InitializeAudioSources();

            // Subscribe to scene change events for automatic BGM switching
            UnityEngine.SceneManagement.SceneManager.sceneLoaded += OnSceneLoaded;
        }
        else
        {
            Destroy(gameObject);
        }
    }

    void OnDestroy()
    {
        // Unsubscribe from scene change events
        if (Instance == this)
        {
            UnityEngine.SceneManagement.SceneManager.sceneLoaded -= OnSceneLoaded;
        }
    }

    // Automatically called when a new scene is loaded
    void OnSceneLoaded(UnityEngine.SceneManagement.Scene scene, UnityEngine.SceneManagement.LoadSceneMode mode)
    {
        Debug.Log($"üéµ SoundManager: Scene loaded '{scene.name}', switching BGM...");
        currentSceneName = scene.name;

        // Wait a bit for everything to be ready, then play appropriate BGM
        StartCoroutine(PlaySceneBGMDelayed());
    }

    System.Collections.IEnumerator PlaySceneBGMDelayed()
    {
        yield return new WaitForSeconds(0.1f); // Wait a bit longer for stability
        Debug.Log("üéµ Playing scene BGM after delay...");
        PlaySceneBGM();
    }

    void Start()
    {
        Debug.Log("üéµ SoundManager Start() called");

        // Ensure audio sources are properly set up
        InitializeAudioSources();

        // Load saved volume settings
        LoadVolumeSettings();

        // Check if BGM clips are assigned
        CheckBGMClips();

        // Check if SFX clips are assigned
        CheckSFXClips();

        // Get current scene name
        currentSceneName = UnityEngine.SceneManagement.SceneManager.GetActiveScene().name;
        Debug.Log($"üéµ Current scene on Start: {currentSceneName}");

        if (playBGMOnStart)
        {
            Debug.Log("üéµ Auto-playing BGM on start...");
            StartCoroutine(PlayBGMOnStartDelayed());
        }
    }

    System.Collections.IEnumerator PlayBGMOnStartDelayed()
    {
        yield return new WaitForSeconds(0.2f); // Wait a bit for everything to be ready
        PlaySceneBGM();
    }

    void CheckBGMClips()
    {
        Debug.Log("üéµ Checking BGM clips assignment:");
        Debug.Log($"   - selectBGM: {(selectBGM != null ? selectBGM.name : "NULL")}");
        Debug.Log($"   - introBGM: {(introBGM != null ? introBGM.name : "NULL")}");
        Debug.Log($"   - mainBGM: {(mainBGM != null ? mainBGM.name : "NULL")}");

        if (selectBGM == null || introBGM == null || mainBGM == null)
        {
            Debug.LogWarning("‚ö†Ô∏è Some BGM clips are not assigned in the Inspector!");
        }
    }

    void CheckSFXClips()
    {
        Debug.Log("üîä Checking SFX clips assignment:");
        Debug.Log($"   - boopSFX: {(boopSFX != null ? boopSFX.name : "NULL")}");
        Debug.Log($"   - bubbleSFX: {(bubbleSFX != null ? bubbleSFX.name : "NULL")}");
        Debug.Log($"   - coinSFX: {(coinSFX != null ? coinSFX.name : "NULL")}");
        Debug.Log($"   - confirmBeepSFX: {(confirmBeepSFX != null ? confirmBeepSFX.name : "NULL")}");
        Debug.Log($"   - talkSFX: {(talkSFX != null ? talkSFX.name : "NULL")}");
        Debug.Log($"   - textSFX: {(textSFX != null ? textSFX.name : "NULL")}");
        Debug.Log($"   - bookSFX: {(bookSFX != null ? bookSFX.name : "NULL")}");

        if (boopSFX == null || bubbleSFX == null || coinSFX == null ||
            confirmBeepSFX == null || talkSFX == null || textSFX == null || bookSFX == null)
        {
            Debug.LogWarning("‚ö†Ô∏è Some SFX clips are not assigned in the Inspector!");
        }
    }

    void InitializeAudioSources()
    {
        // Create BGM AudioSource if not assigned
        if (bgmSource == null)
        {
            GameObject bgmObj = new GameObject("BGM Source");
            bgmObj.transform.SetParent(transform);
            bgmSource = bgmObj.AddComponent<AudioSource>();
        }

        // Create SFX AudioSource if not assigned
        if (sfxSource == null)
        {
            GameObject sfxObj = new GameObject("SFX Source");
            sfxObj.transform.SetParent(transform);
            sfxSource = sfxObj.AddComponent<AudioSource>();
        }

        // Configure BGM source
        bgmSource.loop = true;
        bgmSource.volume = bgmVolume;
        bgmSource.playOnAwake = false;

        // Configure SFX source
        sfxSource.loop = false;
        sfxSource.volume = sfxVolume;
        sfxSource.playOnAwake = false;
    }

    void Update()
    {
        // Update volume in real-time
        if (bgmSource != null)
            bgmSource.volume = bgmVolume;
        if (sfxSource != null)
            sfxSource.volume = sfxVolume;
    }

    public void PlaySceneBGM()
    {
        string sceneName = UnityEngine.SceneManagement.SceneManager.GetActiveScene().name;
        currentSceneName = sceneName;

        AudioClip bgmToPlay = null;

        Debug.Log($"üéµ PlaySceneBGM called for scene: '{sceneName}'");

        // Check if AudioSources are ready
        if (bgmSource == null)
        {
            Debug.LogError("‚ùå BGM AudioSource is null! Re-initializing...");
            InitializeAudioSources();
        }

        // Determine which BGM to play based on exact scene names
        switch (sceneName)
        {
            case "1IntroScene":
                bgmToPlay = introBGM;
                Debug.Log("‚úÖ Selected intro BGM for 1IntroScene");
                break;
            case "2SelectScene":
                bgmToPlay = selectBGM;
                Debug.Log("‚úÖ Selected character selection BGM for 2SelectScene");
                break;
            case "3MainScene":
                bgmToPlay = mainBGM;
                Debug.Log("‚úÖ Selected main game BGM for 3MainScene");
                break;
            default:
                // Fallback: check if scene name contains keywords
                if (sceneName.Contains("Intro"))
                {
                    bgmToPlay = introBGM;
                    Debug.Log($"‚úÖ Fallback: Selected intro BGM for scene containing 'Intro': {sceneName}");
                }
                else if (sceneName.Contains("Select") || sceneName.Contains("Character"))
                {
                    bgmToPlay = selectBGM;
                    Debug.Log($"‚úÖ Fallback: Selected selection BGM for scene containing 'Select': {sceneName}");
                }
                else if (sceneName.Contains("Main") || sceneName.Contains("Game"))
                {
                    bgmToPlay = mainBGM;
                    Debug.Log($"‚úÖ Fallback: Selected main BGM for scene containing 'Main': {sceneName}");
                }
                else
                {
                    Debug.LogWarning($"‚ö†Ô∏è No BGM mapping found for scene: '{sceneName}' - trying selectBGM as default");
                    bgmToPlay = selectBGM; // Default fallback
                }
                break;
        }

        if (bgmToPlay != null)
        {
            Debug.Log($"üéµ Attempting to play BGM: {bgmToPlay.name}");
            PlayBGM(bgmToPlay);
        }
        else
        {
            Debug.LogError($"‚ùå No BGM clip assigned for scene '{sceneName}' - check Inspector assignments!");
            CheckBGMClips(); // Show current assignments
        }
    }

    public void PlayBGM(AudioClip clip)
    {
        if (bgmSource == null)
        {
            Debug.LogError("‚ùå BGM AudioSource is null! Re-initializing...");
            InitializeAudioSources();
            if (bgmSource == null)
            {
                Debug.LogError("‚ùå Failed to initialize BGM AudioSource!");
                return;
            }
        }

        if (clip == null)
        {
            Debug.LogError("‚ùå BGM AudioClip is null!");
            return;
        }

        // Stop current BGM first
        if (bgmSource.isPlaying)
        {
            Debug.Log($"üõë Stopping current BGM: {(bgmSource.clip != null ? bgmSource.clip.name : "Unknown")}");
            bgmSource.Stop();
        }

        // Set new clip and play
        bgmSource.clip = clip;
        bgmSource.volume = bgmVolume;
        bgmSource.loop = true;
        bgmSource.Play();

        Debug.Log($"‚úÖ Successfully started playing BGM: {clip.name} (Volume: {bgmVolume})");

        // Verify playback started
        StartCoroutine(VerifyBGMPlayback(clip.name));
    }

    System.Collections.IEnumerator VerifyBGMPlayback(string clipName)
    {
        yield return new WaitForSeconds(0.1f);

        if (bgmSource != null && bgmSource.isPlaying)
        {
            Debug.Log($"‚úÖ BGM playback verified: {clipName} is playing");
        }
        else
        {
            Debug.LogError($"‚ùå BGM playback failed: {clipName} is not playing!");
            Debug.LogError($"   - AudioSource exists: {bgmSource != null}");
            if (bgmSource != null)
            {
                Debug.LogError($"   - Clip assigned: {bgmSource.clip != null}");
                Debug.LogError($"   - Volume: {bgmSource.volume}");
                Debug.LogError($"   - Muted: {bgmSource.mute}");
                Debug.LogError($"   - Enabled: {bgmSource.enabled}");
            }
        }
    }

    public void StopBGM()
    {
        if (bgmSource == null) return;
        bgmSource.Stop();
    }

    public void PlaySFX(AudioClip clip)
    {
        if (sfxSource == null)
        {
            Debug.LogError("‚ùå SFX AudioSource is null!");
            return;
        }

        if (clip == null)
        {
            Debug.LogError("‚ùå SFX AudioClip is null!");
            return;
        }

        Debug.Log($"üîä Playing SFX: {clip.name}");
        sfxSource.PlayOneShot(clip);
    }

    // Volume control methods
    public void SetBGMVolume(float volume)
    {
        bgmVolume = Mathf.Clamp01(volume);
        if (bgmSource != null)
            bgmSource.volume = bgmVolume;

        // Save to PlayerPrefs
        PlayerPrefs.SetFloat("BGMVolume", bgmVolume);
        PlayerPrefs.Save();
    }

    public void SetSFXVolume(float volume)
    {
        sfxVolume = Mathf.Clamp01(volume);
        if (sfxSource != null)
            sfxSource.volume = sfxVolume;

        // Save to PlayerPrefs
        PlayerPrefs.SetFloat("SFXVolume", sfxVolume);
        PlayerPrefs.Save();
    }

    public void LoadVolumeSettings()
    {
        bgmVolume = PlayerPrefs.GetFloat("BGMVolume", 0.7f);
        sfxVolume = PlayerPrefs.GetFloat("SFXVolume", 1f);

        if (bgmSource != null)
            bgmSource.volume = bgmVolume;
        if (sfxSource != null)
            sfxSource.volume = sfxVolume;
    }

    // Mute/Unmute methods
    public void MuteBGM(bool mute)
    {
        if (bgmSource != null)
            bgmSource.mute = mute;
    }

    public void MuteSFX(bool mute)
    {
        if (sfxSource != null)
            sfxSource.mute = mute;
    }

    public void MuteAll(bool mute)
    {
        MuteBGM(mute);
        MuteSFX(mute);
    }

    // Scene transition method
    public void OnSceneChanged()
    {
        PlaySceneBGM();
    }

    #region Inspector Assignable SFX Methods (Unity OnClick Events)

    /// <summary>
    /// InspectorÏóêÏÑú Î≤ÑÌäº OnClickÏóê ÏßÅÏ†ë Ìï†ÎãπÌï† Ïàò ÏûàÎäî Ìö®Í≥ºÏùå Î©îÏÑúÎìúÎì§
    /// ÌååÏùºÎ™Ö Í∏∞Î∞òÏúºÎ°ú Î™ÖÎ™ÖÎêú Î©îÏÑúÎìúÎì§
    /// </summary>

    // ÌååÏùºÎ™Ö Í∏∞Î∞ò Ìö®Í≥ºÏùå Î©îÏÑúÎìúÎì§ (boop-sfx, bubble-sfx, coin-sfx, confirmbeep-sfx, talk-sfx, text-sfx)
    public void PlayBoopSFX()
    {
        Debug.Log("üîä PlayBoopSFX() called");
        if (boopSFX != null)
            PlaySFX(boopSFX);
        else
            Debug.LogWarning("‚ö†Ô∏è boopSFX AudioClipÏù¥ InspectorÏóêÏÑú Ìï†ÎãπÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!");
    }

    public void PlayBubbleSFX()
    {
        Debug.Log("üîä PlayBubbleSFX() called");
        if (bubbleSFX != null)
            PlaySFX(bubbleSFX);
        else
            Debug.LogWarning("‚ö†Ô∏è bubbleSFX AudioClipÏù¥ InspectorÏóêÏÑú Ìï†ÎãπÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!");
    }

    public void PlayCoinSFX()
    {
        Debug.Log("üîä PlayCoinSFX() called");
        if (coinSFX != null)
            PlaySFX(coinSFX);
        else
            Debug.LogWarning("‚ö†Ô∏è coinSFX AudioClipÏù¥ InspectorÏóêÏÑú Ìï†ÎãπÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!");
    }

    public void PlayConfirmBeepSFX()
    {
        Debug.Log("üîä PlayConfirmBeepSFX() called");
        if (confirmBeepSFX != null)
            PlaySFX(confirmBeepSFX);
        else
            Debug.LogWarning("‚ö†Ô∏è confirmBeepSFX AudioClipÏù¥ InspectorÏóêÏÑú Ìï†ÎãπÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!");
    }

    public void PlayTalkSFX()
    {
        Debug.Log("üîä PlayTalkSFX() called");
        if (talkSFX != null)
            PlaySFX(talkSFX);
        else
            Debug.LogWarning("‚ö†Ô∏è talkSFX AudioClipÏù¥ InspectorÏóêÏÑú Ìï†ÎãπÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!");
    }

    public void PlayTextSFX()
    {
        Debug.Log("üîä PlayTextSFX() called");
        if (textSFX != null)
            PlaySFX(textSFX);
        else
            Debug.LogWarning("‚ö†Ô∏è textSFX AudioClipÏù¥ InspectorÏóêÏÑú Ìï†ÎãπÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!");
    }

    public void PlayBookSFX()
    {
        Debug.Log("üîä PlayBookSFX() called - Ïï®Î≤î ÌéòÏù¥ÏßÄ ÎÑòÍ∏∞Í∏∞");
        if (bookSFX != null)
        {
            PlaySFX(bookSFX);
        }
        else
        {
            // InspectorÏóêÏÑú Ìï†ÎãπÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ ResourcesÏóêÏÑú ÏûêÎèô Î°úÎìú ÏãúÎèÑ
            AudioClip autoLoadedClip = Resources.Load<AudioClip>("Audio/book-sfx");
            if (autoLoadedClip != null)
            {
                bookSFX = autoLoadedClip; // Ï∫êÏãúÌï¥ÏÑú Îã§ÏùåÏóêÎäî Î∞îÎ°ú ÏÇ¨Ïö©
                PlaySFX(bookSFX);
                Debug.Log("üìñ bookSFXÎ•º ResourcesÏóêÏÑú ÏûêÎèô Î°úÎìúÌñàÏäµÎãàÎã§.");
            }
            else
            {
                Debug.LogWarning("‚ö†Ô∏è bookSFX AudioClipÏùÑ InspectorÎÇò Resources/Audio/book-sfxÏóêÏÑú Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!");
            }
        }
    }

    // BGM Ï†úÏñ¥ (Inspector Ìï†ÎãπÏö©) - ÌååÏùºÎ™Ö Í∏∞Î∞ò
    public void PlaySelectBGM() => PlayBGM(selectBGM);
    public void PlayIntroBGM() => PlayBGM(introBGM);
    public void PlayMainBGM() => PlayBGM(mainBGM);
    public void StopAllBGM() => StopBGM();

    // Î≥ºÎ•® Ï†úÏñ¥ (Slider Îì±ÏóêÏÑú ÏÇ¨Ïö©)
    public void SetBGMVolumeFromSlider(float volume) => SetBGMVolume(volume);
    public void SetSFXVolumeFromSlider(float volume) => SetSFXVolume(volume);

    // ÏùåÏÜåÍ±∞ Ï†úÏñ¥ (ToggleÏóêÏÑú ÏÇ¨Ïö©)
    public void ToggleBGMMute(bool mute) => MuteBGM(mute);
    public void ToggleSFXMute(bool mute) => MuteSFX(mute);
    public void ToggleAllMute(bool mute) => MuteAll(mute);

    #endregion

    /// <summary>
    /// ÏàòÎèôÏúºÎ°ú BGM Ïû¨ÏÉù ÌÖåÏä§Ìä∏ (InspectorÎÇò Îã§Î•∏ Ïä§ÌÅ¨Î¶ΩÌä∏ÏóêÏÑú Ìò∏Ï∂ú Í∞ÄÎä•)
    /// </summary>
    public void TestPlaySceneBGM()
    {
        Debug.Log("üéµ Manual BGM test triggered");
        PlaySceneBGM();
    }

    /// <summary>
    /// Í∞ïÏ†úÎ°ú BGM Ïû¨ÏãúÏûë (Î¨∏Ï†ú Ìï¥Í≤∞Ïö©)
    /// </summary>
    public void ForceRestartBGM()
    {
        Debug.Log("üéµ Force restarting BGM...");

        if (bgmSource != null && bgmSource.isPlaying)
        {
            bgmSource.Stop();
        }

        // Re-initialize audio sources
        InitializeAudioSources();

        // Wait a bit then play BGM
        StartCoroutine(ForceRestartBGMDelayed());
    }

    System.Collections.IEnumerator ForceRestartBGMDelayed()
    {
        yield return new WaitForSeconds(0.1f);
        PlaySceneBGM();
    }

    /// <summary>
    /// ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ BGM Ï†ïÎ≥¥ Ï∂úÎ†• (ÎîîÎ≤ÑÍπÖÏö©)
    /// </summary>
    public void LogCurrentBGMStatus()
    {
        Debug.Log("üéµ Current BGM Status:");
        Debug.Log($"   - Scene: {currentSceneName}");
        Debug.Log($"   - BGM Source exists: {bgmSource != null}");

        if (bgmSource != null)
        {
            Debug.Log($"   - Is playing: {bgmSource.isPlaying}");
            Debug.Log($"   - Current clip: {(bgmSource.clip != null ? bgmSource.clip.name : "None")}");
            Debug.Log($"   - Volume: {bgmSource.volume}");
            Debug.Log($"   - Muted: {bgmSource.mute}");
            Debug.Log($"   - Time: {bgmSource.time}/{(bgmSource.clip != null ? bgmSource.clip.length : 0)}");
        }

        CheckBGMClips();
    }

    /// <summary>
    /// Ï†ÑÏ≤¥ ÏÇ¨Ïö¥Îìú ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌôïÏù∏ (ÎîîÎ≤ÑÍπÖÏö©)
    /// </summary>
    public void LogAllSoundStatus()
    {
        Debug.Log("üéµüîä === SOUND SYSTEM STATUS ===");
        LogCurrentBGMStatus();
        CheckSFXClips();

        Debug.Log("üîä Audio Sources Status:");
        Debug.Log($"   - BGM Source: {(bgmSource != null ? "OK" : "NULL")}");
        Debug.Log($"   - SFX Source: {(sfxSource != null ? "OK" : "NULL")}");

        if (sfxSource != null)
        {
            Debug.Log($"   - SFX Volume: {sfxSource.volume}");
            Debug.Log($"   - SFX Muted: {sfxSource.mute}");
            Debug.Log($"   - SFX Enabled: {sfxSource.enabled}");
        }
    }
}
